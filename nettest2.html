<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网易云音乐API测试</title>
    <meta name="referrer" content="no-referrer">
    <style>
        /* CSS样式已移除，页面为纯HTML结构 */
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-music"></i> 网易云音乐API测试</h1>
            <p>测试音乐URL获取、搜索、音质选择等功能</p>
        </div>
        
        <!-- 音乐URL获取测试 -->
        <div class="card">
            <h2><i class="fas fa-link"></i> 音乐URL获取测试</h2>
            
            <div class="input-group">
                <label for="songIds">音乐ID (多个用逗号隔开):</label>
                <input type="text" id="songIds" placeholder="例如: 1969519579,33894312">
            </div>
            
            <div class="input-group">
                <label>音质等级:</label>
                <select id="qualityLevel">
                    <option value="standard">标准 (standard)</option>
                    <option value="higher">较高 (higher)</option>
                    <option value="exhigh" selected>极高 (exhigh)</option>
                    <option value="lossless">无损 (lossless)</option>
                    <option value="hires">Hi-Res (hires)</option>
                    <option value="jyeffect">高清环绕声 (jyeffect)</option>
                    <option value="sky">沉浸环绕声 (sky)</option>
                    <option value="dolby">杜比全景声 (dolby)</option>
                    <option value="jymaster">超清母带 (jymaster)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>URL版本:</label>
                <div>
                    <input type="radio" id="urlVersionOld" name="urlVersion" value="old" checked>
                    <label for="urlVersionOld">旧版 (/song/url)</label>
                    <input type="radio" id="urlVersionNew" name="urlVersion" value="new">
                    <label for="urlVersionNew">新版 (/song/url/v1)</label>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn-primary" onclick="getSongUrl()" id="getUrlBtn">
                    <i class="fas fa-download"></i> 获取音乐URL
                </button>
                <button class="btn-secondary" onclick="checkMusicAvailable()" id="checkMusicBtn">
                    <i class="fas fa-check-circle"></i> 检查音乐可用性
                </button>
                <button class="btn-success" onclick="getUnblockedUrl()" id="unblockBtn">
                    <i class="fas fa-unlock"></i> 获取灰色歌曲链接
                </button>
            </div>
            
            <div id="songUrlResult" class="result" style="display: none;">
                <h3><i class="fas fa-music"></i> 音乐URL结果</h3>
                <div id="songUrlData"></div>
            </div>
        </div>
        
        <!-- 搜索测试 -->
        <div class="card">
            <h2><i class="fas fa-search"></i> 搜索测试</h2>
            
            <div class="input-group">
                <label for="keywords">搜索关键词:</label>
                <input type="text" id="keywords" placeholder="例如: 周杰伦 搁浅" value="周杰伦">
            </div>
            
            <div class="input-group">
                <label for="searchType">搜索类型:</label>
                <select id="searchType">
                    <option value="1" selected>单曲</option>
                    <option value="10">专辑</option>
                    <option value="100">歌手</option>
                    <option value="1000">歌单</option>
                    <option value="1002">用户</option>
                    <option value="1004">MV</option>
                    <option value="1006">歌词</option>
                    <option value="1009">电台</option>
                    <option value="1014">视频</option>
                    <option value="1018">综合</option>
                    <option value="2000">声音</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="searchLimit">返回数量:</label>
                <input type="number" id="searchLimit" value="10" min="1" max="100">
            </div>
            
            <div class="button-group">
                <button class="btn-primary" onclick="searchMusic()" id="searchBtn">
                    <i class="fas fa-search"></i> 搜索音乐
                </button>
            </div>
            
            <div id="searchResult" class="result" style="display: none; margin-top: 20px;">
                <h3><i class="fas fa-search"></i> 搜索结果</h3>
                <div id="searchData"></div>
            </div>
            
            <div id="searchDetails" style="display: none; margin-top: 20px;">
                <h3><i class="fas fa-list"></i> 搜索结果列表</h3>
                <div id="searchList"></div>
            </div>
        </div>
        
        <!-- 音乐播放测试 -->
        <div class="card">
            <h2><i class="fas fa-play-circle"></i> 音乐播放测试</h2>
            
            <div class="input-group">
                <label for="playSongId">播放音乐ID:</label>
                <input type="text" id="playSongId" placeholder="输入音乐ID进行播放">
            </div>
            
            <div class="button-group">
                <button class="btn-success" onclick="playSelectedSong()" id="playBtn">
                    <i class="fas fa-play"></i> 播放音乐
                </button>
                <button class="btn-secondary" onclick="stopAudio()" id="stopBtn">
                    <i class="fas fa-stop"></i> 停止播放
                </button>
            </div>
            
            <div id="audioPlayerContainer" style="display: none; margin-top: 20px;">
                <h4>正在播放:</h4>
                <div id="nowPlaying"></div>
                <audio id="audioPlayer" controls style="width: 100%; margin-top: 10px;"></audio>
                <div id="audioInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
            </div>
        </div>
        
        <!-- API信息 -->
        <div class="card">
            <h2><i class="fas fa-info-circle"></i> 接口说明</h2>
            <div style="line-height: 1.8;">
                <p><strong>API地址:</strong> <code>https://neteaseapi-enhanced.vercel.app</code></p>
                <p><strong>音乐URL获取:</strong> /song/url (旧版) 或 /song/url/v1 (新版)</p>
                <p><strong>音乐可用性检查:</strong> /check/music</p>
                <p><strong>灰色歌曲解锁:</strong> /song/url/match</p>
                <p><strong>搜索功能:</strong> /search 或 /cloudsearch</p>
                <p><strong>注意:</strong> 所有接口调用请加上时间戳参数</p>
            </div>
        </div>
    </div>

    <script>
        // API基础地址
        const API_BASE = 'https://neteaseapi-enhanced.vercel.app';
        let currentAudio = null;
        let searchResults = [];

        // 生成时间戳
        function getTimestamp() {
            return Date.now();
        }

        // 显示结果
        function showResult(containerId, content) {
            const container = document.getElementById(containerId);
            if (typeof content === 'string') {
                container.innerHTML = content;
            } else {
                container.innerHTML = `<pre>${JSON.stringify(content, null, 2)}</pre>`;
            }
            container.parentElement.style.display = 'block';
        }

        // 显示状态消息
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.style.padding = '10px';
            messageDiv.style.margin = '10px 0';
            messageDiv.style.borderRadius = '5px';
            
            switch(type) {
                case 'success':
                    messageDiv.style.backgroundColor = '#d4edda';
                    messageDiv.style.color = '#155724';
                    messageDiv.style.border = '1px solid #c3e6cb';
                    messageDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                    break;
                case 'error':
                    messageDiv.style.backgroundColor = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    messageDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                    break;
                case 'info':
                    messageDiv.style.backgroundColor = '#d1ecf1';
                    messageDiv.style.color = '#0c5460';
                    messageDiv.style.border = '1px solid #bee5eb';
                    messageDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
                    break;
            }
            
            return messageDiv;
        }

        // 获取音乐URL
        async function getSongUrl() {
            const songIds = document.getElementById('songIds').value.trim();
            const urlVersion = document.querySelector('input[name="urlVersion"]:checked').value;
            const qualityLevel = document.getElementById('qualityLevel').value;
            const getUrlBtn = document.getElementById('getUrlBtn');
            
            if (!songIds) {
                alert('请输入音乐ID');
                return;
            }
            
            getUrlBtn.disabled = true;
            getUrlBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 获取中...';
            
            try {
                let url = '';
                
                if (urlVersion === 'old') {
                    // 旧版API
                    url = `${API_BASE}/song/url?id=${songIds}&timestamp=${getTimestamp()}`;
                } else {
                    // 新版API
                    url = `${API_BASE}/song/url/v1?id=${songIds}&level=${qualityLevel}&timestamp=${getTimestamp()}`;
                }
                
                // 如果有Cookie，添加到请求中
                const savedCookie = localStorage.getItem('netease_cookie');
                if (savedCookie) {
                    url += `&cookie=${encodeURIComponent(savedCookie)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                let resultHtml = '';
                
                if (data.code === 200 && data.data) {
                    const songs = Array.isArray(data.data) ? data.data : [data.data];
                    
                    resultHtml += '<div class="song-list">';
                    songs.forEach(song => {
                        resultHtml += `
                            <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <strong>歌曲ID:</strong> ${song.id}<br>
                                <strong>歌曲名称:</strong> ${song.name || '未知'}<br>
                                <strong>艺术家:</strong> ${song.ar ? song.ar.map(artist => artist.name).join(', ') : '未知'}<br>
                                <strong>专辑:</strong> ${song.al ? song.al.name : '未知'}<br>
                                <strong>音质:</strong> ${song.br ? Math.round(song.br/1000) + 'kbps' : '未知'}<br>
                                <strong>大小:</strong> ${song.size ? (song.size/1024/1024).toFixed(2) + 'MB' : '未知'}<br>
                                <strong>时长:</strong> ${song.time ? Math.round(song.time/1000) + '秒' : '未知'}<br>
                        `;
                        
                        if (song.url) {
                            resultHtml += `
                                <strong>播放URL:</strong> 
                                <a href="${song.url}" target="_blank" style="word-break: break-all; display: block; margin-top: 5px;">
                                    ${song.url.substring(0, 100)}...
                                </a>
                                <button onclick="playSong(${song.id}, '${song.url}', '${song.name || song.id}')" 
                                        style="margin-top: 5px; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                    <i class="fas fa-play"></i> 播放
                                </button>
                            `;
                        } else {
                            resultHtml += `<strong>播放URL:</strong> <span style="color: #dc3545;">无可用URL</span>`;
                        }
                        
                        if (song.freeTrialInfo) {
                            resultHtml += `<br><strong>试听信息:</strong> ${song.freeTrialInfo.start}ms - ${song.freeTrialInfo.end}ms`;
                        }
                        
                        resultHtml += `</div>`;
                    });
                    resultHtml += '</div>';
                } else {
                    resultHtml = `<div style="color: #dc3545;">获取失败: ${data.message || '未知错误'}</div>`;
                }
                
                document.getElementById('songUrlData').innerHTML = resultHtml;
                document.getElementById('songUrlResult').style.display = 'block';
                
            } catch (error) {
                document.getElementById('songUrlData').innerHTML = 
                    `<div style="color: #dc3545;">请求失败: ${error.message}</div>`;
                document.getElementById('songUrlResult').style.display = 'block';
            } finally {
                getUrlBtn.disabled = false;
                getUrlBtn.innerHTML = '<i class="fas fa-download"></i> 获取音乐URL';
            }
        }

        // 检查音乐可用性
        async function checkMusicAvailable() {
            const songIds = document.getElementById('songIds').value.trim();
            const checkMusicBtn = document.getElementById('checkMusicBtn');
            
            if (!songIds) {
                alert('请输入音乐ID');
                return;
            }
            
            // 只检查第一个ID
            const firstId = songIds.split(',')[0].trim();
            
            checkMusicBtn.disabled = true;
            checkMusicBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 检查中...';
            
            try {
                const url = `${API_BASE}/check/music?id=${firstId}&timestamp=${getTimestamp()}`;
                const response = await fetch(url);
                const data = await response.json();
                
                let resultHtml = '';
                
                if (data.success) {
                    resultHtml += showMessage(`音乐ID ${firstId} 可用: ${data.message}`, 'success').outerHTML;
                } else {
                    resultHtml += showMessage(`音乐ID ${firstId} 不可用: ${data.message}`, 'error').outerHTML;
                }
                
                document.getElementById('songUrlData').innerHTML = resultHtml;
                document.getElementById('songUrlResult').style.display = 'block';
                
            } catch (error) {
                document.getElementById('songUrlData').innerHTML = 
                    showMessage(`检查失败: ${error.message}`, 'error').outerHTML;
                document.getElementById('songUrlResult').style.display = 'block';
            } finally {
                checkMusicBtn.disabled = false;
                checkMusicBtn.innerHTML = '<i class="fas fa-check-circle"></i> 检查音乐可用性';
            }
        }

        // 获取灰色歌曲链接
        async function getUnblockedUrl() {
            const songIds = document.getElementById('songIds').value.trim();
            const unblockBtn = document.getElementById('unblockBtn');
            
            if (!songIds) {
                alert('请输入音乐ID');
                return;
            }
            
            unblockBtn.disabled = true;
            unblockBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 解锁中...';
            
            try {
                // 只解锁第一个ID
                const firstId = songIds.split(',')[0].trim();
                const url = `${API_BASE}/song/url/match?id=${firstId}&timestamp=${getTimestamp()}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                let resultHtml = '';
                
                if (data.code === 200 && data.data && data.data.url) {
                    resultHtml += showMessage(`灰色歌曲解锁成功!`, 'success').outerHTML;
                    resultHtml += `
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>歌曲ID:</strong> ${data.data.id}<br>
                            <strong>来源:</strong> ${data.data.source || '未知'}<br>
                            <strong>播放URL:</strong> 
                            <a href="${data.data.url}" target="_blank" style="word-break: break-all; display: block; margin-top: 5px;">
                                ${data.data.url.substring(0, 100)}...
                            </a>
                            <button onclick="playSong(${data.data.id}, '${data.data.url}', '解锁歌曲')" 
                                    style="margin-top: 5px; padding: 5px 10px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                <i class="fas fa-play"></i> 播放
                            </button>
                        </div>
                    `;
                } else {
                    resultHtml += showMessage(`解锁失败: ${data.message || '该歌曲可能无法解锁'}`, 'error').outerHTML;
                }
                
                document.getElementById('songUrlData').innerHTML = resultHtml;
                document.getElementById('songUrlResult').style.display = 'block';
                
            } catch (error) {
                document.getElementById('songUrlData').innerHTML = 
                    showMessage(`解锁失败: ${error.message}`, 'error').outerHTML;
                document.getElementById('songUrlResult').style.display = 'block';
            } finally {
                unblockBtn.disabled = false;
                unblockBtn.innerHTML = '<i class="fas fa-unlock"></i> 获取灰色歌曲链接';
            }
        }

        // 搜索音乐
        async function searchMusic() {
            const keywords = document.getElementById('keywords').value.trim();
            const searchType = document.getElementById('searchType').value;
            const limit = document.getElementById('searchLimit').value;
            const searchBtn = document.getElementById('searchBtn');
            
            if (!keywords) {
                alert('请输入搜索关键词');
                return;
            }
            
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 搜索中...';
            
            try {
                // 使用cloudsearch接口，搜索结果更全
                const url = `${API_BASE}/cloudsearch?keywords=${encodeURIComponent(keywords)}&type=${searchType}&limit=${limit}&timestamp=${getTimestamp()}`;
                const response = await fetch(url);
                const data = await response.json();
                
                let resultHtml = '';
                
                if (data.code === 200) {
                    // 保存搜索结果
                    searchResults = data.result.songs || data.result.albums || data.result.artists || data.result.playlists || [];
                    
                    resultHtml += showMessage(`搜索到 ${data.result.songCount || data.result.albumCount || data.result.artistCount || data.result.playlistCount || 0} 个结果`, 'success').outerHTML;
                    
                    // 显示搜索结果列表
                    displaySearchResults(searchResults, searchType);
                    
                } else {
                    resultHtml += showMessage(`搜索失败: ${data.message || '未知错误'}`, 'error').outerHTML;
                }
                
                document.getElementById('searchData').innerHTML = resultHtml;
                document.getElementById('searchResult').style.display = 'block';
                
            } catch (error) {
                document.getElementById('searchData').innerHTML = 
                    showMessage(`搜索失败: ${error.message}`, 'error').outerHTML;
                document.getElementById('searchResult').style.display = 'block';
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fas fa-search"></i> 搜索音乐';
            }
        }

        // 显示搜索结果列表
        function displaySearchResults(results, type) {
            const searchList = document.getElementById('searchList');
            let listHtml = '';
            
            if (type === '1') {
                // 单曲
                listHtml += '<div class="song-results">';
                results.forEach((song, index) => {
                    listHtml += `
                        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <strong>${index + 1}. ${song.name}</strong><br>
                            <strong>ID:</strong> ${song.id}<br>
                            <strong>艺术家:</strong> ${song.ar ? song.ar.map(artist => artist.name).join(', ') : '未知'}<br>
                            <strong>专辑:</strong> ${song.al ? song.al.name : '未知'}<br>
                            <strong>时长:</strong> ${Math.round(song.dt/1000)}秒<br>
                            <button onclick="playSongFromSearch(${song.id}, '${song.name.replace(/'/g, "\\'")}')" 
                                    style="margin-top: 5px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                <i class="fas fa-play"></i> 播放
                            </button>
                            <button onclick="document.getElementById('playSongId').value = ${song.id}" 
                                    style="margin-top: 5px; margin-left: 5px; padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                <i class="fas fa-music"></i> 使用ID
                            </button>
                        </div>
                    `;
                });
                listHtml += '</div>';
            } else if (type === '10') {
                // 专辑
                listHtml += '<div class="album-results">';
                results.forEach((album, index) => {
                    listHtml += `
                        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <strong>${index + 1}. ${album.name}</strong><br>
                            <strong>ID:</strong> ${album.id}<br>
                            <strong>艺术家:</strong> ${album.artist ? album.artist.name : '未知'}<br>
                            <strong>发行时间:</strong> ${new Date(album.publishTime).toLocaleDateString() || '未知'}<br>
                            <strong>歌曲数量:</strong> ${album.size || '未知'}<br>
                        </div>
                    `;
                });
                listHtml += '</div>';
            }
            
            searchList.innerHTML = listHtml;
            document.getElementById('searchDetails').style.display = 'block';
        }

        // 从搜索结果播放歌曲
        async function playSongFromSearch(songId, songName) {
            document.getElementById('playSongId').value = songId;
            await playSelectedSong(songName);
        }

        // 播放选中的歌曲
        async function playSelectedSong(predefinedName) {
            const songId = document.getElementById('playSongId').value.trim();
            const playBtn = document.getElementById('playBtn');
            
            if (!songId) {
                alert('请输入音乐ID');
                return;
            }
            
            playBtn.disabled = true;
            playBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 获取URL中...';
            
            try {
                // 获取歌曲URL
                const url = `${API_BASE}/song/url/v1?id=${songId}&level=exhigh&timestamp=${getTimestamp()}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 200 && data.data && data.data.url) {
                    const song = data.data;
                    const songName = predefinedName || song.name || `歌曲 ${songId}`;
                    
                    playSong(songId, song.url, songName, song.br, song.size);
                } else {
                    alert(`无法获取歌曲URL: ${data.message || '未知错误'}`);
                }
                
            } catch (error) {
                alert(`播放失败: ${error.message}`);
            } finally {
                playBtn.disabled = false;
                playBtn.innerHTML = '<i class="fas fa-play"></i> 播放音乐';
            }
        }

        // 播放歌曲
        function playSong(songId, url, name, bitrate, size) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            const audioPlayer = document.getElementById('audioPlayer');
            const container = document.getElementById('audioPlayerContainer');
            const nowPlaying = document.getElementById('nowPlaying');
            const audioInfo = document.getElementById('audioInfo');
            
            audioPlayer.src = url;
            
            nowPlaying.innerHTML = `<strong>${name}</strong> (ID: ${songId})`;
            audioInfo.innerHTML = '';
            
            if (bitrate) {
                audioInfo.innerHTML += `音质: ${Math.round(bitrate/1000)}kbps `;
            }
            if (size) {
                audioInfo.innerHTML += `大小: ${(size/1024/1024).toFixed(2)}MB`;
            }
            
            container.style.display = 'block';
            
            // 尝试播放
            audioPlayer.play().catch(error => {
                console.error('播放失败:', error);
                nowPlaying.innerHTML += '<br><span style="color: #dc3545;">(播放失败，可能需要直接下载)</span>';
            });
            
            currentAudio = audioPlayer;
        }

        // 停止播放
        function stopAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
            currentAudio = null;
        }

        // 页面加载时初始化
        window.addEventListener('load', function() {
            console.log('音乐API测试页面已加载');
        });
    </script>
</body>
</html>
