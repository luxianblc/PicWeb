<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网易云音乐API测试</title>
    <meta name="referrer" content="no-referrer">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-music"></i> 网易云音乐API测试</h1>
            <p>二维码登录 → 获取高质量音乐URL</p>
        </div>

        <!-- 登录状态显示 -->
        <div class="card" style="background: #f8f9fa; border-left: 4px solid #007bff;">
            <h2><i class="fas fa-user-circle"></i> 登录状态</h2>
            <div id="loginStatus" style="display: flex; align-items: center; gap: 15px;">
                <div style="flex: 1;">
                    <div style="font-weight: bold; margin-bottom: 5px;">当前登录状态:</div>
                    <div id="statusText" style="color: #666;">未登录（游客模式）</div>
                    <div id="userInfo" style="display: none; margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                        <div>用户: <span id="userName"></span></div>
                        <div>ID: <span id="userId"></span></div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <button onclick="checkLoginStatus()" style="padding: 8px 15px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-sync-alt"></i> 刷新状态
                    </button>
                </div>
            </div>
        </div>

        <!-- 二维码登录 -->
        <div class="card">
            <h2><i class="fas fa-qrcode"></i> 二维码登录</h2>
            <p style="color: #666; margin-bottom: 15px;">使用网易云音乐APP扫码登录，登录后可获取会员歌曲</p>
            
            <div class="button-group">
                <button class="btn-primary" onclick="startQRLogin()" id="qrLoginBtn">
                    <i class="fas fa-qrcode"></i> 开始二维码登录
                </button>
                <button class="btn-secondary" onclick="clearLogin()" id="clearLoginBtn">
                    <i class="fas fa-sign-out-alt"></i> 退出登录
                </button>
            </div>
            
            <div id="qrcodeContainer" style="display: none; text-align: center; margin-top: 20px;">
                <div id="qrcodeImage" style="margin: 0 auto 15px; max-width: 200px;"></div>
                <div id="qrcodeStatus" style="padding: 10px; border-radius: 5px; background: #e9ecef; margin-bottom: 10px;">
                    <i class="fas fa-sync-alt fa-spin"></i> 正在生成二维码...
                </div>
                <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                    时间戳: <span id="qrTimestamp"></span>
                </div>
                <button onclick="stopQRLogin()" style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-stop"></i> 停止轮询
                </button>
            </div>
            
            <div id="qrResult" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                <h4><i class="fas fa-check-circle"></i> 登录结果</h4>
                <div id="qrData"></div>
            </div>
        </div>

        <!-- 游客登录 -->
        <div class="card">
            <h2><i class="fas fa-user"></i> 游客登录</h2>
            <p style="color: #666; margin-bottom: 15px;">快速获取游客身份，避免未登录状态报错</p>
            
            <div class="button-group">
                <button class="btn-success" onclick="guestLogin()" id="guestLoginBtn">
                    <i class="fas fa-sign-in-alt"></i> 游客登录
                </button>
                <button class="btn-secondary" onclick="clearGuestCookie()">
                    <i class="fas fa-trash"></i> 清除游客Cookie
                </button>
            </div>
            
            <div id="guestResult" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                <h4><i class="fas fa-info-circle"></i> 游客登录结果</h4>
                <div id="guestData"></div>
            </div>
        </div>

        <!-- 搜索测试 -->
        <div class="card">
            <h2><i class="fas fa-search"></i> 搜索音乐</h2>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">搜索关键词:</label>
                <input type="text" id="keywords" placeholder="例如: 周杰伦 搁浅" value="周杰伦" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">搜索类型:</label>
                <select id="searchType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="1" selected>单曲</option>
                    <option value="10">专辑</option>
                    <option value="100">歌手</option>
                    <option value="1000">歌单</option>
                    <option value="1002">用户</option>
                </select>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">返回数量:</label>
                <input type="number" id="searchLimit" value="10" min="1" max="100" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <button onclick="searchMusic()" id="searchBtn" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
                <i class="fas fa-search"></i> 搜索音乐
            </button>
            
            <div id="searchResult" style="display: none; margin-top: 20px;">
                <h4><i class="fas fa-search"></i> 搜索结果</h4>
                <div id="searchData"></div>
            </div>
            
            <div id="searchDetails" style="display: none; margin-top: 20px;">
                <h4><i class="fas fa-list"></i> 搜索结果列表</h4>
                <div id="searchList"></div>
            </div>
        </div>

        <!-- 音乐播放测试 -->
        <div class="card">
            <h2><i class="fas fa-play-circle"></i> 音乐播放测试</h2>
            
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">播放音乐ID:</label>
                <input type="text" id="playSongId" placeholder="输入音乐ID进行播放" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            
            <div class="button-group" style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button onclick="playSelectedSong()" id="playBtn" style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-play"></i> 播放音乐
                </button>
                <button onclick="stopAudio()" id="stopBtn" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-stop"></i> 停止播放
                </button>
            </div>
            
            <div id="audioPlayerContainer" style="display: none; margin-top: 20px;">
                <h4>正在播放:</h4>
                <div id="nowPlaying" style="margin-bottom: 10px;"></div>
                <audio id="audioPlayer" controls style="width: 100%;"></audio>
                <div id="audioInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
            </div>
        </div>

        <!-- API信息 -->
        <div class="card">
            <h2><i class="fas fa-info-circle"></i> 接口说明</h2>
            <div style="line-height: 1.8;">
                <p><strong>API地址:</strong> <code id="currentApiBase">https://neteaseapi-enhanced.vercel.app</code></p>
                <p><strong>二维码登录:</strong> /login/qr/key → /login/qr/create → /login/qr/check</p>
                <p><strong>游客登录:</strong> /register/anonimous</p>
                <p><strong>音乐URL获取:</strong> /song/url/v1 (需要登录获取高质量音质)</p>
                <p><strong>搜索功能:</strong> /cloudsearch</p>
                <p><strong>注意:</strong> 所有请求已添加 randomCNIP=true 参数解决海外IP限制</p>
            </div>
        </div>
    </div>

    <script>
        // API基础地址 - 请确保这里是你Vercel部署的正确地址
        const API_BASE = 'https://neteaseapi-enhanced.vercel.app'; // 请修改为你的Vercel地址
        document.getElementById('currentApiBase').textContent = API_BASE;
        
        let currentAudio = null;
        let searchResults = [];
        let qrCheckInterval = null;
        let currentQRKey = null;
        let currentCookie = null;

        // 构建API URL的辅助函数 - 自动添加时间戳和randomCNIP参数
        function buildApiUrl(endpoint, params = {}) {
            // 确保所有请求都带上时间戳和中国IP参数
            const baseParams = `timestamp=${Date.now()}&randomCNIP=true`;
            const queryParams = new URLSearchParams(params).toString();
            
            if (queryParams) {
                return `${API_BASE}${endpoint}?${baseParams}&${queryParams}`;
            } else {
                return `${API_BASE}${endpoint}?${baseParams}`;
            }
        }

        // 页面加载时检查登录状态
        window.addEventListener('load', function() {
            console.log('音乐API测试页面已加载');
            
            // 检查本地存储的Cookie
            const savedCookie = localStorage.getItem('netease_cookie');
            if (savedCookie) {
                currentCookie = savedCookie;
                updateLoginStatus();
            } else {
                // 尝试游客登录
                autoGuestLogin();
            }
        });

        // 自动游客登录
        async function autoGuestLogin() {
            try {
                const url = buildApiUrl('/register/anonimous');
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 200 && data.cookie) {
                    currentCookie = data.cookie;
                    localStorage.setItem('netease_cookie', currentCookie);
                    console.log('自动游客登录成功');
                    updateLoginStatus();
                }
            } catch (error) {
                console.log('自动游客登录失败，继续未登录状态');
            }
        }

        // 更新登录状态显示
        function updateLoginStatus() {
            const statusText = document.getElementById('statusText');
            const userInfo = document.getElementById('userInfo');
            
            if (currentCookie) {
                statusText.innerHTML = '<span style="color: #28a745;">已登录</span>';
                statusText.innerHTML += '<br><small style="color: #666;">Cookie已保存</small>';
            } else {
                statusText.innerHTML = '<span style="color: #dc3545;">未登录（游客模式）</span>';
                userInfo.style.display = 'none';
            }
        }

        // 检查详细的登录状态
        async function checkLoginStatus() {
            if (!currentCookie) {
                alert('当前未登录');
                return;
            }
            
            try {
                const url = buildApiUrl('/login/status', { cookie: currentCookie });
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 200 && data.data && data.data.profile) {
                    const userInfo = document.getElementById('userInfo');
                    document.getElementById('userName').textContent = data.data.profile.nickname;
                    document.getElementById('userId').textContent = data.data.profile.userId;
                    userInfo.style.display = 'block';
                    
                    alert(`登录状态正常\n用户: ${data.data.profile.nickname}\nVIP类型: ${data.data.profile.vipType || '非VIP'}`);
                } else {
                    alert('登录状态已过期');
                }
            } catch (error) {
                alert('检查登录状态失败: ' + error.message);
            }
        }

        // 开始二维码登录
        async function startQRLogin() {
            const qrLoginBtn = document.getElementById('qrLoginBtn');
            const qrcodeContainer = document.getElementById('qrcodeContainer');
            const qrcodeStatus = document.getElementById('qrcodeStatus');
            
            qrLoginBtn.disabled = true;
            qrLoginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 处理中...';
            
            qrcodeContainer.style.display = 'block';
            document.getElementById('qrTimestamp').textContent = Date.now();
            
            try {
                // 1. 获取二维码key
                qrcodeStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> 正在获取二维码密钥...';
                
                const keyUrl = buildApiUrl('/login/qr/key');
                const keyResponse = await fetch(keyUrl);
                const keyData = await keyResponse.json();
                
                if (keyData.code !== 200) {
                    throw new Error('获取二维码key失败: ' + (keyData.message || '未知错误'));
                }
                
                currentQRKey = keyData.data.unikey;
                qrcodeStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> 正在生成二维码...';
                
                // 2. 生成二维码
                const qrUrl = buildApiUrl('/login/qr/create', { key: currentQRKey, qrimg: true });
                const qrResponse = await fetch(qrUrl);
                const qrData = await qrResponse.json();
                
                if (qrData.code !== 200) {
                    throw new Error('生成二维码失败: ' + (qrData.message || '未知错误'));
                }
                
                // 显示二维码
                const qrcodeImage = document.getElementById('qrcodeImage');
                qrcodeImage.innerHTML = `<img src="${qrData.data.qrimg}" alt="扫码登录二维码" style="width: 100%; border: 1px solid #ddd; border-radius: 5px;">`;
                
                // 3. 开始轮询扫码状态
                startQRPolling();
                
            } catch (error) {
                qrcodeStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> 错误: ${error.message}`;
                qrLoginBtn.disabled = false;
                qrLoginBtn.innerHTML = '<i class="fas fa-qrcode"></i> 开始二维码登录';
            }
        }

        // 轮询二维码扫码状态
        function startQRPolling() {
            if (qrCheckInterval) clearInterval(qrCheckInterval);
            
            qrCheckInterval = setInterval(async () => {
                try {
                    const checkUrl = buildApiUrl('/login/qr/check', { key: currentQRKey });
                    const checkResponse = await fetch(checkUrl);
                    const checkData = await checkResponse.json();
                    
                    const qrcodeStatus = document.getElementById('qrcodeStatus');
                    
                    switch(checkData.code) {
                        case 800:
                            qrcodeStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> 二维码已过期，请重新生成';
                            clearInterval(qrCheckInterval);
                            qrCheckInterval = null;
                            break;
                        case 801:
                            qrcodeStatus.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> 等待扫码...';
                            break;
                        case 802:
                            qrcodeStatus.innerHTML = '<i class="fas fa-check-circle"></i> 已扫码，请在APP中确认登录';
                            break;
                        case 803:
                            // 登录成功
                            clearInterval(qrCheckInterval);
                            qrCheckInterval = null;
                            
                            currentCookie = checkData.cookie;
                            localStorage.setItem('netease_cookie', currentCookie);
                            
                            qrcodeStatus.innerHTML = '<i class="fas fa-check-circle"></i> 登录成功！';
                            
                            // 显示结果
                            document.getElementById('qrData').innerHTML = `
                                <div style="color: #28a745; margin-bottom: 10px;">
                                    <i class="fas fa-check-circle"></i> 二维码登录成功！
                                </div>
                                <div style="font-size: 12px; color: #666;">
                                    Cookie已保存到本地存储<br>
                                    现在可以获取高质量音乐URL了
                                </div>
                            `;
                            document.getElementById('qrResult').style.display = 'block';
                            
                            // 重置按钮
                            document.getElementById('qrLoginBtn').disabled = false;
                            document.getElementById('qrLoginBtn').innerHTML = '<i class="fas fa-qrcode"></i> 开始二维码登录';
                            
                            // 更新状态
                            updateLoginStatus();
                            break;
                        default:
                            qrcodeStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> 未知状态: ${checkData.code}`;
                    }
                } catch (error) {
                    console.error('轮询失败:', error);
                }
            }, 2000);
        }

        // 停止二维码登录
        function stopQRLogin() {
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
                qrCheckInterval = null;
            }
            
            document.getElementById('qrcodeContainer').style.display = 'none';
            document.getElementById('qrLoginBtn').disabled = false;
            document.getElementById('qrLoginBtn').innerHTML = '<i class="fas fa-qrcode"></i> 开始二维码登录';
        }

        // 游客登录
        async function guestLogin() {
            const guestLoginBtn = document.getElementById('guestLoginBtn');
            guestLoginBtn.disabled = true;
            guestLoginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登录中...';
            
            try {
                const url = buildApiUrl('/register/anonimous');
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 200 && data.cookie) {
                    currentCookie = data.cookie;
                    localStorage.setItem('netease_cookie', currentCookie);
                    
                    document.getElementById('guestData').innerHTML = `
                        <div style="color: #28a745; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> 游客登录成功！
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            游客Cookie已保存到本地存储<br>
                            现在可以避免未登录状态报错了
                        </div>
                    `;
                    
                    updateLoginStatus();
                } else {
                    document.getElementById('guestData').innerHTML = `
                        <div style="color: #dc3545;">
                            <i class="fas fa-exclamation-circle"></i> 游客登录失败: ${data.message || '未知错误'}
                        </div>
                    `;
                }
                
                document.getElementById('guestResult').style.display = 'block';
                
            } catch (error) {
                document.getElementById('guestData').innerHTML = `
                    <div style="color: #dc3545;">
                        <i class="fas fa-exclamation-circle"></i> 网络错误: ${error.message}
                    </div>
                `;
                document.getElementById('guestResult').style.display = 'block';
            } finally {
                guestLoginBtn.disabled = false;
                guestLoginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> 游客登录';
            }
        }

        // 清除游客Cookie
        function clearGuestCookie() {
            currentCookie = null;
            localStorage.removeItem('netease_cookie');
            updateLoginStatus();
            alert('游客Cookie已清除');
        }

        // 清除登录
        function clearLogin() {
            currentCookie = null;
            localStorage.removeItem('netease_cookie');
            updateLoginStatus();
            alert('已退出登录');
        }

        // 搜索音乐
        async function searchMusic() {
            const keywords = document.getElementById('keywords').value.trim();
            const searchType = document.getElementById('searchType').value;
            const limit = document.getElementById('searchLimit').value;
            const searchBtn = document.getElementById('searchBtn');
            
            if (!keywords) {
                alert('请输入搜索关键词');
                return;
            }
            
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 搜索中...';
            
            try {
                // 构建请求URL - 使用辅助函数自动添加参数
                const params = {
                    keywords: encodeURIComponent(keywords),
                    type: searchType,
                    limit: limit
                };
                
                // 如果有Cookie，添加到请求中
                if (currentCookie) {
                    params.cookie = currentCookie;
                }
                
                const url = buildApiUrl('/cloudsearch', params);
                const response = await fetch(url);
                const data = await response.json();
                
                let resultHtml = '';
                
                if (data.code === 200) {
                    // 保存搜索结果
                    searchResults = data.result.songs || data.result.albums || data.result.artists || data.result.playlists || [];
                    
                    const count = data.result.songCount || data.result.albumCount || data.result.artistCount || data.result.playlistCount || 0;
                    resultHtml += `<div style="color: #28a745; margin-bottom: 10px;">
                        <i class="fas fa-check-circle"></i> 搜索到 ${count} 个结果
                    </div>`;
                    
                    // 显示搜索结果列表
                    displaySearchResults(searchResults, searchType);
                    
                } else {
                    resultHtml += `<div style="color: #dc3545;">
                        <i class="fas fa-exclamation-circle"></i> 搜索失败: ${data.message || '未知错误'}
                    </div>`;
                }
                
                document.getElementById('searchData').innerHTML = resultHtml;
                document.getElementById('searchResult').style.display = 'block';
                
            } catch (error) {
                document.getElementById('searchData').innerHTML = 
                    `<div style="color: #dc3545;">
                        <i class="fas fa-exclamation-circle"></i> 搜索失败: ${error.message}
                    </div>`;
                document.getElementById('searchResult').style.display = 'block';
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fas fa-search"></i> 搜索音乐';
            }
        }

        // 显示搜索结果列表
        function displaySearchResults(results, type) {
            const searchList = document.getElementById('searchList');
            let listHtml = '';
            
            if (type === '1') {
                // 单曲
                listHtml += '<div>';
                results.slice(0, 10).forEach((song, index) => {
                    listHtml += `
                        <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <strong>${index + 1}. ${song.name}</strong><br>
                            <small>ID: ${song.id} | 时长: ${Math.round(song.dt/1000)}秒</small><br>
                            <small>艺术家: ${song.ar ? song.ar.map(artist => artist.name).join(', ') : '未知'}</small><br>
                            <div style="margin-top: 10px; display: flex; gap: 5px;">
                                <button onclick="playSongFromSearch(${song.id}, '${song.name.replace(/'/g, "\\'")}')" 
                                        style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-play"></i> 播放
                                </button>
                                <button onclick="document.getElementById('playSongId').value = ${song.id}" 
                                        style="padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                    <i class="fas fa-music"></i> 使用ID
                                </button>
                            </div>
                        </div>
                    `;
                });
                listHtml += '</div>';
            }
            
            searchList.innerHTML = listHtml;
            document.getElementById('searchDetails').style.display = 'block';
        }

        // 从搜索结果播放歌曲
        async function playSongFromSearch(songId, songName) {
            document.getElementById('playSongId').value = songId;
            await playSelectedSong(songName);
        }

        // 播放选中的歌曲
        async function playSelectedSong(predefinedName) {
            const songId = document.getElementById('playSongId').value.trim();
            const playBtn = document.getElementById('playBtn');
            
            if (!songId) {
                alert('请输入音乐ID');
                return;
            }
            
            playBtn.disabled = true;
            playBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 获取URL中...';
            
            try {
                // 构建请求URL - 使用辅助函数自动添加参数
                const params = {
                    id: songId,
                    level: 'exhigh'
                };
                
                // 如果有Cookie，添加到请求中（获取高质量音质必需）
                if (currentCookie) {
                    params.cookie = currentCookie;
                }
                
                const url = buildApiUrl('/song/url/v1', params);
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 200 && data.data && data.data.url) {
                    const song = data.data;
                    const songName = predefinedName || song.name || `歌曲 ${songId}`;
                    
                    // 检查URL是否有效
                    if (song.url && song.url.startsWith('http') && song.code !== 404) {
                        playSong(songId, song.url, songName, song.br, song.size);
                    } else {
                        alert(`无法播放此歌曲\n可能原因：需要VIP、无版权或地区限制\n当前登录状态: ${currentCookie ? '已登录' : '未登录'}`);
                    }
                } else {
                    alert(`无法获取歌曲URL: ${data.message || '未知错误'}\n当前登录状态: ${currentCookie ? '已登录' : '未登录'}`);
                }
                
            } catch (error) {
                alert(`播放失败: ${error.message}`);
            } finally {
                playBtn.disabled = false;
                playBtn.innerHTML = '<i class="fas fa-play"></i> 播放音乐';
            }
        }

        // 播放歌曲
        function playSong(songId, url, name, bitrate, size) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            const audioPlayer = document.getElementById('audioPlayer');
            const container = document.getElementById('audioPlayerContainer');
            const nowPlaying = document.getElementById('nowPlaying');
            const audioInfo = document.getElementById('audioInfo');
            
            audioPlayer.src = url;
            
            nowPlaying.innerHTML = `<strong>${name}</strong> (ID: ${songId})`;
            audioInfo.innerHTML = '';
            
            if (bitrate) {
                audioInfo.innerHTML += `音质: ${Math.round(bitrate/1000)}kbps `;
            }
            if (size) {
                audioInfo.innerHTML += `大小: ${(size/1024/1024).toFixed(2)}MB`;
            }
            
            container.style.display = 'block';
            
            // 尝试播放
            audioPlayer.play().catch(error => {
                console.error('播放失败:', error);
                nowPlaying.innerHTML += '<br><span style="color: #dc3545;">(播放失败，请检查网络或登录状态)</span>';
            });
            
            currentAudio = audioPlayer;
        }

        // 停止播放
        function stopAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
            currentAudio = null;
        }
    </script>
</body>
</html>
