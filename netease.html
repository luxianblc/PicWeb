<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨</title>
</head>
<body>
    <div id="app">
        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <div>
            <h1>ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨</h1>
            <div id="loginStatus">
                <div id="userInfo" style="display: none;">
                    <span id="userName">æ¸¸å®¢</span>
                </div>
                <button id="loginBtn">ç™»å½•</button>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div>
            <!-- å·¦ä¾§ï¼šæ’­æ”¾å™¨å’Œæœç´¢ -->
            <div>
                <!-- æœç´¢åŒºåŸŸ -->
                <div>
                    <div>
                        <input type="text" id="searchInput" placeholder="æœç´¢æ­Œæ›²ã€æ­Œæ‰‹ã€ä¸“è¾‘...">
                        <button id="searchBtn">æœç´¢</button>
                    </div>
                    
                    <div id="searchTypes">
                        <button data-type="1" class="active">å•æ›²</button>
                        <button data-type="100">æ­Œæ‰‹</button>
                        <button data-type="10">ä¸“è¾‘</button>
                        <button data-type="1000">æ­Œå•</button>
                        <button data-type="1002">ç”¨æˆ·</button>
                    </div>
                </div>
                
                <!-- æœç´¢ç»“æœ -->
                <div id="searchResults">
                    <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <!-- æ’­æ”¾å™¨æ§ä»¶ -->
                <div>
                    <div>
                        <div id="albumArt">ä¸“è¾‘å°é¢</div>
                        <div>
                            <h2 id="currentTrack">è¯·é€‰æ‹©æ­Œæ›²</h2>
                            <p id="currentArtist">-</p>
                            <p id="currentAlbum">-</p>
                        </div>
                    </div>
                    
                    <div>
                        <div id="progressBar">
                            <div id="progress"></div>
                        </div>
                        <div>
                            <span id="currentTime">0:00</span>
                            <span id="totalTime">0:00</span>
                        </div>
                    </div>
                    
                    <div>
                        <button id="prevBtn">ä¸Šä¸€é¦–</button>
                        <button id="playBtn">æ’­æ”¾</button>
                        <button id="nextBtn">ä¸‹ä¸€é¦–</button>
                    </div>
                    
                    <div>
                        <input type="range" id="volumeSlider" min="0" max="100" value="70">
                        <span id="volumePercent">70%</span>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šæ­Œè¯åŒºåŸŸ -->
            <div>
                <h2>æ­Œè¯</h2>
                <div id="lyricsContainer">
                    æ­Œè¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000;">
        <div style="background: white; padding: 20px; max-width: 400px; margin: 50px auto;">
            <h3>ç½‘æ˜“äº‘éŸ³ä¹ç™»å½•</h3>
            
            <div id="qrcodeImage">
                <!-- äºŒç»´ç å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
            
            <div id="qrStatus">
                æ­£åœ¨ç”ŸæˆäºŒç»´ç ...
            </div>
            
            <div>
                <button id="guestLoginBtn">æ¸¸å®¢ç™»å½•</button>
                <button id="closeModalBtn">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="audioPlayer"></audio>

    <script>
        // APIåŸºç¡€åœ°å€
        const API_BASE = 'https://neteaseapi-enhanced.vercel.app';
        
        // å…¨å±€å˜é‡
        let currentCookie = null;
        let currentUser = null;
        let currentSearchResults = [];
        let currentTrackIndex = 0;
        let currentSearchType = 1;
        let qrKey = null;
        let qrCheckInterval = null;
        let currentLyrics = [];
        let currentLyricIndex = 0;
        
        // DOMå…ƒç´ 
        const loginBtn = document.getElementById('loginBtn');
        const loginModal = document.getElementById('loginModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const guestLoginBtn = document.getElementById('guestLoginBtn');
        const qrcodeImage = document.getElementById('qrcodeImage');
        const qrStatus = document.getElementById('qrStatus');
        const userInfo = document.getElementById('userInfo');
        const userName = document.getElementById('userName');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        const searchTypeBtns = document.querySelectorAll('#searchTypes button');
        const audioPlayer = document.getElementById('audioPlayer');
        const currentTrack = document.getElementById('currentTrack');
        const currentArtist = document.getElementById('currentArtist');
        const currentAlbum = document.getElementById('currentAlbum');
        const albumArt = document.getElementById('albumArt');
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const currentTimeEl = document.getElementById('currentTime');
        const totalTimeEl = document.getElementById('totalTime');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumePercent = document.getElementById('volumePercent');
        const lyricsContainer = document.getElementById('lyricsContainer');
        
        // åˆå§‹åŒ– - ä¿®å¤äº‹ä»¶ç»‘å®šé—®é¢˜
        function init() {
            console.log('åˆå§‹åŒ–æ’­æ”¾å™¨...');
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„Cookie
            const savedCookie = localStorage.getItem('netease_cookie');
            if (savedCookie) {
                currentCookie = savedCookie;
                checkLoginStatus();
            }
            
            // ç»‘å®šäº‹ä»¶ - ç¡®ä¿DOMå…ƒç´ å­˜åœ¨
            if (loginBtn) {
                loginBtn.addEventListener('click', openLoginModal);
                console.log('ç™»å½•æŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
            } else {
                console.error('æ‰¾ä¸åˆ°ç™»å½•æŒ‰é’®');
            }
            
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeLoginModal);
            }
            
            if (guestLoginBtn) {
                guestLoginBtn.addEventListener('click', guestLogin);
            }
            
            if (searchBtn) {
                searchBtn.addEventListener('click', performSearch);
            }
            
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
            
            // æœç´¢ç±»å‹æŒ‰é’®äº‹ä»¶ - ä¿®å¤äº‹ä»¶å§”æ‰˜
            if (searchTypeBtns.length > 0) {
                searchTypeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        console.log('æœç´¢ç±»å‹æŒ‰é’®ç‚¹å‡»:', this.dataset.type);
                        
                        // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                        searchTypeBtns.forEach(b => b.classList.remove('active'));
                        
                        // ç»™å½“å‰æŒ‰é’®æ·»åŠ activeç±»
                        this.classList.add('active');
                        
                        // æ›´æ–°æœç´¢ç±»å‹
                        currentSearchType = parseInt(this.dataset.type);
                        console.log('å½“å‰æœç´¢ç±»å‹è®¾ç½®ä¸º:', currentSearchType);
                        
                        // å¦‚æœæœç´¢æ¡†æœ‰å†…å®¹ï¼Œé‡æ–°æœç´¢
                        if (searchInput && searchInput.value.trim()) {
                            performSearch();
                        }
                    });
                });
                console.log('æœç´¢ç±»å‹æŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
            }
            
            // æ’­æ”¾å™¨æ§åˆ¶äº‹ä»¶
            if (playBtn) playBtn.addEventListener('click', togglePlay);
            if (prevBtn) prevBtn.addEventListener('click', playPrev);
            if (nextBtn) nextBtn.addEventListener('click', playNext);
            if (progressBar) progressBar.addEventListener('click', seekToPosition);
            if (volumeSlider) volumeSlider.addEventListener('input', updateVolume);
            
            // éŸ³é¢‘äº‹ä»¶ç›‘å¬
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('loadedmetadata', updateDuration);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('play', () => {
                if (playBtn) playBtn.textContent = 'æš‚åœ';
            });
            audioPlayer.addEventListener('pause', () => {
                if (playBtn) playBtn.textContent = 'æ’­æ”¾';
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            loginModal.addEventListener('click', (e) => {
                if (e.target === loginModal) {
                    closeLoginModal();
                }
            });
            
            // ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && loginModal.style.display === 'block') {
                    closeLoginModal();
                }
            });
            
            console.log('åˆå§‹åŒ–å®Œæˆ');
        }
        
        // æ‰“å¼€ç™»å½•æ¨¡æ€æ¡†
        function openLoginModal() {
            console.log('æ‰“å¼€ç™»å½•æ¨¡æ€æ¡†');
            loginModal.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // å¼€å§‹äºŒç»´ç ç™»å½•æµç¨‹
            startQRLogin();
        }
        
        // å…³é—­ç™»å½•æ¨¡æ€æ¡†
        function closeLoginModal() {
            console.log('å…³é—­ç™»å½•æ¨¡æ€æ¡†');
            loginModal.style.display = 'none';
            document.body.style.overflow = '';
            
            // åœæ­¢è½®è¯¢
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
                qrCheckInterval = null;
            }
        }
        
        // å¼€å§‹äºŒç»´ç ç™»å½•
        async function startQRLogin() {
            try {
                console.log('å¼€å§‹äºŒç»´ç ç™»å½•...');
                updateQRStatus('æ­£åœ¨è·å–äºŒç»´ç å¯†é’¥...');
                
                const keyRes = await fetch(`${API_BASE}/login/qr/key?timestamp=${Date.now()}`);
                const keyData = await keyRes.json();
                
                if (keyData.code !== 200) {
                    throw new Error(`è·å–äºŒç»´ç keyå¤±è´¥: ${keyData.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
                qrKey = keyData.data.unikey;
                console.log('è·å–åˆ°äºŒç»´ç key:', qrKey);
                updateQRStatus('æ­£åœ¨ç”ŸæˆäºŒç»´ç ...');
                
                // 2. ç”ŸæˆäºŒç»´ç 
                const qrRes = await fetch(`${API_BASE}/login/qr/create?key=${qrKey}&qrimg=true&timestamp=${Date.now()}`);
                const qrData = await qrRes.json();
                
                if (qrData.code !== 200) {
                    throw new Error(`ç”ŸæˆäºŒç»´ç å¤±è´¥: ${qrData.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
                // æ˜¾ç¤ºäºŒç»´ç å›¾ç‰‡
                if (qrcodeImage) {
                    qrcodeImage.innerHTML = `<img src="${qrData.data.qrimg}" alt="æ‰«ç ç™»å½•äºŒç»´ç " style="max-width: 250px;">`;
                }
                
                // 3. å¼€å§‹è½®è¯¢æ‰«ç çŠ¶æ€
                startPollingQRStatus();
                
            } catch (error) {
                console.error('äºŒç»´ç ç™»å½•å¤±è´¥:', error);
                updateQRStatus(`é”™è¯¯: ${error.message}`);
            }
        }
        
        // è½®è¯¢äºŒç»´ç æ‰«ç çŠ¶æ€
        function startPollingQRStatus() {
            if (qrCheckInterval) clearInterval(qrCheckInterval);
            
            qrCheckInterval = setInterval(async () => {
                try {
                    const checkRes = await fetch(`${API_BASE}/login/qr/check?key=${qrKey}&timestamp=${Date.now()}`);
                    const checkData = await checkRes.json();
                    
                    if (checkData.code === 800) {
                        updateQRStatus('äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç”Ÿæˆ');
                        clearInterval(qrCheckInterval);
                        qrCheckInterval = null;
                    } else if (checkData.code === 801) {
                        updateQRStatus('ç­‰å¾…æ‰«ç ...');
                    } else if (checkData.code === 802) {
                        updateQRStatus('å·²æ‰«ç ï¼Œè¯·åœ¨APPä¸­ç¡®è®¤ç™»å½•');
                    } else if (checkData.code === 803) {
                        // ç™»å½•æˆåŠŸ
                        clearInterval(qrCheckInterval);
                        qrCheckInterval = null;
                        
                        currentCookie = checkData.cookie;
                        localStorage.setItem('netease_cookie', currentCookie);
                        
                        updateQRStatus('ç™»å½•æˆåŠŸï¼æ­£åœ¨æ›´æ–°çŠ¶æ€...');
                        
                        // æ£€æŸ¥ç™»å½•çŠ¶æ€
                        setTimeout(() => {
                            checkLoginStatus();
                            closeLoginModal();
                        }, 1500);
                    }
                } catch (error) {
                    console.error('è½®è¯¢å¤±è´¥:', error);
                }
            }, 2000);
        }
        
        // æ›´æ–°äºŒç»´ç çŠ¶æ€
        function updateQRStatus(message) {
            if (qrStatus) {
                qrStatus.textContent = message;
            }
        }
        
        // æ¸¸å®¢ç™»å½•
        async function guestLogin() {
            try {
                console.log('å¼€å§‹æ¸¸å®¢ç™»å½•...');
                const res = await fetch(`${API_BASE}/register/anonimous?timestamp=${Date.now()}`);
                const data = await res.json();
                
                if (data.code === 200 && data.cookie) {
                    currentCookie = data.cookie;
                    localStorage.setItem('netease_cookie', currentCookie);
                    
                    // è®¾ç½®æ¸¸å®¢ä¿¡æ¯
                    currentUser = { nickname: 'æ¸¸å®¢ç”¨æˆ·' };
                    updateUserInfo();
                    
                    closeLoginModal();
                    console.log('æ¸¸å®¢ç™»å½•æˆåŠŸ');
                } else {
                    throw new Error('æ¸¸å®¢ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                console.error('æ¸¸å®¢ç™»å½•å¤±è´¥:', error);
                updateQRStatus('æ¸¸å®¢ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            if (!currentCookie) return;
            
            try {
                const url = `${API_BASE}/login/status?timestamp=${Date.now()}&cookie=${encodeURIComponent(currentCookie)}`;
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.code === 200 && data.data && data.data.profile) {
                    currentUser = data.data.profile;
                    updateUserInfo();
                } else {
                    // ç™»å½•çŠ¶æ€å¤±æ•ˆï¼Œæ¸…é™¤Cookie
                    currentCookie = null;
                    localStorage.removeItem('netease_cookie');
                    currentUser = null;
                    updateUserInfo();
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        function updateUserInfo() {
            if (currentUser) {
                userName.textContent = currentUser.nickname || 'ç½‘æ˜“äº‘ç”¨æˆ·';
                userInfo.style.display = 'block';
                loginBtn.textContent = 'å·²ç™»å½•';
                loginBtn.disabled = true;
            } else {
                userInfo.style.display = 'none';
                loginBtn.textContent = 'ç™»å½•';
                loginBtn.disabled = false;
            }
        }
        
        // æ‰§è¡Œæœç´¢
        async function performSearch() {
            const keywords = searchInput.value.trim();
            if (!keywords) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            
            console.log('æ‰§è¡Œæœç´¢:', keywords, 'ç±»å‹:', currentSearchType);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            searchResults.innerHTML = '<div>æ­£åœ¨æœç´¢...</div>';
            
            try {
                // æ ¹æ®æœç´¢ç±»å‹æ„å»ºURL
                let url = '';
                if (currentSearchType === 1) {
                    // å•æ›²æœç´¢
                    url = `${API_BASE}/cloudsearch?keywords=${encodeURIComponent(keywords)}&type=${currentSearchType}&limit=20&timestamp=${Date.now()}`;
                } else {
                    // å…¶ä»–ç±»å‹æœç´¢
                    url = `${API_BASE}/search?keywords=${encodeURIComponent(keywords)}&type=${currentSearchType}&limit=20&timestamp=${Date.now()}`;
                }
                
                if (currentCookie) {
                    url += `&cookie=${encodeURIComponent(currentCookie)}`;
                }
                
                console.log('æœç´¢URL:', url);
                
                const res = await fetch(url);
                const data = await res.json();
                
                console.log('æœç´¢ç»“æœ:', data);
                
                if (data.code === 200) {
                    currentSearchResults = [];
                    
                    // æ ¹æ®æœç´¢ç±»å‹å¤„ç†ç»“æœ
                    switch(currentSearchType) {
                        case 1: // å•æ›²
                            if (data.result && data.result.songs) {
                                currentSearchResults = data.result.songs;
                            }
                            break;
                        case 100: // æ­Œæ‰‹
                            if (data.result && data.result.artists) {
                                currentSearchResults = data.result.artists;
                            }
                            break;
                        case 10: // ä¸“è¾‘
                            if (data.result && data.result.albums) {
                                currentSearchResults = data.result.albums;
                            }
                            break;
                        case 1000: // æ­Œå•
                            if (data.result && data.result.playlists) {
                                currentSearchResults = data.result.playlists;
                            }
                            break;
                        case 1002: // ç”¨æˆ·
                            if (data.result && data.result.userprofiles) {
                                currentSearchResults = data.result.userprofiles;
                            }
                            break;
                    }
                    
                    console.log('å¤„ç†åçš„æœç´¢ç»“æœ:', currentSearchResults);
                    renderSearchResults();
                } else {
                    throw new Error(data.message || 'æœç´¢å¤±è´¥');
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                searchResults.innerHTML = `<div>æœç´¢å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ¸²æŸ“æœç´¢ç»“æœ
        function renderSearchResults() {
            if (currentSearchResults.length === 0) {
                searchResults.innerHTML = '<div>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç»“æœ</div>';
                return;
            }
            
            let html = '';
            
            currentSearchResults.forEach((item, index) => {
                const type = currentSearchType;
                
                // è·å–å°é¢ã€æ ‡é¢˜ã€æè¿°ä¿¡æ¯
                let cover = '';
                let title = '';
                let description = '';
                let duration = '';
                
                switch(type) {
                    case 1: // å•æ›²
                        cover = item.al && item.al.picUrl ? item.al.picUrl : '';
                        title = item.name || 'æœªçŸ¥æ­Œæ›²';
                        description = item.ar ? item.ar.map(artist => artist.name).join(', ') : 'æœªçŸ¥æ­Œæ‰‹';
                        duration = formatDuration(item.dt || 0);
                        break;
                    case 100: // æ­Œæ‰‹
                        cover = item.picUrl || '';
                        title = item.name || 'æœªçŸ¥æ­Œæ‰‹';
                        description = `ä¸“è¾‘æ•°: ${item.albumSize || 0}`;
                        break;
                    case 10: // ä¸“è¾‘
                        cover = item.picUrl || '';
                        title = item.name || 'æœªçŸ¥ä¸“è¾‘';
                        description = item.artist ? item.artist.name : 'æœªçŸ¥æ­Œæ‰‹';
                        break;
                    case 1000: // æ­Œå•
                        cover = item.coverImgUrl || '';
                        title = item.name || 'æœªçŸ¥æ­Œå•';
                        description = item.description || `åˆ›å»ºè€…: ${item.creator ? item.creator.nickname : 'æœªçŸ¥'}`;
                        break;
                    case 1002: // ç”¨æˆ·
                        cover = item.avatarUrl || '';
                        title = item.nickname || 'æœªçŸ¥ç”¨æˆ·';
                        description = `ç²‰ä¸: ${item.followeds || 0}`;
                        break;
                }
                
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid #ccc; cursor: pointer;" data-index="${index}">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 50px; height: 50px;">
                                ${cover ? 
                                    `<img src="${cover}" alt="${title}" style="width: 100%; height: 100%;" onerror="this.style.display='none'">` :
                                    'ğŸµ'
                                }
                            </div>
                            <div style="flex: 1;">
                                <div><strong>${title}</strong></div>
                                <div style="font-size: 0.9em; color: #666;">${description}</div>
                            </div>
                            ${duration ? `<div>${duration}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            searchResults.innerHTML = html;
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            const resultItems = searchResults.querySelectorAll('[data-index]');
            resultItems.forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    
                    // æ ¹æ®æœç´¢ç±»å‹å¤„ç†ç‚¹å‡»
                    if (currentSearchType === 1) {
                        // å•æ›²ï¼šæ’­æ”¾æ­Œæ›²
                        playTrack(index);
                    } else if (currentSearchType === 1000) {
                        // æ­Œå•ï¼šåŠ è½½æ­Œå•ä¸­çš„æ­Œæ›²
                        loadPlaylistTracks(index);
                    }
                });
            });
        }
        
        // æ’­æ”¾æŒ‡å®šæ­Œæ›²
        async function playTrack(index) {
            if (index < 0 || index >= currentSearchResults.length) return;
            
            const track = currentSearchResults[index];
            currentTrackIndex = index;
            
            console.log('æ’­æ”¾æ­Œæ›²:', track.name);
            
            // æ›´æ–°æ’­æ”¾ä¿¡æ¯
            currentTrack.textContent = track.name || 'æœªçŸ¥æ­Œæ›²';
            currentArtist.textContent = track.ar ? track.ar.map(artist => artist.name).join(', ') : 'æœªçŸ¥æ­Œæ‰‹';
            currentAlbum.textContent = track.al ? track.al.name : 'æœªçŸ¥ä¸“è¾‘';
            
            // æ›´æ–°ä¸“è¾‘å°é¢
            const cover = track.al && track.al.picUrl ? track.al.picUrl : '';
            if (cover) {
                albumArt.innerHTML = `<img src="${cover}" alt="ä¸“è¾‘å°é¢" style="width: 100px; height: 100px;">`;
            } else {
                albumArt.innerHTML = 'ğŸµ';
            }
            
            // è·å–æ­Œæ›²æ’­æ”¾é“¾æ¥
            await getSongUrl(track.id);
            
            // è·å–æ­Œè¯
            await getLyrics(track.id);
        }
        
        // è·å–æ­Œæ›²æ’­æ”¾é“¾æ¥
        async function getSongUrl(songId) {
            try {
                let url = `${API_BASE}/song/url?id=${songId}&timestamp=${Date.now()}`;
                
                // æ·»åŠ éšæœºä¸­å›½IPå‚æ•°ï¼ˆè§£å†³æµ·å¤–æœåŠ¡å™¨é™åˆ¶ï¼‰
                url += '&randomCNIP=true';
                
                if (currentCookie) {
                    url += `&cookie=${encodeURIComponent(currentCookie)}`;
                }
                
                console.log('è·å–æ’­æ”¾é“¾æ¥URL:', url);
                
                const res = await fetch(url);
                const data = await res.json();
                
                console.log('æ’­æ”¾é“¾æ¥æ•°æ®:', data);
                
                if (data.code === 200 && data.data && data.data.length > 0) {
                    const songUrl = data.data[0].url;
                    
                    if (songUrl) {
                        console.log('æ­Œæ›²æ’­æ”¾é“¾æ¥:', songUrl);
                        audioPlayer.src = songUrl;
                        audioPlayer.play().catch(error => {
                            console.error('æ’­æ”¾å¤±è´¥:', error);
                            alert('æ— æ³•æ’­æ”¾æ­¤æ­Œæ›²ï¼Œå¯èƒ½ç”±äºç‰ˆæƒé™åˆ¶æˆ–åœ°åŒºé™åˆ¶');
                        });
                    } else {
                        alert('æ— æ³•è·å–æ­Œæ›²æ’­æ”¾é“¾æ¥ï¼Œå¯èƒ½ç”±äºç‰ˆæƒé™åˆ¶');
                    }
                } else {
                    alert('è·å–æ’­æ”¾é“¾æ¥å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–æ’­æ”¾é“¾æ¥å¤±è´¥:', error);
                alert('è·å–æ’­æ”¾é“¾æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // è·å–æ­Œè¯
        async function getLyrics(songId) {
            try {
                let url = `${API_BASE}/lyric?id=${songId}&timestamp=${Date.now()}`;
                
                if (currentCookie) {
                    url += `&cookie=${encodeURIComponent(currentCookie)}`;
                }
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.code === 200) {
                    currentLyrics = [];
                    currentLyricIndex = 0;
                    
                    if (data.lrc && data.lrc.lyric) {
                        // è§£ææ­Œè¯
                        currentLyrics = parseLyrics(data.lrc.lyric);
                    }
                    
                    renderLyrics();
                } else {
                    currentLyrics = [];
                    renderLyrics();
                }
            } catch (error) {
                console.error('è·å–æ­Œè¯å¤±è´¥:', error);
                currentLyrics = [];
                renderLyrics();
            }
        }
        
        // è§£ææ­Œè¯
        function parseLyrics(lyricText) {
            const lines = lyricText.split('\n');
            const lyrics = [];
            
            lines.forEach(line => {
                // åŒ¹é…æ—¶é—´æˆ³å’Œæ­Œè¯å†…å®¹
                const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const milliseconds = parseInt(match[3].padEnd(3, '0'));
                    const time = minutes * 60 + seconds + milliseconds / 1000;
                    const text = match[4].trim();
                    
                    if (text) {
                        lyrics.push({
                            time: time,
                            text: text
                        });
                    }
                }
            });
            
            return lyrics;
        }
        
        // æ¸²æŸ“æ­Œè¯
        function renderLyrics() {
            if (currentLyrics.length === 0) {
                lyricsContainer.innerHTML = '<div>æš‚æ— æ­Œè¯</div>';
                return;
            }
            
            let html = '';
            currentLyrics.forEach((lyric, index) => {
                html += `<div data-index="${index}">${lyric.text}</div>`;
            });
            
            lyricsContainer.innerHTML = html;
            
            // æ»šåŠ¨åˆ°å½“å‰æ­Œè¯ä½ç½®
            updateCurrentLyric();
        }
        
        // æ›´æ–°å½“å‰æ­Œè¯
        function updateCurrentLyric() {
            const currentTime = audioPlayer.currentTime;
            
            // æ‰¾åˆ°å½“å‰åº”è¯¥æ˜¾ç¤ºçš„æ­Œè¯
            let newIndex = -1;
            for (let i = currentLyrics.length - 1; i >= 0; i--) {
                if (currentTime >= currentLyrics[i].time) {
                    newIndex = i;
                    break;
                }
            }
            
            if (newIndex !== currentLyricIndex) {
                // ç§»é™¤ä¹‹å‰çš„æ¿€æ´»çŠ¶æ€
                const oldLine = lyricsContainer.querySelector(`[data-index="${currentLyricIndex}"]`);
                if (oldLine) {
                    oldLine.style.fontWeight = 'normal';
                    oldLine.style.color = '#000';
                }
                
                // æ·»åŠ æ–°çš„æ¿€æ´»çŠ¶æ€
                const newLine = lyricsContainer.querySelector(`[data-index="${newIndex}"]`);
                if (newLine) {
                    newLine.style.fontWeight = 'bold';
                    newLine.style.color = '#e60026';
                    
                    // æ»šåŠ¨åˆ°æ¿€æ´»çš„æ­Œè¯
                    newLine.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                }
                
                currentLyricIndex = newIndex;
            }
        }
        
        // åŠ è½½æ­Œå•ä¸­çš„æ­Œæ›²
        async function loadPlaylistTracks(playlistIndex) {
            const playlist = currentSearchResults[playlistIndex];
            if (!playlist || !playlist.id) return;
            
            try {
                searchResults.innerHTML = '<div>æ­£åœ¨åŠ è½½æ­Œå•...</div>';
                
                let url = `${API_BASE}/playlist/detail?id=${playlist.id}&timestamp=${Date.now()}`;
                
                if (currentCookie) {
                    url += `&cookie=${encodeURIComponent(currentCookie)}`;
                }
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.code === 200 && data.playlist && data.playlist.tracks) {
                    currentSearchResults = data.playlist.tracks;
                    currentSearchType = 1; // åˆ‡æ¢åˆ°å•æ›²æ¨¡å¼
                    
                    // æ›´æ–°æœç´¢ç±»å‹æŒ‰é’®çŠ¶æ€
                    searchTypeBtns.forEach(btn => {
                        if (parseInt(btn.dataset.type) === 1) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    
                    renderSearchResults();
                } else {
                    throw new Error('åŠ è½½æ­Œå•å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½æ­Œå•å¤±è´¥:', error);
                searchResults.innerHTML = `<div>åŠ è½½æ­Œå•å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ’­æ”¾/æš‚åœåˆ‡æ¢
        function togglePlay() {
            if (audioPlayer.src) {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            }
        }
        
        // ä¸Šä¸€é¦–
        function playPrev() {
            if (currentSearchResults.length === 0) return;
            
            let newIndex = currentTrackIndex - 1;
            if (newIndex < 0) newIndex = currentSearchResults.length - 1;
            
            playTrack(newIndex);
        }
        
        // ä¸‹ä¸€é¦–
        function playNext() {
            if (currentSearchResults.length === 0) return;
            
            let newIndex = currentTrackIndex + 1;
            if (newIndex >= currentSearchResults.length) newIndex = 0;
            
            playTrack(newIndex);
        }
        
        // æ›´æ–°æ’­æ”¾è¿›åº¦
        function updateProgress() {
            if (audioPlayer.duration) {
                const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                if (progress) {
                    progress.style.width = `${progressPercent}%`;
                }
                
                if (currentTimeEl) {
                    currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                }
                
                // æ›´æ–°æ­Œè¯
                updateCurrentLyric();
            }
        }
        
  
