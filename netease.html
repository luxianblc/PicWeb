
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘æ˜“äº‘éŸ³ä¹ - æ­£å¼ç‰ˆ</title>
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- ç»„ä»¶åŠ è½½å™¨ -->
    <script type="module" src="load-components.js"></script>
    
    <!-- ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸµ</text></svg>">
    
    <style>
        /* éŸ³ä¹æ’­æ”¾å™¨å®¹å™¨ */
        .music-player-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .player-card {
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .player-controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }
        
        .album-art {
            width: 160px;
            height: 160px;
            border-radius: 15px;
            overflow: hidden;
            background: rgba(230, 0, 38, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #e60026;
            flex-shrink: 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .track-info {
            flex: 1;
        }
        
        .track-info h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: white;
        }
        
        .track-info p {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .track-meta {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 1.5rem 0;
            overflow: hidden;
            cursor: pointer;
        }
        
        .progress {
            width: 0%;
            height: 100%;
            border-radius: 3px;
            transition: width 0.1s linear;
            background: linear-gradient(90deg, #e60026, #ff2d55);
        }
        
        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        .control-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
        }
        
        .control-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            transform: scale(1.05);
            background: rgba(230, 0, 38, 0.2);
        }
        
        .play-btn {
            width: 70px;
            height: 70px;
            font-size: 1.8rem;
            background: linear-gradient(135deg, #e60026, #ff2d55);
            border: none;
        }
        
        .play-btn:hover {
            box-shadow: 0 0 30px rgba(230, 0, 38, 0.3);
        }
        
        /* éŸ³é‡æ§åˆ¶ */
        .volume-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .volume-slider {
            flex: 1;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            background: #e60026;
        }
        
        /* åŠŸèƒ½å¡ç‰‡ */
        .function-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin: 3rem 0;
        }
        
        .function-card {
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .function-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.5rem;
        }
        
        .function-header h3 {
            font-size: 1.5rem;
            color: white;
        }
        
        .function-header i {
            color: #e60026;
            font-size: 1.3rem;
        }
        
        /* æ­Œæ›²åˆ—è¡¨ */
        .song-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 1.5rem 0;
        }
        
        .song-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .song-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .song-item.active {
            background: rgba(230, 0, 38, 0.15);
            border-left: 4px solid #e60026;
        }
        
        .song-cover {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
            background: rgba(230, 0, 38, 0.1);
        }
        
        .song-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .song-info {
            flex: 1;
            min-width: 0;
        }
        
        .song-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-artist {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-duration {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            flex-shrink: 0;
        }
        
        /* è¾“å…¥æ¡†æ ·å¼ */
        .input-group {
            margin-bottom: 1.5rem;
        }
        
        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .input-field {
            width: 100%;
            padding: 0.9rem 1.2rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #e60026;
            box-shadow: 0 0 0 2px rgba(230, 0, 38, 0.1);
        }
        
        /* æŒ‰é’®ç»„ */
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.9rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e60026, #ff2d55);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(230, 0, 38, 0.3);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-card h4 {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }
        
        .status-card .value.online {
            color: #28a745;
        }
        
        .status-card .value.offline {
            color: #dc3545;
        }
        
        /* æœç´¢å’Œæ¨èåŒºåŸŸ */
        .search-results {
            display: none;
        }
        
        .recommendations {
            display: block;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #e60026;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ç½‘æ˜“äº‘ä¸»é¢˜é¢œè‰² */
        .netease-theme {
            --primary-color: #e60026;
            --secondary-color: #ff2d55;
        }
        
        /* è¿”å›æŒ‰é’® */
        .back-to-home {
            margin-bottom: 2rem;
        }
        
        .back-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* åŠ¨ç”»æ•ˆæœ */
        body {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .main-content {
            opacity: 1;
            animation: slideInUp 0.6s ease 0.3s both;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .player-info {
                flex-direction: column;
                text-align: center;
            }
            
            .album-art {
                width: 180px;
                height: 180px;
            }
            
            .control-buttons {
                gap: 1rem;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
            }
            
            .play-btn {
                width: 60px;
                height: 60px;
            }
            
            .function-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .track-info h2 {
                font-size: 1.5rem;
            }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* å·¥å…·æç¤º */
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            pointer-events: none;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="netease-theme">
    <!-- é¡µçœ‰å°†ç”±load-components.jsåŠ¨æ€æ’å…¥ -->
    
    <main class="main-content">
        <div class="container">
            <div class="back-to-home">
                <a href="music.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i> è¿”å›éŸ³ä¹ä¸»é¡µ
                </a>
            </div>
            
            <div class="page-title">
                <h1><i class="fas fa-music" style="color: #e60026;"></i> ç½‘æ˜“äº‘éŸ³ä¹æ­£å¼ç‰ˆ</h1>
                <p>åƒä¸‡æ›²åº“ï¼Œéšæ—¶éšåœ°ï¼Œå‘ç°éŸ³ä¹ä¹‹ç¾</p>
            </div>

            <div class="music-player-container">
                <!-- ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨ -->
                <div class="glass player-card">
                    <div class="player-controls">
                        <div class="player-info">
                            <div class="album-art" id="albumArt">
                                <i class="fas fa-music"></i>
                            </div>
                            <div class="track-info">
                                <h2 id="trackTitle">é€‰æ‹©ä¸€é¦–æ­Œæ›²å¼€å§‹æ’­æ”¾</h2>
                                <p id="trackArtist">-</p>
                                
                                <div class="track-meta">
                                    <span id="trackAlbum">ä¸“è¾‘ï¼š-</span>
                                    <span id="trackDuration">æ—¶é•¿ï¼š-</span>
                                    <span id="trackQuality">éŸ³è´¨ï¼š-</span>
                                </div>
                                
                                <div class="time-info">
                                    <span id="currentTime">0:00</span>
                                    <span id="totalTime">0:00</span>
                                </div>
                                <div class="progress-bar" id="progressBar">
                                    <div class="progress" id="progress"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="control-btn" id="prevBtn" title="ä¸Šä¸€é¦–">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button class="control-btn play-btn" id="playBtn" title="æ’­æ”¾/æš‚åœ">
                                <i class="fas fa-play" id="playIcon"></i>
                            </button>
                            <button class="control-btn" id="nextBtn" title="ä¸‹ä¸€é¦–">
                                <i class="fas fa-step-forward"></i>
                            </button>
                            <button class="control-btn" id="likeBtn" title="å–œæ¬¢">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                        
                        <div class="volume-control">
                            <i class="fas fa-volume-up" style="color: #e60026;"></i>
                            <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
                            <span id="volumePercent" style="color: rgba(255, 255, 255, 0.7);">50%</span>
                        </div>
                    </div>
                </div>

                <!-- åŠŸèƒ½åŒºåŸŸ -->
                <div class="function-grid">
                    <!-- æœç´¢åŠŸèƒ½ -->
                    <div class="glass function-card">
                        <div class="function-header">
                            <i class="fas fa-search"></i>
                            <h3>æœç´¢éŸ³ä¹</h3>
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">æ­Œæ›²åã€æ­Œæ‰‹æˆ–ä¸“è¾‘</label>
                            <input type="text" class="input-field" id="searchInput" placeholder="ä¾‹å¦‚ï¼šå‘¨æ°ä¼¦ æ™´å¤©" value="å‘¨æ°ä¼¦">
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="searchMusic()">
                                <i class="fas fa-search"></i> æœç´¢éŸ³ä¹
                            </button>
                            <button class="btn btn-secondary" onclick="getRecommendations()">
                                <i class="fas fa-fire"></i> çƒ­é—¨æ¨è
                            </button>
                        </div>
                        
                        <div class="search-results" id="searchResults">
                            <h4 style="margin-bottom: 1rem; color: #e60026;">æœç´¢ç»“æœ</h4>
                            <div class="song-list" id="searchResultsList">
                                <!-- æœç´¢ç»“æœå°†åŠ¨æ€æ’å…¥ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ¨èåŠŸèƒ½ -->
                    <div class="glass function-card">
                        <div class="function-header">
                            <i class="fas fa-star"></i>
                            <h3>æ¯æ—¥æ¨è</h3>
                        </div>
                        
                        <div class="recommendations" id="recommendations">
                            <div class="song-list" id="recommendationsList">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="getPersonalized()">
                                <i class="fas fa-user-check"></i> ä¸ªæ€§åŒ–æ¨è
                            </button>
                            <button class="btn btn-secondary" onclick="getTopList()">
                                <i class="fas fa-chart-line"></i> æ’è¡Œæ¦œ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- è´¦æˆ·çŠ¶æ€ -->
                <div class="glass function-card">
                    <div class="function-header">
                        <i class="fas fa-user-circle"></i>
                        <h3>è´¦æˆ·çŠ¶æ€</h3>
                    </div>
                    
                    <div class="status-grid">
                        <div class="status-card">
                            <h4>ç™»å½•çŠ¶æ€</h4>
                            <div class="value" id="loginStatus">æœªç™»å½•</div>
                        </div>
                        <div class="status-card">
                            <h4>éŸ³è´¨æƒé™</h4>
                            <div class="value" id="qualityStatus">æ ‡å‡†éŸ³è´¨</div>
                        </div>
                        <div class="status-card">
                            <h4>APIçŠ¶æ€</h4>
                            <div class="value online" id="apiStatus">æ­£å¸¸</div>
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showLoginModal()">
                            <i class="fas fa-sign-in-alt"></i> ç«‹å³ç™»å½•
                        </button>
                        <button class="btn btn-secondary" onclick="checkLoginStatus()">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°çŠ¶æ€
                        </button>
                        <button class="btn btn-secondary" onclick="openQRLogin()">
                            <i class="fas fa-qrcode"></i> æ‰«ç ç™»å½•
                        </button>
                    </div>
                </div>
                
                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div class="glass card mt-3 text-center">
                    <h3><i class="fas fa-info-circle"></i> ç½‘æ˜“äº‘éŸ³ä¹ä½¿ç”¨è¯´æ˜</h3>
                    <p style="color: rgba(255, 255, 255, 0.7); margin-top: 1rem; line-height: 1.8;">
                        1. æœç´¢æ­Œæ›²æˆ–ä½¿ç”¨æ¨èåˆ—è¡¨å¼€å§‹æ’­æ”¾éŸ³ä¹<br>
                        2. ç™»å½•åå¯äº«å—æ›´é«˜éŸ³è´¨å’Œä¸ªæ€§åŒ–æ¨è<br>
                        3. ä½¿ç”¨æ§åˆ¶æŒ‰é’®åˆ‡æ¢æ­Œæ›²å’Œè°ƒæ•´éŸ³é‡<br>
                        4. è¿›åº¦æ¡å¯ä»¥æ‹–æ‹½ä»¥è·³è½¬åˆ°æŒ‡å®šä½ç½®<br>
                        5. éŸ³ä¹ä»…ä¾›ä¸ªäººæ¬£èµï¼Œè¯·æ”¯æŒæ­£ç‰ˆéŸ³ä¹
                    </p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- é¡µè„šå°†ç”±load-components.jsåŠ¨æ€æ’å…¥ -->

    <script>
        // ç­‰å¾…ç»„ä»¶åŠ è½½å®Œæˆåå†åˆå§‹åŒ–æ’­æ”¾å™¨
        document.addEventListener('componentsLoaded', function() {
            console.log('ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–...');
            initNeteasePlayer();
            console.log('ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ');
        });
        
        // ç½‘æ˜“äº‘éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–
        function initNeteasePlayer() {
            // å…¨å±€å˜é‡
            let API_BASE = 'https://neteaseapi-enhanced.vercel.app';
            let currentAudio = new Audio();
            let currentTrackIndex = 0;
            let isPlaying = false;
            let currentPlaylist = [];
            let userCookie = null;
            let currentSongData = null;
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®
            const savedApiBase = localStorage.getItem('netease_api_base');
            if (savedApiBase) {
                API_BASE = savedApiBase;
            }
            
            const savedCookie = localStorage.getItem('netease_cookie');
            if (savedCookie) {
                userCookie = savedCookie;
                updateLoginStatus();
            }
            
            // DOMå…ƒç´ 
            const albumArt = document.getElementById('albumArt');
            const trackTitle = document.getElementById('trackTitle');
            const trackArtist = document.getElementById('trackArtist');
            const trackAlbum = document.getElementById('trackAlbum');
            const trackDuration = document.getElementById('trackDuration');
            const trackQuality = document.getElementById('trackQuality');
            const progress = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            const currentTimeEl = document.getElementById('currentTime');
            const totalTimeEl = document.getElementById('totalTime');
            const playBtn = document.getElementById('playBtn');
            const playIcon = document.getElementById('playIcon');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const likeBtn = document.getElementById('likeBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            const volumePercent = document.getElementById('volumePercent');
            
            // å·¥å…·å‡½æ•°
            function buildApiUrl(endpoint, params = {}) {
                const baseParams = {
                    timestamp: Date.now(),
                    randomCNIP: true
                };
                
                const allParams = { ...baseParams, ...params };
                const queryString = new URLSearchParams(allParams).toString();
                
                return `${API_BASE}${endpoint}?${queryString}`;
            }
            
            function formatTime(milliseconds) {
                if (!milliseconds || isNaN(milliseconds)) return "0:00";
                const seconds = Math.floor(milliseconds / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            function getQualityText(level) {
                const qualityMap = {
                    'standard': 'æ ‡å‡†',
                    'higher': 'è¾ƒé«˜',
                    'exhigh': 'æé«˜',
                    'lossless': 'æ— æŸ',
                    'hires': 'Hi-Res'
                };
                return qualityMap[level] || level;
            }
            
            // æ›´æ–°ç™»å½•çŠ¶æ€æ˜¾ç¤º
            function updateLoginStatus() {
                if (userCookie) {
                    document.getElementById('loginStatus').textContent = 'å·²ç™»å½•';
                    document.getElementById('loginStatus').className = 'value online';
                    document.getElementById('qualityStatus').textContent = 'é«˜è´¨é‡éŸ³è´¨';
                } else {
                    document.getElementById('loginStatus').textContent = 'æœªç™»å½•';
                    document.getElementById('loginStatus').className = 'value offline';
                    document.getElementById('qualityStatus').textContent = 'æ ‡å‡†éŸ³è´¨';
                }
            }
            
            // æ£€æŸ¥APIçŠ¶æ€
            async function checkAPIStatus() {
                try {
                    const url = buildApiUrl('/login/status');
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        document.getElementById('apiStatus').textContent = 'æ­£å¸¸';
                        document.getElementById('apiStatus').className = 'value online';
                    } else {
                        document.getElementById('apiStatus').textContent = 'å¼‚å¸¸';
                        document.getElementById('apiStatus').className = 'value offline';
                    }
                } catch (error) {
                    document.getElementById('apiStatus').textContent = 'å¤±è´¥';
                    document.getElementById('apiStatus').className = 'value offline';
                }
            }
            
            // æœç´¢éŸ³ä¹
            async function searchMusic() {
                const searchInput = document.getElementById('searchInput');
                const keywords = searchInput.value.trim();
                
                if (!keywords) {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                    return;
                }
                
                const resultsDiv = document.getElementById('searchResults');
                const resultsList = document.getElementById('searchResultsList');
                resultsList.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
                resultsDiv.style.display = 'block';
                
                try {
                    const params = {
                        keywords: encodeURIComponent(keywords),
                        type: 1, // å•æ›²
                        limit: 20,
                        offset: 0
                    };
                    
                    if (userCookie) params.cookie = userCookie;
                    
                    const url = buildApiUrl('/cloudsearch', params);
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.code === 200 && data.result.songs) {
                        displaySearchResults(data.result.songs);
                    } else {
                        resultsList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 2rem;">æœç´¢å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</div>';
                    }
                } catch (error) {
                    resultsList.innerHTML = '<div style="color: #dc3545; text-align: center; padding: 2rem;">ç½‘ç»œé”™è¯¯ï¼š' + error.message + '</div>';
                }
            }
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            function displaySearchResults(songs) {
                const resultsList = document.getElementById('searchResultsList');
                currentPlaylist = songs;
                
                let html = '';
                
                songs.forEach((song, index) => {
                    const artists = song.ar ? song.ar.map(artist => artist.name).join(', ') : 'æœªçŸ¥';
                    const album = song.al ? song.al.name : 'æœªçŸ¥';
                    const cover = song.al ? song.al.picUrl : '';
                    const duration = formatTime(song.dt);
                    
                    html += `
                        <div class="song-item" onclick="window.playSearchResult(${index})" data-id="${song.id}">
                            <div class="song-cover">
                                ${cover ? `<img src="${cover}?param=60y60" alt="${song.name}">` : 
                                          `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><i class="fas fa-music"></i></div>`}
                            </div>
                            <div class="song-info">
                                <div class="song-title">${song.name}</div>
                                <div class="song-artist">${artists} - ${album}</div>
                            </div>
                            <div class="song-duration">${duration}</div>
                        </div>
                    `;
                });
                
                resultsList.innerHTML = html;
            }
            
            // æ’­æ”¾æœç´¢ç»“æœ
            async function playSearchResult(index) {
                const song = currentPlaylist[index];
                
                // æ›´æ–°é«˜äº®
                document.querySelectorAll('#searchResultsList .song-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.currentTarget.classList.add('active');
                
                // æ›´æ–°æ’­æ”¾å™¨æ˜¾ç¤º
                trackTitle.textContent = song.name;
                trackArtist.textContent = song.ar ? song.ar.map(artist => artist.name).join(', ') : 'æœªçŸ¥';
                trackAlbum.textContent = 'ä¸“è¾‘ï¼š' + (song.al ? song.al.name : 'æœªçŸ¥');
                trackDuration.textContent = 'æ—¶é•¿ï¼š' + formatTime(song.dt);
                
                // æ›´æ–°ä¸“è¾‘å°é¢
                if (song.al && song.al.picUrl) {
                    albumArt.innerHTML = `<img src="${song.al.picUrl}?param=160y160" alt="${song.name}">`;
                } else {
                    albumArt.innerHTML = '<i class="fas fa-music"></i>';
                }
                
                // è·å–æ’­æ”¾é“¾æ¥
                try {
                    const params = {
                        id: song.id,
                        level: userCookie ? 'exhigh' : 'standard'
                    };
                    
                    if (userCookie) params.cookie = userCookie;
                    
                    const url = buildApiUrl('/song/url/v1', params);
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.code === 200 && data.data && data.data[0].url) {
                        const songData = data.data[0];
                        trackQuality.textContent = 'éŸ³è´¨ï¼š' + getQualityText(songData.level);
                        
                        // æ’­æ”¾
                        currentAudio.src = songData.url;
                        currentAudio.play().then(() => {
                            isPlaying = true;
                            playIcon.className = 'fas fa-pause';
                            currentSongData = song;
                            currentTrackIndex = index;
                        });
                    } else {
                        alert('æ— æ³•æ’­æ”¾æ­¤æ­Œæ›²ï¼š' + (data.message || 'æ— ç‰ˆæƒæˆ–VIPä¸“äº«'));
                    }
                } catch (error) {
                    alert('æ’­æ”¾å¤±è´¥ï¼š' + error.message);
                }
            }
            
            // è·å–æ¨èéŸ³ä¹
            async function getRecommendations() {
                const recList = document.getElementById('recommendationsList');
                recList.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
                
                try {
                    const params = {};
                    if (userCookie) params.cookie = userCookie;
                    
                    const url = buildApiUrl('/personalized/newsong', params);
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.code === 200 && data.result) {
                        displayRecommendations(data.result.slice(0, 10));
                    } else {
                        getDefaultRecommendations();
                    }
                } catch (error) {
                    getDefaultRecommendations();
                }
            }
            
            // æ˜¾ç¤ºæ¨èéŸ³ä¹
            function displayRecommendations(songs) {
                const recList = document.getElementById('recommendationsList');
                
                let html = '';
                
                songs.forEach((song, index) => {
                    const cover = song.picUrl || (song.song && song.song.al && song.song.al.picUrl) || '';
                    const songName = song.name || (song.song && song.song.name) || 'æœªçŸ¥æ­Œæ›²';
                    const artist = song.song && song.song.ar ? song.song.ar.map(a => a.name).join(', ') : 'æœªçŸ¥æ­Œæ‰‹';
                    const songId = song.id || (song.song && song.song.id);
                    
                    html += `
                        <div class="song-item" onclick="window.playRecommendation(${songId})">
                            <div class="song-cover">
                                ${cover ? `<img src="${cover}?param=60y60" alt="${songName}">` : 
                                          `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><i class="fas fa-music"></i></div>`}
                            </div>
                            <div class="song-info">
                                <div class="song-title">${songName}</div>
                                <div class="song-artist">${artist}</div>
                            </div>
                        </div>
                    `;
                });
                
                recList.innerHTML = html;
            }
            
            // é»˜è®¤æ¨èåˆ—è¡¨ï¼ˆå¤‡ç”¨ï¼‰
            function getDefaultRecommendations() {
                const recList = document.getElementById('recommendationsList');
                
                const defaultSongs = [
                    { id: 33894312, name: "èµ·é£äº†", artist: "ä¹°è¾£æ¤’ä¹Ÿç”¨åˆ¸" },
                    { id: 1330348068, name: "æ²ˆå›­å¤–", artist: "é˜¿YueYue,æˆ¾æ ¼,å°ç”°éŸ³ä¹ç¤¾" },
                    { id: 1441758494, name: "å¦‚æ„¿", artist: "ç‹è²" },
                    { id: 1901371647, name: "é›ª Distance", artist: "Capper,ç½—è¨€RollFlash" },
                    { id: 1974443814, name: "æˆ‘ä¼šç­‰", artist: "æ‰¿æ¡“" },
                    { id: 202373, name: "æ™´å¤©", artist: "å‘¨æ°ä¼¦" },
                    { id: 65528, name: "æ±Ÿå—", artist: "æ—ä¿Šæ°" },
                    { id: 108478, name: "æ³¡æ²«", artist: "G.E.M.é‚“ç´«æ£‹" }
                ];
                
                let html = '';
                
                defaultSongs.forEach((song, index) => {
                    html += `
                        <div class="song-item" onclick="window.playSongById(${song.id})">
                            <div class="song-cover">
                                <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><i class="fas fa-music"></i></div>
                            </div>
                            <div class="song-info">
                                <div class="song-title">${song.name}</div>
                                <div class="song-artist">${song.artist}</div>
                            </div>
                        </div>
                    `;
                });
                
                recList.innerHTML = html;
            }
            
            // é€šè¿‡IDæ’­æ”¾æ­Œæ›²
            async function playSongById(songId) {
                try {
                    // è·å–æ­Œæ›²è¯¦æƒ…
                    const songUrl = buildApiUrl('/song/detail', { ids: songId });
                    const songResponse = await fetch(songUrl);
                    const songData = await songResponse.json();
                    
                    if (songData.code === 200 && songData.songs[0]) {
                        const song = songData.songs[0];
                        
                        // æ›´æ–°æ’­æ”¾å™¨æ˜¾ç¤º
                        trackTitle.textContent = song.name;
                        trackArtist.textContent = song.ar ? song.ar.map(artist => artist.name).join(', ') : 'æœªçŸ¥';
                        trackAlbum.textContent = 'ä¸“è¾‘ï¼š' + (song.al ? song.al.name : 'æœªçŸ¥');
                        trackDuration.textContent = 'æ—¶é•¿ï¼š' + formatTime(song.dt);
                        
                        // æ›´æ–°ä¸“è¾‘å°é¢
                        if (song.al && song.al.picUrl) {
                            albumArt.innerHTML = `<img src="${song.al.picUrl}?param=160y160" alt="${song.name}">`;
                        } else {
                            albumArt.innerHTML = '<i class="fas fa-music"></i>';
                        }
                        
                        // è·å–æ’­æ”¾é“¾æ¥
                        const params = {
                            id: songId,
                            level: userCookie ? 'exhigh' : 'standard'
                        };
                        
                        if (userCookie) params.cookie = userCookie;
                        
                        const url = buildApiUrl('/song/url/v1', params);
                        const response = await fetch(url);
                        const data = await response.json();
                        
                        if (data.code === 200 && data.data && data.data[0].url) {
                            const audioData = data.data[0];
                            trackQuality.textContent = 'éŸ³è´¨ï¼š' + getQualityText(audioData.level);
                            
                            // æ’­æ”¾
                            currentAudio.src = audioData.url;
                            currentAudio.play().then(() => {
                                isPlaying = true;
                                playIcon.className = 'fas fa-pause';
                                currentSongData = song;
                            });
                        }
                    }
                } catch (error) {
                    alert('æ’­æ”¾å¤±è´¥ï¼š' + error.message);
                }
            }
            
            // æ’­æ”¾æ¨èæ­Œæ›²
            async function playRecommendation(songId) {
                await playSongById(songId);
            }
            
            // æ’­æ”¾/æš‚åœ
            function togglePlay() {
                if (!currentAudio.src) {
                    // å¦‚æœæ²¡æœ‰æ­Œæ›²ï¼Œæ’­æ”¾ç¬¬ä¸€é¦–æ¨è
                    const firstSong = document.querySelector('#recommendationsList .song-item');
                    if (firstSong) {
                        const onclickAttr = firstSong.getAttribute('onclick');
                        const match = onclickAttr.match(/play(?:SongById|Recommendation)\((\d+)\)/);
                        if (match) {
                            playSongById(match[1]);
                        }
                    }
                    return;
                }
                
                if (isPlaying) {
                    currentAudio.pause();
                    playIcon.className = 'fas fa-play';
                } else {
                    currentAudio.play().then(() => {
                        playIcon.className = 'fas fa-pause';
                    });
                }
                isPlaying = !isPlaying;
            }
            
            // æ’­æ”¾ä¸Šä¸€é¦–
            function playPrev() {
                if (currentPlaylist.length === 0) return;
                
                currentTrackIndex--;
                if (currentTrackIndex < 0) {
                    currentTrackIndex = currentPlaylist.length - 1;
                }
                
                const song = currentPlaylist[currentTrackIndex];
                if (song && song.id) {
                    playSongById(song.id);
                }
            }
            
            // æ’­æ”¾ä¸‹ä¸€é¦–
            function playNext() {
                if (currentPlaylist.length === 0) return;
                
                currentTrackIndex++;
                if (currentTrackIndex >= currentPlaylist.length) {
                    currentTrackIndex = 0;
                }
                
                const song = currentPlaylist[currentTrackIndex];
                if (song && song.id) {
                    playSongById(song.id);
                }
            }
            
            // åˆ‡æ¢å–œæ¬¢çŠ¶æ€
            function toggleLike() {
                if (likeBtn.querySelector('.fas.fa-heart')) {
                    likeBtn.innerHTML = '<i class="far fa-heart"></i>';
                } else {
                    likeBtn.innerHTML = '<i class="fas fa-heart" style="color: #e60026;"></i>';
                }
            }
            
            // æ›´æ–°è¿›åº¦æ¡
            function updateProgress() {
                if (!currentAudio.duration) return;
                
                const progressPercent = (currentAudio.currentTime / currentAudio.duration) * 100;
                progress.style.width = progressPercent + '%';
                currentTimeEl.textContent = formatTime(currentAudio.currentTime * 1000);
            }
            
            // è·³è½¬åˆ°æŒ‡å®šæ’­æ”¾ä½ç½®
            function seekToPosition(e) {
                if (!currentAudio.duration) return;
                
                const progressBarWidth = progressBar.clientWidth;
                const clickPosition = e.offsetX;
                const duration = currentAudio.duration;
                const seekTime = (clickPosition / progressBarWidth) * duration;
                
                currentAudio.currentTime = seekTime;
                progress.style.width = `${(clickPosition / progressBarWidth) * 100}%`;
            }
            
            // è®¾ç½®éŸ³é‡
            function setVolume(value) {
                const volume = value / 100;
                currentAudio.volume = volume;
                volumePercent.textContent = `${value}%`;
            }
            
            // äº‹ä»¶ç›‘å¬å™¨
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', playPrev);
            nextBtn.addEventListener('click', playNext);
            likeBtn.addEventListener('click', toggleLike);
            
            volumeSlider.addEventListener('input', function() {
                setVolume(this.value);
            });
            
            progressBar.addEventListener('click', function(e) {
                seekToPosition(e);
            });
            
            // éŸ³é¢‘äº‹ä»¶ç›‘å¬
            currentAudio.addEventListener('timeupdate', updateProgress);
            currentAudio.addEventListener('loadedmetadata', function() {
                totalTimeEl.textContent = formatTime(currentAudio.duration * 1000);
            });
            currentAudio.addEventListener('ended', function() {
                isPlaying = false;
                playIcon.className = 'fas fa-play';
                // æ’­æ”¾ä¸‹ä¸€é¦–
                setTimeout(() => {
                    playNext();
                }, 1000);
            });
            
            // æ‹–æ‹½è¿›åº¦æ¡
            progressBar.addEventListener('mousedown', function(e) {
                const isSeeking = true;
                seekToPosition(e);
                
                const mouseMoveHandler = function(e) {
                    if (!isSeeking) return;
                    const rect = progressBar.getBoundingClientRect();
                    const offsetX = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                    const progressPercent = (offsetX / rect.width) * 100;
                    progress.style.width = `${progressPercent}%`;
                };
                
                const mouseUpHandler = function() {
                    if (currentAudio.duration) {
                        const rect = progressBar.getBoundingClientRect();
                        const offsetX = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
                        const seekTime = (offsetX / rect.width) * currentAudio.duration;
                        currentAudio.currentTime = seekTime;
                    }
                    document.removeEventListener('mousemove', mouseMoveHandler);
                    document.removeEventListener('mouseup', mouseUpHandler);
                };
                
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
            });
            
            // å…¬å¼€å‡½æ•°ä¾›å…¨å±€è°ƒç”¨
            window.playSearchResult = playSearchResult;
            window.playSongById = playSongById;
            window.playRecommendation = playRecommendation;
            window.searchMusic = searchMusic;
            window.getRecommendations = getRecommendations;
            window.getPersonalized = getPersonalized;
            window.getTopList = getTopList;
            window.showLoginModal = showLoginModal;
            window.checkLoginStatus = checkLoginStatus;
            window.openQRLogin = openQRLogin;
            
            // åˆå§‹åŒ–
            setVolume(volumeSlider.value);
            getRecommendations();
            checkAPIStatus();
            
            // å…¶ä»–åŠŸèƒ½å‡½æ•°
            async function getPersonalized() {
                if (!userCookie) {
                    alert('ä¸ªæ€§åŒ–æ¨èéœ€è¦ç™»å½•åä½¿ç”¨');
                    showLoginModal();
                    return;
                }
                
                try {
                    const url = buildApiUrl('/recommend/songs', { cookie: userCookie });
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.code === 200 && data.data.dailySongs) {
                        displayRecommendations(data.data.dailySongs.slice(0, 10));
                    } else {
                        getRecommendations();
                    }
                } catch (error) {
                    getRecommendations();
                }
            }
            
            async function getTopList() {
                try {
                    const url = buildApiUrl('/toplist');
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.code === 200 && data.list) {
                        // æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ’è¡Œæ¦œ
                        const listId = data.list[0]?.id;
                        if (listId) {
                            const listUrl = buildApiUrl('/playlist/detail', { id: listId });
                            const listResponse = await fetch(listUrl);
                            const listData = await listResponse.json();
                            
                            if (listData.code === 200 && listData.playlist.tracks) {
                                currentPlaylist = listData.playlist.tracks;
                                displaySearchResults(listData.playlist.tracks.slice(0, 10));
                                document.getElementById('searchResults').style.display = 'block';
                                document.getElementById('searchResults').querySelector('h4').textContent = data.list[0].name + ' æ’è¡Œæ¦œ';
                            }
                        }
                    }
                } catch (error) {
                    alert('è·å–æ’è¡Œæ¦œå¤±è´¥ï¼š' + error.message);
                }
            }
            
            function showLoginModal() {
                alert('ç™»å½•åŠŸèƒ½ï¼š\n1. è¯·ç‚¹å‡»"æ‰«ç ç™»å½•"æŒ‰é’®\n2. ä½¿ç”¨ç½‘æ˜“äº‘éŸ³ä¹APPæ‰«æäºŒç»´ç \n3. ç™»å½•åå³å¯äº«å—é«˜è´¨é‡éŸ³è´¨å’Œä¸ªæ€§åŒ–æ¨è');
            }
            
            async function checkLoginStatus() {
                if (!userCookie) {
                    alert('å½“å‰æœªç™»å½•');
                    return;
                }
                
                try {
                    const url = buildApiUrl('/login/status', { cookie: userCookie });
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.code === 200 && data.data.profile) {
                        alert(`ç™»å½•çŠ¶æ€æ­£å¸¸\nç”¨æˆ·: ${data.data.profile.nickname}\nVIP: ${data.data.profile.vipType ? 'æ˜¯' : 'å¦'}`);
                        updateLoginStatus();
                    } else {
                        alert('ç™»å½•çŠ¶æ€å·²è¿‡æœŸ');
                        localStorage.removeItem('netease_cookie');
                        userCookie = null;
                        updateLoginStatus();
                    }
                } catch (error) {
                    alert('æ£€æŸ¥å¤±è´¥ï¼š' + error.message);
                }
            }
            
            async function openQRLogin() {
                try {
                    // è·å–äºŒç»´ç key
                    const keyUrl = buildApiUrl('/login/qr/key');
                    const keyResponse = await fetch(keyUrl);
                    const keyData = await keyResponse.json();
                    
                    if (keyData.code !== 200) {
                        throw new Error('è·å–äºŒç»´ç å¤±è´¥');
                    }
                    
                    const qrKey = keyData.data.unikey;
                    
                    // ç”ŸæˆäºŒç»´ç 
                    const qrUrl = buildApiUrl('/login/qr/create', { 
                        key: qrKey, 
                        qrimg: true 
                    });
                    const qrResponse = await fetch(qrUrl);
                    const qrData = await qrResponse.json();
                    
                    if (qrData.code !== 200) {
                        throw new Error('ç”ŸæˆäºŒç»´ç å¤±è´¥');
                    }
                    
                    // æ˜¾ç¤ºäºŒç»´ç 
                    const qrWindow = window.open('', 'ç½‘æ˜“äº‘éŸ³ä¹æ‰«ç ç™»å½•', 'width=400,height=550');
                    qrWindow.document.write(`
                        <html>
                        <head>
                            <title>ç½‘æ˜“äº‘éŸ³ä¹ - æ‰«ç ç™»å½•</title>
                            <style>
                                body { 
                                    font-family: 'Inter', sans-serif; 
                                    padding: 20px; 
                                    text-align: center; 
                                    background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
                                    color: white;
                                    margin: 0;
                                }
                                .container { 
                                    max-width: 360px; 
                                    margin: 0 auto; 
                                    padding: 30px 20px; 
                                }
                                h3 { 
                                    color: #e60026; 
                                    margin-bottom: 20px; 
                                }
                                img { 
                                    max-width: 300px; 
                                    margin: 20px 0; 
                                    border-radius: 15px;
                                    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                                }
                                .status { 
                                    color: rgba(255,255,255,0.7); 
                                    margin: 15px 0; 
                                    font-size: 0.9rem;
                                }
                                .instructions {
                                    background: rgba(255,255,255,0.05);
                                    border-radius: 10px;
                                    padding: 15px;
                                    margin: 20px 0;
                                    font-size: 0.85rem;
                                    line-height: 1.6;
                                }
                                button {
                                    background: linear-gradient(135deg, #e60026, #ff2d55);
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    font-family: inherit;
                                    font-weight: 600;
                                    margin-top: 10px;
                                }
                                button:hover {
                                    transform: translateY(-2px);
                                    box-shadow: 0 5px 15px rgba(230,0,38,0.3);
                                }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <h3><i class="fas fa-music"></i> ç½‘æ˜“äº‘éŸ³ä¹æ‰«ç ç™»å½•</h3>
                                <img src="${qrData.data.qrimg}" alt="ç™»å½•äºŒç»´ç ">
                                <div class="instructions">
                                    1. æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹APP<br>
                                    2. ç‚¹å‡»å³ä¸Šè§’"æ‰«ä¸€æ‰«"<br>
                                    3. æ‰«æä¸Šæ–¹äºŒç»´ç ç™»å½•
                                </div>
                                <p class="status">è¯·ä½¿ç”¨ç½‘æ˜“äº‘éŸ³ä¹APPæ‰«ç ç™»å½•</p>
                                <p><small>æ‰«ç åè‡ªåŠ¨ç™»å½•ï¼Œçª—å£å°†è‡ªåŠ¨å…³é—­</small></p>
                                <button onclick="window.close()">å…³é—­çª—å£</button>
                            </div>
                        </body>
                        </html>
                    `);
                    
                    // è½®è¯¢ç™»å½•çŠ¶æ€
                    const checkInterval = setInterval(async () => {
                        try {
                            const checkUrl = buildApiUrl('/login/qr/check', { key: qrKey });
                            const checkResponse = await fetch(checkUrl);
                            const checkData = await checkResponse.json();
                            
                            if (checkData.code === 803) {
                                // ç™»å½•æˆåŠŸ
                                clearInterval(checkInterval);
                                userCookie = checkData.cookie;
                                localStorage.setItem('netease_cookie', userCookie);
                                qrWindow.close();
                                
                                updateLoginStatus();
                                alert('ç™»å½•æˆåŠŸï¼');
                                getRecommendations(); // åˆ·æ–°æ¨è
                            } else if (checkData.code === 800) {
                                clearInterval(checkInterval);
                                alert('äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°æ‰«æ');
                                qrWindow.close();
                            }
                        } catch (error) {
                            console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                        }
                    }, 2000);
                    
                } catch (error) {
                    alert('ç™»å½•å¤±è´¥ï¼š' + error.message);
                }
            }
        }
    </script>
</body>
</html>
