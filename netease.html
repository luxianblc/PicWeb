// 网易云音乐播放器初始化
function initNeteasePlayer() {
    // API 配置
    const API_BASE = 'https://neteaseapi-enhanced.vercel.app';
    let currentCookie = '';
    let currentPlaylist = [];
    let currentTrackIndex = 0;
    let qrKey = '';
    let qrCheckInterval = null;
    let isPlaying = false;

    // DOM 元素
    const qrLoginBtn = document.getElementById('qrLoginBtn');
    const guestLoginBtn = document.getElementById('guestLoginBtn');
    const qrcodeModal = document.getElementById('qrcodeModal');
    const qrcodeCanvas = document.getElementById('qrcodeCanvas');
    const qrcodeStatus = document.getElementById('qrcodeStatus');
    const closeQrModal = document.getElementById('closeQrModal');
    const statusMessage = document.getElementById('statusMessage');
    const loginSection = document.getElementById('loginSection');
    const playerSection = document.getElementById('playerSection');
    const loading = document.getElementById('loading');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const currentTrack = document.getElementById('currentTrack');
    const currentArtist = document.getElementById('currentArtist');
    const progressBar = document.getElementById('progressBar');
    const progress = document.getElementById('progress');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const playlistContainer = document.getElementById('playlistContainer');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const albumArt = document.getElementById('albumArt');

    // 初始化
    function init() {
        // 检查本地存储的cookie
        const savedCookie = localStorage.getItem('netease_cookie');
        if (savedCookie) {
            currentCookie = savedCookie;
            showStatus('检测到已保存的登录信息', 'success');
            setTimeout(() => {
                showPlayer();
                loadPlaylist();
            }, 1000);
        }

        // 绑定事件
        qrLoginBtn.addEventListener('click', startQrLogin);
        guestLoginBtn.addEventListener('click', guestLogin);
        closeQrModal.addEventListener('click', closeModal);
        playBtn.addEventListener('click', togglePlay);
        prevBtn.addEventListener('click', playPrev);
        nextBtn.addEventListener('click', playNext);
        loadMoreBtn.addEventListener('click', loadMoreTracks);
        progressBar.addEventListener('click', seekToPosition);
        
        // 点击弹窗外部关闭
        qrcodeModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // ESC键关闭弹窗
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && qrcodeModal.classList.contains('active')) {
                closeModal();
            }
        });
        
        // 检查登录状态
        checkLoginStatus();
    }

    // 检查登录状态
    async function checkLoginStatus() {
        const savedCookie = localStorage.getItem('netease_cookie');
        if (savedCookie) {
            try {
                const res = await fetch(`${API_BASE}/login/status?cookie=${encodeURIComponent(savedCookie)}`);
                const data = await res.json();
                
                if (data.code === 200 && data.data.profile) {
                    currentCookie = savedCookie;
                    showStatus(`欢迎回来，${data.data.profile.nickname}！`, 'success');
                    showPlayer();
                    loadPlaylist();
                } else {
                    // Cookie可能已过期
                    localStorage.removeItem('netease_cookie');
                    showStatus('登录信息已过期，请重新登录', 'info');
                }
            } catch (error) {
                console.error('检查登录状态失败:', error);
            }
        }
    }

    // 显示状态消息
    function showStatus(message, type = 'info') {
        statusMessage.className = 'status-message';
        statusMessage.classList.add(`status-${type}`);
        
        let icon = '';
        switch(type) {
            case 'success':
                icon = '<i class="fas fa-check-circle"></i>';
                break;
            case 'error':
                icon = '<i class="fas fa-exclamation-circle"></i>';
                break;
            case 'info':
                icon = '<i class="fas fa-info-circle"></i>';
                break;
        }
        
        statusMessage.innerHTML = `${icon}<span>${message}</span>`;
        statusMessage.classList.remove('hidden');
        
        // 5秒后自动隐藏
        setTimeout(() => {
            statusMessage.classList.add('hidden');
        }, 5000);
    }

    // 显示/隐藏加载动画
    function showLoading(show) {
        if (show) {
            loading.classList.remove('hidden');
        } else {
            loading.classList.add('hidden');
        }
    }

    // 二维码登录
    async function startQrLogin() {
        try {
            showLoading(true);
            showStatus('正在生成二维码...', 'info');
            
            // 1. 获取key
            const keyRes = await fetch(`${API_BASE}/login/qr/key?timestamp=${Date.now()}`);
            const keyData = await keyRes.json();
            
            if (keyData.code !== 200) {
                showStatus('获取二维码失败，请重试', 'error');
                showLoading(false);
                return;
            }
            
            qrKey = keyData.data.unikey;
            
            // 2. 生成二维码
            const qrRes = await fetch(`${API_BASE}/login/qr/create?key=${qrKey}&qrimg=true&timestamp=${Date.now()}`);
            const qrData = await qrRes.json();
            
            if (qrData.code !== 200) {
                showStatus('生成二维码失败', 'error');
                showLoading(false);
                return;
            }
            
            // 显示二维码弹窗
            openModal();
            showLoading(false);
            showStatus('请使用网易云音乐APP扫码登录', 'info');
            
            // 更新状态显示
            updateQrStatus('等待扫码...', 'info');
            
            // 使用qrcode库生成二维码
            QRCode.toCanvas(qrcodeCanvas, qrData.data.qrimg, {
                width: 220,
                height: 220,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    console.error('生成二维码失败:', error);
                    updateQrStatus('生成二维码失败，请重试', 'error');
                }
            });
            
            // 3. 开始轮询扫码状态
            startPollingQrStatus();
            
        } catch (error) {
            console.error('二维码登录失败:', error);
            showStatus('登录失败，请检查网络', 'error');
            showLoading(false);
        }
    }

    // 打开二维码弹窗
    function openModal() {
        qrcodeModal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    // 关闭二维码弹窗
    function closeModal() {
        qrcodeModal.classList.remove('active');
        document.body.style.overflow = '';
        
        if (qrCheckInterval) {
            clearInterval(qrCheckInterval);
            qrCheckInterval = null;
        }
    }

    // 更新二维码状态显示
    function updateQrStatus(message, type = 'info') {
        qrcodeStatus.className = 'status-message';
        qrcodeStatus.classList.add(`status-${type}`);
        
        let icon = '';
        switch(type) {
            case 'success':
                icon = '<i class="fas fa-check-circle"></i>';
                break;
            case 'error':
                icon = '<i class="fas fa-exclamation-circle"></i>';
                break;
            case 'info':
                icon = '<i class="fas fa-sync-alt fa-spin"></i>';
                break;
        }
        
        qrcodeStatus.innerHTML = `${icon}<span>${message}</span>`;
    }

    // 轮询扫码状态
    function startPollingQrStatus() {
        if (qrCheckInterval) clearInterval(qrCheckInterval);
        
        qrCheckInterval = setInterval(async () => {
            try {
                const checkRes = await fetch(`${API_BASE}/login/qr/check?key=${qrKey}&timestamp=${Date.now()}`);
                const checkData = await checkRes.json();
                
                console.log('QR检查状态:', checkData);
                
                if (checkData.code === 800) {
                    updateQrStatus('二维码已过期，请刷新页面', 'error');
                    clearInterval(qrCheckInterval);
                } else if (checkData.code === 801) {
                    updateQrStatus('等待扫码...', 'info');
                } else if (checkData.code === 802) {
                    updateQrStatus('已扫码，请在APP中确认登录', 'info');
                } else if (checkData.code === 803) {
                    // 登录成功
                    clearInterval(qrCheckInterval);
                    
                    // 获取cookie
                    const cookie = checkData.cookie || checkData.data?.cookie;
                    if (cookie) {
                        currentCookie = cookie;
                        localStorage.setItem('netease_cookie', currentCookie);
                        updateQrStatus('登录成功！正在跳转...', 'success');
                        
                        setTimeout(() => {
                            closeModal();
                            showPlayer();
                            loadPlaylist();
                            showStatus('登录成功！', 'success');
                        }, 1500);
                    } else {
                        updateQrStatus('登录失败，请重试', 'error');
                    }
                } else if (checkData.code === 200) {
                    // 有些API返回200表示成功
                    clearInterval(qrCheckInterval);
                    
                    if (checkData.cookie) {
                        currentCookie = checkData.cookie;
                        localStorage.setItem('netease_cookie', currentCookie);
                        updateQrStatus('登录成功！正在跳转...', 'success');
                        
                        setTimeout(() => {
                            closeModal();
                            showPlayer();
                            loadPlaylist();
                            showStatus('登录成功！', 'success');
                        }, 1500);
                    } else {
                        updateQrStatus('登录失败，请重试', 'error');
                    }
                }
            } catch (error) {
                console.error('检查扫码状态失败:', error);
                updateQrStatus('网络错误，请重试', 'error');
            }
        }, 2000);
    }

    // 游客登录
    async function guestLogin() {
        try {
            showLoading(true);
            showStatus('正在游客登录...', 'info');
            
            const res = await fetch(`${API_BASE}/register/anonimous`);
            const data = await res.json();
            
            if (data.code === 200 && data.cookie) {
                currentCookie = data.cookie;
                localStorage.setItem('netease_cookie', currentCookie);
                
                showStatus('游客登录成功！', 'success');
                setTimeout(() => {
                    showPlayer();
                    loadPlaylist();
                }, 1000);
            } else {
                showStatus('游客登录失败', 'error');
            }
        } catch (error) {
            console.error('游客登录失败:', error);
            showStatus('登录失败，请检查网络', 'error');
        } finally {
            showLoading(false);
        }
    }

    // 显示播放器
    function showPlayer() {
        loginSection.style.display = 'none';
        playerSection.classList.remove('hidden');
    }

    // 加载推荐歌单
    async function loadPlaylist() {
        try {
            showLoading(true);
            
            // 获取推荐歌单
            let url;
            if (currentCookie) {
                // 已登录：获取每日推荐歌单
                url = `${API_BASE}/recommend/resource?cookie=${encodeURIComponent(currentCookie)}`;
            } else {
                // 未登录：获取推荐歌单
                url = `${API_BASE}/personalized?limit=20`;
            }
            
            console.log('加载歌单URL:', url);
            
            const res = await fetch(url);
            const data = await res.json();
            
            console.log('歌单数据:', data);
            
            if (data.code === 200) {
                // 处理不同的数据结构
                if (data.recommend || data.data) {
                    currentPlaylist = data.recommend || data.data || [];
                } else if (data.result) {
                    currentPlaylist = data.result;
                } else {
                    currentPlaylist = [];
                }
                
                if (currentPlaylist.length === 0 && currentCookie) {
                    // 如果推荐歌单为空，尝试获取热门歌单
                    await loadHotPlaylist();
                } else {
                    renderPlaylist();
                    
                    if (currentPlaylist.length > 0) {
                        // 显示第一首歌的封面
                        const firstItem = currentPlaylist[0];
                        if (firstItem.picUrl || firstItem.coverImgUrl) {
                            updateAlbumArt(firstItem.picUrl || firstItem.coverImgUrl);
                        }
                    }
                }
            } else {
                showStatus('加载歌单失败，请重试', 'error');
            }
        } catch (error) {
            console.error('加载歌单失败:', error);
            showStatus('加载失败，请检查网络', 'error');
            
            // 加载热门歌单作为备选
            await loadHotPlaylist();
        } finally {
            showLoading(false);
        }
    }

    // 加载热门歌单
    async function loadHotPlaylist() {
        try {
            const res = await fetch(`${API_BASE}/top/playlist?limit=20`);
            const data = await res.json();
            
            if (data.code === 200) {
                currentPlaylist = data.playlists || [];
                renderPlaylist();
                
                if (currentPlaylist.length > 0) {
                    const firstItem = currentPlaylist[0];
                    if (firstItem.coverImgUrl) {
                        updateAlbumArt(firstItem.coverImgUrl);
                    }
                }
            }
        } catch (error) {
            console.error('加载热门歌单失败:', error);
        }
    }

    // 渲染播放列表
    function renderPlaylist() {
        if (!playlistContainer) return;
        
        if (currentPlaylist.length === 0) {
            playlistContainer.innerHTML = `
                <div class="status-message status-info" style="margin: 2rem auto; text-align: center;">
                    <i class="fas fa-info-circle"></i>
                    <span>暂无歌单数据</span>
                </div>
            `;
            loadMoreBtn.style.display = 'none';
            return;
        }
        
        let html = '';
        
        currentPlaylist.forEach((item, index) => {
            const isActive = index === currentTrackIndex;
            const coverUrl = item.picUrl || item.coverImgUrl || item.album?.picUrl;
            const name = item.name || item.title || '未知歌单';
            const artist = item.artistName || item.creator?.nickname || item.copywriter || '未知歌手';
            const playCount = item.playCount ? formatPlayCount(item.playCount) : '';
            
            html += `
                <div class="playlist-item ${isActive ? 'active' : ''}" data-index="${index}">
                    <div class="playlist-item-cover">
                        ${coverUrl ? 
                            `<img src="${coverUrl}" alt="${name}" loading="lazy">` : 
                            `<i class="fas fa-music"></i>`
                        }
                    </div>
                    <div class="playlist-item-info">
                        <h4>${name}</h4>
                        <p>${artist} ${playCount ? `· ${playCount}次播放` : ''}</p>
                    </div>
                    <div class="playlist-item-duration">
                        ${item.trackCount ? `${item.trackCount}首` : '播放'}
                    </div>
                </div>
            `;
        });
        
        playlistContainer.innerHTML = html;
        
        // 添加点击事件
        const playlistItems = playlistContainer.querySelectorAll('.playlist-item');
        playlistItems.forEach(item => {
            item.addEventListener('click', async function() {
                const index = parseInt(this.dataset.index);
                await playTrack(index);
            });
        });
        
        // 显示加载更多按钮
        loadMoreBtn.style.display = 'block';
    }

    // 格式化播放次数
    function formatPlayCount(count) {
        if (count >= 100000000) {
            return (count / 100000000).toFixed(1) + '亿';
        } else if (count >= 10000) {
            return (count / 10000).toFixed(1) + '万';
        }
        return count.toString();
    }

    // 更新专辑封面
    function updateAlbumArt(url) {
        if (!albumArt) return;
        
        albumArt.innerHTML = url ? 
            `<img src="${url}" alt="专辑封面">` : 
            `<i class="fas fa-music"></i>`;
    }

    // 播放指定曲目
    async function playTrack(index) {
        try {
            if (index < 0 || index >= currentPlaylist.length) return;
            
            currentTrackIndex = index;
            const track = currentPlaylist[index];
            
            // 更新当前播放信息
            currentTrack.textContent = track.name || track.title || '未知歌曲';
            currentArtist.textContent = track.artistName || track.creator?.nickname || '未知歌手';
            
            // 更新专辑封面
            const coverUrl = track.picUrl || track.coverImgUrl || track.album?.picUrl;
            updateAlbumArt(coverUrl);
            
            // 获取歌曲详情（这里简化处理，实际需要调用歌曲详情API）
            showStatus(`准备播放: ${track.name || track.title}`, 'info');
            
            // 模拟播放
            isPlaying = true;
            playIcon.className = 'fas fa-pause';
            
            // 更新播放列表高亮
            updatePlaylistHighlight();
            
        } catch (error) {
            console.error('播放失败:', error);
            showStatus('播放失败，请重试', 'error');
        }
    }

    // 切换播放/暂停
    function togglePlay() {
        isPlaying = !isPlaying;
        playIcon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
        
        if (isPlaying && currentPlaylist.length > 0) {
            if (currentTrack.textContent === '选择歌曲开始播放') {
                playTrack(0);
            }
        }
    }

    // 播放上一首
    function playPrev() {
        if (currentPlaylist.length === 0) return;
        
        currentTrackIndex = (currentTrackIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
        playTrack(currentTrackIndex);
    }

    // 播放下一首
    function playNext() {
        if (currentPlaylist.length === 0) return;
        
        currentTrackIndex = (currentTrackIndex + 1) % currentPlaylist.length;
        playTrack(currentTrackIndex);
    }

    // 更新播放列表高亮
    function updatePlaylistHighlight() {
        const items = playlistContainer.querySelectorAll('.playlist-item');
        items.forEach((item, index) => {
            if (index === currentTrackIndex) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }

    // 加载更多歌单
    async function loadMoreTracks() {
        // 这里可以实现加载更多歌单的逻辑
        showStatus('正在加载更多歌单...', 'info');
        
        // 模拟延迟
        setTimeout(() => {
            showStatus('加载完成', 'success');
        }, 1000);
    }

    // 进度条点击
    function seekToPosition(e) {
        if (!progressBar) return;
        
        const rect = progressBar.getBoundingClientRect();
        const position = (e.clientX - rect.left) / rect.width;
        const newTime = position * 100; // 假设总时长100秒
        
        progress.style.width = `${position * 100}%`;
        currentTimeEl.textContent = formatTime(newTime);
    }

    // 格式化时间
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // 注销登录
    function logout() {
        currentCookie = '';
        localStorage.removeItem('netease_cookie');
        
        playerSection.classList.add('hidden');
        loginSection.style.display = 'block';
        
        showStatus('已成功注销', 'success');
    }

    // 初始化
    init();
}

// 等待DOM加载完成
document.addEventListener('DOMContentLoaded', function() {
    console.log('网易云音乐播放器初始化...');
    initNeteasePlayer();
});
