<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç½‘æ˜“äº‘ç™»å½•æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
    <h1>ç½‘æ˜“äº‘éŸ³ä¹ç™»å½•æµ‹è¯•</h1>
    
    <h2>æ¸¸å®¢ç™»å½•æµ‹è¯•</h2>
    <button onclick="testGuestLogin()">æµ‹è¯•æ¸¸å®¢ç™»å½•</button>
    <div id="guestResult" style="border:1px solid #ccc; padding:10px; margin:10px 0; min-height:50px;"></div>
    
    <hr>
    
    <h2>äºŒç»´ç ç™»å½•æµ‹è¯•</h2>
    <button onclick="startQrLogin()">å¼€å§‹äºŒç»´ç ç™»å½•</button>
    <button onclick="stopQrCheck()" style="background-color:#f0f0f0;">åœæ­¢æ£€æŸ¥</button>
    <button onclick="checkLoginStatus()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
    
    <div id="qrArea" style="display:none; margin:20px 0;">
        <h3>è¯·ç”¨ç½‘æ˜“äº‘APPæ‰«æäºŒç»´ç </h3>
        <canvas id="qrcodeCanvas" style="border:1px solid #ccc;"></canvas>
        <div id="qrStatus" style="margin:10px 0; padding:10px; background-color:#f5f5f5;"></div>
    </div>
    
    <div id="userInfo" style="display:none; border:1px solid green; padding:15px; margin:10px 0; background-color:#f0fff0;">
        <h3>ç™»å½•æˆåŠŸï¼ç”¨æˆ·ä¿¡æ¯</h3>
        <div id="userData"></div>
        <button onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
    
    <hr>
    
    <h2>APIè°ƒç”¨æµ‹è¯•ï¼ˆéœ€è¦ç™»å½•ï¼‰</h2>
    <div>
        <button onclick="testPersonalized()">æµ‹è¯•æ¨èæ­Œå•</button>
        <button onclick="testUserPlaylist()">æµ‹è¯•ç”¨æˆ·æ­Œå•</button>
        <button onclick="testDailyRecommend()">æµ‹è¯•æ¯æ—¥æ¨è</button>
    </div>
    <div id="apiResult" style="border:1px solid #ccc; padding:10px; margin:10px 0; min-height:100px; max-height:300px; overflow:auto;"></div>
    
    <hr>
    
    <div style="background-color:#fff8e1; padding:15px; border-left:4px solid #ff9800; margin:20px 0;">
        <h3>å®‰å…¨æç¤º</h3>
        <p>1. è¯·å‹¿ä½¿ç”¨ä»–äººæä¾›çš„å…¬å¼€æœåŠ¡è¿›è¡Œç™»å½•</p>
        <p>2. äºŒç»´ç ç™»å½•å¯èƒ½å› ç½‘æ˜“äº‘ç›¾æ£€æµ‹è€Œå¤±è´¥</p>
        <p>3. æ¸¸å®¢ç™»å½•æ— æ³•è®¿é—®ä¸ªäººæ”¶è—ç­‰ç§æœ‰æ•°æ®</p>
        <p>4. è¯·å‹¿é¢‘ç¹è°ƒç”¨ç™»å½•æ¥å£ï¼Œé¿å…è§¦å‘é£æ§</p>
    </div>

    <script>
        // APIåŸºç¡€åœ°å€ - è¯·ä¿®æ”¹ä¸ºä½ çš„éƒ¨ç½²åœ°å€
        const API_BASE = 'https://neteaseapi-enhanced.vercel.app';
        let currentCookie = '';
        let qrKey = '';
        let qrCheckInterval = null;
        
        // æµ‹è¯•æ¸¸å®¢ç™»å½•
        async function testGuestLogin() {
            const resultDiv = document.getElementById('guestResult');
            resultDiv.innerHTML = 'æ­£åœ¨è¯·æ±‚æ¸¸å®¢ç™»å½•...';
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${API_BASE}/register/anonimous?timestamp=${Date.now()}`);
                const data = await response.json();
                const endTime = Date.now();
                
                if (data.code === 200 && data.cookie) {
                    currentCookie = data.cookie;
                    localStorage.setItem('netease_cookie', currentCookie);
                    
                    let html = `
                        <div style="color:green;">
                            <h4>âœ… æ¸¸å®¢ç™»å½•æˆåŠŸï¼</h4>
                            <p>å“åº”æ—¶é—´: ${endTime - startTime}ms</p>
                            <p>Cookieé•¿åº¦: ${data.cookie.length} å­—ç¬¦</p>
                            <p>ç”¨æˆ·ID: ${data.account?.id || 'åŒ¿åç”¨æˆ·'}</p>
                            <p>ç”¨æˆ·å: ${data.account?.userName || 'æ¸¸å®¢'}</p>
                            <p><button onclick="showCookie()">æŸ¥çœ‹Cookie</button></p>
                            <div id="cookieDisplay" style="display:none; background:#f5f5f5; padding:10px; margin:5px 0; word-break:break-all;"></div>
                        </div>
                    `;
                    
                    resultDiv.innerHTML = html;
                    showUserInfo(data.account);
                    checkAPIAccess();
                } else {
                    resultDiv.innerHTML = `
                        <div style="color:red;">
                            <h4>âŒ æ¸¸å®¢ç™»å½•å¤±è´¥</h4>
                            <p>é”™è¯¯ç : ${data.code}</p>
                            <p>é”™è¯¯ä¿¡æ¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color:red;">
                        <h4>âŒ è¯·æ±‚å¤±è´¥</h4>
                        <p>é”™è¯¯: ${error.message}</p>
                        <p>è¯·æ£€æŸ¥APIåœ°å€: ${API_BASE}</p>
                    </div>
                `;
            }
        }
        
        // æ˜¾ç¤ºCookie
        function showCookie() {
            const display = document.getElementById('cookieDisplay');
            if (display.style.display === 'none') {
                display.innerHTML = `<pre>${currentCookie}</pre>`;
                display.style.display = 'block';
            } else {
                display.style.display = 'none';
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function showUserInfo(account) {
            const userInfoDiv = document.getElementById('userInfo');
            const userDataDiv = document.getElementById('userData');
            
            if (account) {
                userDataDiv.innerHTML = `
                    <p><strong>ç”¨æˆ·ID:</strong> ${account.id}</p>
                    <p><strong>ç”¨æˆ·å:</strong> ${account.userName}</p>
                    <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(account.createTime).toLocaleString()}</p>
                    <p><strong>ç±»å‹:</strong> ${account.type === 0 ? 'æ™®é€šç”¨æˆ·' : 'å…¶ä»–'}</p>
                    <p><strong>çŠ¶æ€:</strong> ${account.status === 0 ? 'æ­£å¸¸' : 'å¼‚å¸¸'}</p>
                `;
            } else {
                userDataDiv.innerHTML = '<p>åŒ¿åç”¨æˆ·ï¼ˆæ¸¸å®¢ï¼‰</p>';
            }
            
            userInfoDiv.style.display = 'block';
        }
        
        // å¼€å§‹äºŒç»´ç ç™»å½•æµç¨‹
        async function startQrLogin() {
            try {
                document.getElementById('qrArea').style.display = 'block';
                document.getElementById('qrStatus').innerHTML = 'æ­£åœ¨ç”ŸæˆäºŒç»´ç ...';
                
                // 1. è·å–äºŒç»´ç key
                const keyRes = await fetch(`${API_BASE}/login/qr/key?timestamp=${Date.now()}`);
                const keyData = await keyRes.json();
                
                if (keyData.code !== 200) {
                    document.getElementById('qrStatus').innerHTML = `è·å–äºŒç»´ç keyå¤±è´¥: ${keyData.code}`;
                    return;
                }
                
                qrKey = keyData.data.unikey;
                console.log('äºŒç»´ç key:', qrKey);
                
                // 2. ç”ŸæˆäºŒç»´ç 
                const qrRes = await fetch(`${API_BASE}/login/qr/create?key=${qrKey}&qrimg=true&timestamp=${Date.now()}`);
                const qrData = await qrRes.json();
                
                if (qrData.code !== 200) {
                    document.getElementById('qrStatus').innerHTML = `ç”ŸæˆäºŒç»´ç å¤±è´¥: ${qrData.code}`;
                    return;
                }
                
                // æ˜¾ç¤ºäºŒç»´ç 
                QRCode.toCanvas(document.getElementById('qrcodeCanvas'), qrData.data.qrimg, {
                    width: 250,
                    height: 250,
                    margin: 2
                }, function(error) {
                    if (error) {
                        document.getElementById('qrStatus').innerHTML = `ç”ŸæˆäºŒç»´ç å›¾ç‰‡å¤±è´¥: ${error.message}`;
                    }
                });
                
                document.getElementById('qrStatus').innerHTML = 'è¯·ç”¨ç½‘æ˜“äº‘APPæ‰«æäºŒç»´ç ';
                
                // 3. å¼€å§‹è½®è¯¢æ£€æŸ¥æ‰«ç çŠ¶æ€
                startPollingQrStatus();
                
            } catch (error) {
                document.getElementById('qrStatus').innerHTML = `è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }
        
        // è½®è¯¢æ£€æŸ¥äºŒç»´ç æ‰«ç çŠ¶æ€
        function startPollingQrStatus() {
            if (qrCheckInterval) clearInterval(qrCheckInterval);
            
            qrCheckInterval = setInterval(async () => {
                try {
                    const checkRes = await fetch(`${API_BASE}/login/qr/check?key=${qrKey}&timestamp=${Date.now()}`);
                    const checkData = await checkRes.json();
                    
                    console.log('æ‰«ç çŠ¶æ€:', checkData.code, checkData.message);
                    
                    if (checkData.code === 800) {
                        document.getElementById('qrStatus').innerHTML = 'âŒ äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç”Ÿæˆ';
                        clearInterval(qrCheckInterval);
                    } else if (checkData.code === 801) {
                        document.getElementById('qrStatus').innerHTML = 'â³ ç­‰å¾…æ‰«ç ...';
                    } else if (checkData.code === 802) {
                        document.getElementById('qrStatus').innerHTML = 'âœ… å·²æ‰«ç ï¼Œè¯·åœ¨APPä¸­ç¡®è®¤ç™»å½•';
                    } else if (checkData.code === 803) {
                        // ç™»å½•æˆåŠŸ
                        clearInterval(qrCheckInterval);
                        currentCookie = checkData.cookie || checkData.data?.cookie;
                        
                        if (currentCookie) {
                            localStorage.setItem('netease_cookie', currentCookie);
                            document.getElementById('qrStatus').innerHTML = 'ğŸ‰ ç™»å½•æˆåŠŸï¼';
                            document.getElementById('qrArea').style.display = 'none';
                            
                            // è·å–ç”¨æˆ·ä¿¡æ¯
                            const userRes = await fetch(`${API_BASE}/login/status?timestamp=${Date.now()}`, {
                                headers: {
                                    'Cookie': currentCookie
                                }
                            });
                            const userData = await userRes.json();
                            
                            if (userData.data?.profile) {
                                showUserInfo(userData.data.profile);
                                checkAPIAccess();
                            }
                        } else {
                            document.getElementById('qrStatus').innerHTML = 'âŒ ç™»å½•å¤±è´¥ï¼Œæœªè·å–åˆ°Cookie';
                        }
                    } else if (checkData.code === 502) {
                        document.getElementById('qrStatus').innerHTML = 'âš ï¸ æ‰«ç åè¿”å›502ï¼Œè¯·å°è¯•åŠ ä¸ŠnoCookieå‚æ•°';
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥æ‰«ç çŠ¶æ€å¤±è´¥:', error);
                    document.getElementById('qrStatus').innerHTML = `æ£€æŸ¥å¤±è´¥: ${error.message}`;
                }
            }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
        }
        
        // åœæ­¢äºŒç»´ç æ£€æŸ¥
        function stopQrCheck() {
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
                qrCheckInterval = null;
                document.getElementById('qrStatus').innerHTML = 'å·²åœæ­¢æ£€æŸ¥æ‰«ç çŠ¶æ€';
            }
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            if (!currentCookie) {
                currentCookie = localStorage.getItem('netease_cookie');
                if (!currentCookie) {
                    alert('è¯·å…ˆç™»å½•');
                    return;
                }
            }
            
            try {
                const res = await fetch(`${API_BASE}/login/status?timestamp=${Date.now()}`, {
                    headers: {
                        'Cookie': currentCookie
                    }
                });
                const data = await res.json();
                
                const resultDiv = document.getElementById('guestResult');
                if (data.data?.profile) {
                    const profile = data.data.profile;
                    resultDiv.innerHTML = `
                        <div style="color:green;">
                            <h4>âœ… å·²ç™»å½•</h4>
                            <p>ç”¨æˆ·ID: ${profile.userId}</p>
                            <p>æ˜µç§°: ${profile.nickname}</p>
                            <p>å¤´åƒ: ${profile.avatarUrl ? 'æœ‰' : 'æ— '}</p>
                            <p>VIPç±»å‹: ${profile.vipType === 0 ? 'éVIP' : 'VIP'}</p>
                        </div>
                    `;
                    showUserInfo(profile);
                } else {
                    resultDiv.innerHTML = `
                        <div style="color:orange;">
                            <h4>âš ï¸ ç™»å½•çŠ¶æ€å¼‚å¸¸</h4>
                            <p>å¯èƒ½Cookieå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // æ£€æŸ¥APIè®¿é—®æƒé™
        async function checkAPIAccess() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•APIè®¿é—®æƒé™...';
            
            try {
                // æµ‹è¯•æ¨èæ­Œå•ï¼ˆä¸éœ€è¦ç™»å½•ï¼‰
                const playlistRes = await fetch(`${API_BASE}/personalized?limit=3&timestamp=${Date.now()}`);
                const playlistData = await playlistRes.json();
                
                let html = '<h4>APIè®¿é—®æµ‹è¯•ç»“æœ:</h4>';
                
                if (playlistData.code === 200) {
                    html += `<p>âœ… æ¨èæ­Œå•æ¥å£: æ­£å¸¸ (${playlistData.result?.length || 0} ä¸ªæ­Œå•)</p>`;
                } else {
                    html += `<p>âŒ æ¨èæ­Œå•æ¥å£: å¤±è´¥ (${playlistData.code})</p>`;
                }
                
                // å¦‚æœå·²ç™»å½•ï¼Œæµ‹è¯•éœ€è¦ç™»å½•çš„æ¥å£
                if (currentCookie) {
                    try {
                        const userRes = await fetch(`${API_BASE}/user/account?timestamp=${Date.now()}`, {
                            headers: {
                                'Cookie': currentCookie
                            }
                        });
                        const userData = await userRes.json();
                        
                        if (userData.code === 200) {
                            html += `<p>âœ… ç”¨æˆ·ä¿¡æ¯æ¥å£: æ­£å¸¸</p>`;
                        } else {
                            html += `<p>âŒ ç”¨æˆ·ä¿¡æ¯æ¥å£: å¤±è´¥ (${userData.code})</p>`;
                        }
                    } catch (error) {
                        html += `<p>âŒ ç”¨æˆ·ä¿¡æ¯æ¥å£: è¯·æ±‚å¤±è´¥</p>`;
                    }
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p>âŒ APIæµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æµ‹è¯•æ¨èæ­Œå•æ¥å£
        async function testPersonalized() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•æ¨èæ­Œå•æ¥å£...';
            
            try {
                const res = await fetch(`${API_BASE}/personalized?limit=5&timestamp=${Date.now()}`);
                const data = await res.json();
                
                let html = '<h4>æ¨èæ­Œå•æµ‹è¯•ç»“æœ:</h4>';
                
                if (data.code === 200) {
                    const playlists = data.result || data.data || [];
                    html += `<p>âœ… æˆåŠŸè·å– ${playlists.length} ä¸ªæ¨èæ­Œå•</p>`;
                    
                    playlists.forEach((playlist, index) => {
                        html += `
                            <div style="border:1px solid #ddd; padding:10px; margin:5px 0;">
                                <p><strong>${index + 1}. ${playlist.name}</strong></p>
                                <p>æè¿°: ${playlist.copywriter || 'æ— '}</p>
                                <p>æ­Œæ›²æ•°: ${playlist.trackCount}</p>
                            </div>
                        `;
                    });
                } else {
                    html += `<p>âŒ å¤±è´¥: ${data.code} - ${data.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p>âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æµ‹è¯•ç”¨æˆ·æ­Œå•æ¥å£
        async function testUserPlaylist() {
            if (!currentCookie) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•ç”¨æˆ·æ­Œå•æ¥å£...';
            
            try {
                // å…ˆè·å–ç”¨æˆ·ä¿¡æ¯ä»¥è·å–UID
                const statusRes = await fetch(`${API_BASE}/login/status?timestamp=${Date.now()}`, {
                    headers: {
                        'Cookie': currentCookie
                    }
                });
                const statusData = await statusRes.json();
                
                if (statusData.code !== 200 || !statusData.data?.profile?.userId) {
                    resultDiv.innerHTML = '<p>âŒ æ— æ³•è·å–ç”¨æˆ·ID</p>';
                    return;
                }
                
                const userId = statusData.data.profile.userId;
                
                // è·å–ç”¨æˆ·æ­Œå•
                const res = await fetch(`${API_BASE}/user/playlist?uid=${userId}&timestamp=${Date.now()}`, {
                    headers: {
                        'Cookie': currentCookie
                    }
                });
                const data = await res.json();
                
                let html = '<h4>ç”¨æˆ·æ­Œå•æµ‹è¯•ç»“æœ:</h4>';
                
                if (data.code === 200) {
                    const playlists = data.playlist || data.data || [];
                    html += `<p>âœ… æˆåŠŸè·å– ${playlists.length} ä¸ªæ­Œå•</p>`;
                    
                    playlists.slice(0, 5).forEach((playlist, index) => {
                        html += `
                            <div style="border:1px solid #ddd; padding:10px; margin:5px 0;">
                                <p><strong>${index + 1}. ${playlist.name}</strong></p>
                                <p>æ­Œæ›²æ•°: ${playlist.trackCount}</p>
                                <p>åˆ›å»ºè€…: ${playlist.creator?.nickname || 'æœªçŸ¥'}</p>
                            </div>
                        `;
                    });
                    
                    if (playlists.length > 5) {
                        html += `<p>... è¿˜æœ‰ ${playlists.length - 5} ä¸ªæ­Œå•æœªæ˜¾ç¤º</p>`;
                    }
                } else if (data.code === 301) {
                    html += `<p>âŒ éœ€è¦ç™»å½•ï¼ˆè¿”å›301ï¼‰</p>`;
                    html += `<p>å¯èƒ½åŸå› ï¼šCookieå·²è¿‡æœŸæˆ–æ— æ•ˆ</p>`;
                } else {
                    html += `<p>âŒ å¤±è´¥: ${data.code} - ${data.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p>âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æµ‹è¯•æ¯æ—¥æ¨è
        async function testDailyRecommend() {
            if (!currentCookie) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }
            
            const resultDiv = document.getElementById('apiResult');
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•æ¯æ—¥æ¨èæ¥å£...';
            
            try {
                const res = await fetch(`${API_BASE}/recommend/songs?timestamp=${Date.now()}`, {
                    headers: {
                        'Cookie': currentCookie
                    }
                });
                const data = await res.json();
                
                let html = '<h4>æ¯æ—¥æ¨èæµ‹è¯•ç»“æœ:</h4>';
                
                if (data.code === 200) {
                    const songs = data.data?.dailySongs || data.recommend || [];
                    html += `<p>âœ… æˆåŠŸè·å– ${songs.length} é¦–æ¨èæ­Œæ›²</p>`;
                    
                    songs.slice(0, 5).forEach((song, index) => {
                        html += `
                            <div style="border:1px solid #ddd; padding:10px; margin:5px 0;">
                                <p><strong>${index + 1}. ${song.name}</strong></p>
                                <p>æ­Œæ‰‹: ${song.ar?.map(a => a.name).join(', ') || 'æœªçŸ¥'}</p>
                                <p>ä¸“è¾‘: ${song.al?.name || 'æœªçŸ¥'}</p>
                            </div>
                        `;
                    });
                } else if (data.code === 301) {
                    html += `<p>âŒ éœ€è¦ç™»å½•ï¼ˆè¿”å›301ï¼‰</p>`;
                } else {
                    html += `<p>âŒ å¤±è´¥: ${data.code} - ${data.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p>âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            if (!currentCookie) return;
            
            try {
                const res = await fetch(`${API_BASE}/logout?timestamp=${Date.now()}`, {
                    headers: {
                        'Cookie': currentCookie
                    }
                });
                const data = await res.json();
                
                if (data.code === 200) {
                    currentCookie = '';
                    localStorage.removeItem('netease_cookie');
                    document.getElementById('userInfo').style.display = 'none';
                    document.getElementById('guestResult').innerHTML = '<p style="color:green;">âœ… å·²é€€å‡ºç™»å½•</p>';
                }
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„Cookie
        window.addEventListener('load', () => {
            const savedCookie = localStorage.getItem('netease_cookie');
            if (savedCookie) {
                currentCookie = savedCookie;
                checkLoginStatus();
            }
        });
    </script>
</body>
</html>
