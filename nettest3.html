<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网易云音乐API综合测试</title>
    <meta name="referrer" content="no-referrer">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { margin-bottom: 20px; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }
        .card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input, .input-group select { width: 100%; padding: 8px; }
        .button-group { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #e60026; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .result { border: 1px solid #eee; padding: 15px; margin-top: 15px; max-height: 300px; overflow-y: auto; }
        .song-item { padding: 10px; border-bottom: 1px solid #eee; }
        .song-item:hover { background: #f5f5f5; }
        .song-header { display: flex; justify-content: space-between; }
        .song-title { font-weight: bold; }
        .song-meta { font-size: 12px; color: #666; margin-top: 5px; }
        .song-actions { margin-top: 8px; display: flex; gap: 5px; }
        .song-actions button { padding: 5px 10px; font-size: 12px; }
        .type-badge { background: #e60026; color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 5px; }
        .login-status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0; }
        .status-card { border: 1px solid #ddd; padding: 15px; text-align: center; }
        .qrcode-container { text-align: center; margin: 15px 0; }
        #qrcodeImage { width: 200px; height: 200px; margin: 0 auto; border: 1px solid #ddd; }
        .status-box { padding: 10px; margin: 10px 0; border-left: 4px solid; }
        .status-success { background: #d4edda; border-color: #28a745; color: #155724; }
        .status-error { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .status-info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
        .status-waiting { background: #fff3cd; border-color: #ffc107; color: #856404; }
        .audio-player-container { background: #f8f9fa; padding: 15px; margin-top: 15px; border-radius: 5px; }
        .progress-bar { height: 4px; background: #ddd; margin: 10px 0; }
        .progress-bar-fill { height: 100%; background: #e60026; width: 0%; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>网易云音乐API综合测试平台</h1>
            <p>一站式测试：登录认证 → 音乐搜索 → 智能推荐 → 高质量播放</p>
            <div>API状态：<strong id="apiStatusText">检测中...</strong></div>
        </div>
        
        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px;">
            <h3>重要提示</h3>
            <ul>
                <li><strong>智能聚合搜索：</strong>已实现根据搜索词智能显示相关类型结果（歌单、专辑、单曲等）</li>
                <li><strong>海外部署支持：</strong>自动添加randomCNIP=true参数解决海外IP限制</li>
                <li><strong>请使用私有API：</strong>建议部署自己的Vercel服务</li>
                <li><strong>登录后使用：</strong>高质量音质需要登录后使用</li>
            </ul>
        </div>
        
        <div class="main-grid">
            <div>
                <div class="card">
                    <h2>账户状态</h2>
                    <div class="login-status-grid">
                        <div class="status-card" id="loginStatusCard">
                            <h3>登录状态</h3>
                            <div class="value">未知</div>
                        </div>
                        <div class="status-card" id="cookieStatusCard">
                            <h3>Cookie状态</h3>
                            <div class="value">未知</div>
                        </div>
                        <div class="status-card" id="apiStatusCard">
                            <h3>API状态</h3>
                            <div class="value">未知</div>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-info" onclick="checkLoginStatus()">刷新状态</button>
                        <button class="btn-danger" onclick="logout()">退出登录</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2>二维码登录</h2>
                    <p>使用网易云音乐APP扫码登录，获取完整功能权限</p>
                    
                    <div class="button-group">
                        <button class="btn-primary" onclick="startQRLogin()" id="qrLoginBtn">开始二维码登录</button>
                        <button class="btn-secondary" onclick="stopQRLogin()">停止轮询</button>
                    </div>
                    
                    <div class="qrcode-container" id="qrcodeContainer" style="display: none;">
                        <div id="qrcodeImage"></div>
                        <div id="qrcodeStatus" class="status-box status-info">
                            <span>正在生成二维码...</span>
                        </div>
                        <div>时间戳: <span id="qrTimestamp"></span></div>
                    </div>
                    
                    <div id="qrResult" class="result" style="display: none;">
                        <h3>登录结果</h3>
                        <div id="qrData"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>快速体验</h2>
                    <p>快速获取游客身份，体验基础功能（无需扫码）</p>
                    
                    <div class="button-group">
                        <button class="btn-success" onclick="guestLogin()">游客登录</button>
                        <button class="btn-secondary" onclick="clearGuestCookie()">清除游客数据</button>
                    </div>
                    
                    <div id="guestResult" class="result" style="display: none;">
                        <h3>游客登录结果</h3>
                        <div id="guestData"></div>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="card">
                    <h2>智能搜索音乐</h2>
                    <div class="input-group">
                        <label>搜索关键词</label>
                        <input type="text" id="keywords" placeholder="请输入歌曲名、歌手或专辑名，例如：百闻牌 原声带" value="百闻牌">
                    </div>
                    
                    <div class="input-group">
                        <label>搜索模式</label>
                        <select id="searchMode">
                            <option value="smart" selected>智能聚合搜索（推荐）</option>
                            <option value="song">仅搜单曲</option>
                            <option value="album">仅搜专辑</option>
                            <option value="playlist">仅搜歌单</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="input-group">
                            <label>返回数量</label>
                            <input type="number" id="searchLimit" value="20" min="1" max="100">
                        </div>
                        <div class="input-group">
                            <label>偏移量</label>
                            <input type="number" id="searchOffset" value="0" min="0">
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="searchMusic()" id="searchBtn" style="width: 100%; padding: 12px;">
                        开始智能搜索
                    </button>
                    
                    <div id="searchResult" class="result" style="display: none;">
                        <h3>搜索结果</h3>
                        <div id="searchData"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>推荐音乐</h2>
                    <p>根据你的音乐偏好获取个性化推荐（需要登录）</p>
                    
                    <div class="button-group">
                        <button class="btn-info" onclick="getPersonalized()">个性化推荐</button>
                        <button class="btn-secondary" onclick="getNewSongs()">最新音乐</button>
                        <button class="btn-secondary" onclick="getTopList()">排行榜</button>
                    </div>
                    
                    <div id="recommendResult" class="result" style="display: none;">
                        <h3>推荐结果</h3>
                        <div id="recommendData"></div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>音乐播放</h2>
                    <div class="input-group">
                        <label>歌曲ID</label>
                        <input type="text" id="playSongId" placeholder="直接输入歌曲ID或从搜索结果点击使用">
                    </div>
                    
                    <div class="input-group">
                        <label>播放音质</label>
                        <select id="qualityLevel">
                            <option value="standard">标准 (standard)</option>
                            <option value="higher">较高 (higher)</option>
                            <option value="exhigh" selected>极高 (exhigh)</option>
                            <option value="lossless">无损 (lossless)</option>
                            <option value="hires">Hi-Res (hires)</option>
                        </select>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn-success" onclick="playSelectedSong()" id="playBtn">播放音乐</button>
                        <button class="btn-secondary" onclick="stopAudio()">停止播放</button>
                        <button class="btn-info" onclick="checkMusicAvailable()">检查可用性</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="audioPlayerContainer" class="audio-player-container" style="display: none;">
            <h3>正在播放</h3>
            <div id="nowPlaying"></div>
            
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
            
            <audio id="audioPlayer" controls style="width: 100%;"></audio>
            
            <div id="audioInfo"></div>
        </div>
        
        <div class="card">
            <h2>API配置</h2>
            <div class="input-group">
                <label>API基础地址</label>
                <input type="text" id="apiBaseUrl" value="https://neteaseapi-enhanced.vercel.app">
            </div>
            
            <div class="button-group">
                <button class="btn-secondary" onclick="updateApiBase()">更新API地址</button>
                <button class="btn-info" onclick="testApiConnection()">测试连接</button>
            </div>
            
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <h4>配置说明</h4>
                <p>
                    1. <strong>智能搜索：</strong>已实现根据关键词自动选择最优结果显示<br>
                    2. <strong>搜索"百闻牌"：</strong>优先显示歌单和专辑，其次才是单曲<br>
                    3. <strong>当前地址：</strong> <code id="currentApiBase">https://neteaseapi-enhanced.vercel.app</code>
                </p>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let API_BASE = 'https://neteaseapi-enhanced.vercel.app';
        let currentAudio = null;
        let searchResults = [];
        let recommendResults = [];
        let qrCheckInterval = null;
        let currentQRKey = null;
        let currentCookie = null;
        let audioUpdateInterval = null;

        // 页面加载初始化
        window.addEventListener('load', function() {
            console.log('网易云音乐API综合测试平台已加载');
            
            const savedApiBase = localStorage.getItem('netease_api_base');
            if (savedApiBase) {
                API_BASE = savedApiBase;
                document.getElementById('apiBaseUrl').value = API_BASE;
                document.getElementById('currentApiBase').textContent = API_BASE;
            }
            
            const savedCookie = localStorage.getItem('netease_cookie');
            if (savedCookie) {
                currentCookie = savedCookie;
                updateCookieDisplay();
                updateLoginStatus();
            }
            
            checkAPIStatus();
            setupAudioProgress();
        });

        // ========== 工具函数 ==========
        
        function getTimestamp() {
            return Date.now();
        }
        
        function buildApiUrl(endpoint, params = {}) {
            const baseParams = `timestamp=${getTimestamp()}&randomCNIP=true`;
            const queryParams = new URLSearchParams();
            
            Object.keys(params).forEach(key => {
                if (params[key] !== null && params[key] !== undefined) {
                    queryParams.append(key, params[key]);
                }
            });
            
            const queryString = queryParams.toString();
            return `${API_BASE}${endpoint}?${baseParams}${queryString ? '&' + queryString : ''}`;
        }
        
        function showStatus(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            let className = '';
            
            switch(type) {
                case 'success': className = 'status-success'; break;
                case 'error': className = 'status-error'; break;
                case 'info': className = 'status-info'; break;
                case 'waiting': className = 'status-waiting'; break;
            }
            
            container.innerHTML = `<span>${message}</span>`;
            container.className = `status-box ${className}`;
            container.style.display = 'block';
        }
        
        function showResult(containerId, content) {
            const container = document.getElementById(containerId);
            if (typeof content === 'string') {
                container.innerHTML = content;
            } else {
                container.innerHTML = `<pre>${JSON.stringify(content, null, 2)}</pre>`;
            }
            container.parentElement.style.display = 'block';
        }
        
        function updateStatusCard(cardId, value, status) {
            const card = document.getElementById(cardId);
            const valueDiv = card.querySelector('.value');
            valueDiv.textContent = value;
            
            card.className = 'status-card';
            if (status === 'true') {
                card.classList.add('true');
            } else if (status === 'false') {
                card.classList.add('false');
            }
        }

        // ========== 智能搜索核心函数 ==========
        
        async function searchMusic() {
            const keywords = document.getElementById('keywords').value.trim();
            const searchLimit = document.getElementById('searchLimit').value;
            const searchOffset = document.getElementById('searchOffset').value;
            const searchMode = document.getElementById('searchMode').value;

            if (!keywords) {
                showStatus('searchData', '请输入搜索关键词', 'error');
                document.getElementById('searchResult').style.display = 'block';
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            const originalText = searchBtn.innerHTML;
            searchBtn.innerHTML = '搜索中...';
            searchBtn.disabled = true;

            try {
                // 根据搜索模式选择不同的搜索策略
                if (searchMode === 'smart') {
                    await smartSearch(keywords, searchLimit, searchOffset);
                } else {
                    // 单一类型搜索
                    const typeMap = {
                        'song': 1,
                        'album': 10,
                        'playlist': 1000
                    };
                    const type = typeMap[searchMode] || 1;
                    
                    const url = buildApiUrl('/search', {
                        keywords: keywords,
                        type: type,
                        limit: searchLimit,
                        offset: searchOffset
                    });

                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.code === 200 && data.result) {
                        displaySingleTypeResults(data, type);
                    } else {
                        showResult('searchData', data);
                        showStatus('searchData', `搜索失败: ${data.msg || '未知错误'}`, 'error');
                    }
                }
            } catch (error) {
                console.error('搜索出错:', error);
                showStatus('searchData', `网络请求失败: ${error.message}`, 'error');
                document.getElementById('searchResult').style.display = 'block';
            } finally {
                searchBtn.innerHTML = originalText;
                searchBtn.disabled = false;
            }
        }

        // 智能聚合搜索
        async function smartSearch(keywords, limit, offset) {
            // 根据关键词类型智能选择搜索策略
            const isGameRelated = keywords.includes('牌') || keywords.includes('游戏') || 
                               keywords.includes('原声') || keywords.includes('OST') ||
                               keywords.includes('阴阳师') || keywords.includes('百闻牌');
            const isPlaylistRelated = keywords.includes('精选') || keywords.includes('合集') || 
                                    keywords.includes('歌单') || keywords.includes('推荐');
            const isArtistRelated = keywords.includes('的歌曲') || keywords.includes('作品') || 
                                  keywords.includes('演唱');
            
            let searchTypes;
            
            if (isGameRelated) {
                // 游戏相关：优先歌单，其次专辑，最后单曲
                searchTypes = [
                    { type: 1000, name: '歌单', weight: 3 },
                    { type: 10, name: '专辑', weight: 2 },
                    { type: 1, name: '单曲', weight: 1 }
                ];
            } else if (isPlaylistRelated) {
                // 歌单相关：优先歌单
                searchTypes = [
                    { type: 1000, name: '歌单', weight: 3 },
                    { type: 1, name: '单曲', weight: 1 }
                ];
            } else if (isArtistRelated) {
                // 艺人相关：优先单曲和专辑
                searchTypes = [
                    { type: 1, name: '单曲', weight: 2 },
                    { type: 10, name: '专辑', weight: 3 },
                    { type: 1000, name: '歌单', weight: 1 }
                ];
            } else {
                // 默认：平衡策略
                searchTypes = [
                    { type: 1, name: '单曲', weight: 2 },
                    { type: 1000, name: '歌单', weight: 2 },
                    { type: 10, name: '专辑', weight: 1 }
                ];
            }

            // 并行搜索
            const promises = searchTypes.map(async (item) => {
                const url = buildApiUrl('/search', {
                    keywords: keywords,
                    type: item.type,
                    limit: Math.max(5, Math.floor(limit / searchTypes.length)),
                    offset: offset
                });
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    return { ...data, searchType: item };
                } catch (error) {
                    console.error(`搜索类型 ${item.name} 失败:`, error);
                    return { code: 500, searchType: item, result: null };
                }
            });

            const results = await Promise.all(promises);
            displaySmartResults(results, keywords);
        }

        // 显示智能搜索结果
        function displaySmartResults(results, keywords) {
            const container = document.getElementById('searchData');
            let allResults = [];
            
            // 收集所有结果并计算相关性分数
            results.forEach(result => {
                if (result.code === 200 && result.result) {
                    const searchType = result.searchType;
                    
                    if (searchType.type === 1) { // 单曲
                        const songs = result.result.songs || [];
                        songs.forEach(song => {
                            song._displayType = '单曲';
                            song._relevanceScore = calculateRelevance(song.name + (song.artists ? song.artists[0].name : ''), keywords, searchType.weight);
                            song._rawData = song;
                            allResults.push(song);
                        });
                    } else if (searchType.type === 10) { // 专辑
                        const albums = result.result.albums || [];
                        albums.forEach(album => {
                            album._displayType = '专辑';
                            album._relevanceScore = calculateRelevance(album.name + (album.artist ? album.artist.name : ''), keywords, searchType.weight);
                            album._rawData = album;
                            allResults.push(album);
                        });
                    } else if (searchType.type === 1000) { // 歌单
                        const playlists = result.result.playlists || [];
                        playlists.forEach(playlist => {
                            playlist._displayType = '歌单';
                            playlist._relevanceScore = calculateRelevance(playlist.name + playlist.description, keywords, searchType.weight * 1.5);
                            playlist._rawData = playlist;
                            allResults.push(playlist);
                        });
                    }
                }
            });
            
            // 按相关性分数排序
            allResults.sort((a, b) => b._relevanceScore - a._relevanceScore);
            
            // 只取前limit个结果
            const limit = parseInt(document.getElementById('searchLimit').value);
            const finalResults = allResults.slice(0, limit);
            
            // 显示结果
            if (finalResults.length > 0) {
                let html = `<div style="margin-bottom: 10px;">找到 ${finalResults.length} 个相关结果</div>`;
                html += '<div class="song-list">';
                
                finalResults.forEach((item, index) => {
                    html += formatSearchItem(item, index);
                });
                
                html += '</div>';
                container.innerHTML = html;
                showStatus('searchData', `智能搜索完成，已按相关性排序`, 'success');
            } else {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">未找到相关结果，请尝试其他关键词</div>';
                showStatus('searchData', '未找到相关结果', 'info');
            }
            
            document.getElementById('searchResult').style.display = 'block';
            searchResults = finalResults;
        }

        // 计算相关性分数
        function calculateRelevance(text, keywords, baseWeight = 1) {
            if (!text) return 0;
            
            let score = 0;
            const keywordList = keywords.toLowerCase().split(' ');
            const searchText = text.toLowerCase();
            
            // 完全匹配
            if (searchText.includes(keywords.toLowerCase())) {
                score += 100;
            }
            
            // 部分匹配
            keywordList.forEach(keyword => {
                if (keyword.length > 1 && searchText.includes(keyword)) {
                    score += 50;
                }
            });
            
            // 权重加成
            score *= baseWeight;
            
            return score;
        }

        // 格式化搜索结果项
        function formatSearchItem(item, index) {
            let html = `<div class="song-item" data-index="${index}">`;
            html += `<div class="song-header">`;
            html += `<span class="song-title"><span class="type-badge">${item._displayType}</span> ${item.name || '未知'}</span>`;
            
            if (item._displayType === '单曲') {
                const artists = item.artists ? item.artists.map(a => a.name).join('/') : '未知歌手';
                html += `<span style="font-size: 12px; color: #666;">ID: ${item.id}</span>`;
                html += `</div>`;
                html += `<div class="song-meta">`;
                html += `<span>歌手: ${artists}</span>`;
                html += `<span>专辑: ${item.album ? item.album.name : '未知'}</span>`;
                if (item.duration) {
                    const duration = Math.floor(item.duration / 1000);
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    html += `<span>时长: ${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
                }
            } else if (item._displayType === '专辑') {
                const artist = item.artist ? item.artist.name : '未知歌手';
                html += `<span style="font-size: 12px; color: #666;">ID: ${item.id}</span>`;
                html += `</div>`;
                html += `<div class="song-meta">`;
                html += `<span>歌手: ${artist}</span>`;
                html += `<span>歌曲数: ${item.size || 0}</span>`;
                if (item.publishTime) {
                    const date = new Date(item.publishTime);
                    html += `<span>发行: ${date.getFullYear()}-${date.getMonth()+1}</span>`;
                }
            } else if (item._displayType === '歌单') {
                const creator = item.creator ? item.creator.nickname : '未知用户';
                html += `<span style="font-size: 12px; color: #666;">ID: ${item.id}</span>`;
                html += `</div>`;
                html += `<div class="song-meta">`;
                html += `<span>创建者: ${creator}</span>`;
                html += `<span>播放数: ${formatNumber(item.playCount)}</span>`;
                html += `<span>歌曲数: ${item.trackCount || 0}</span>`;
            }
            
            html += `</div>`;
            
            // 操作按钮
            html += `<div class="song-actions">`;
            if (item._displayType === '单曲') {
                html += `<button onclick="playSongById(${item.id})" style="font-size: 12px; padding: 4px 8px;">播放</button>`;
                html += `<button onclick="setSongId(${item.id})" style="font-size: 12px; padding: 4px 8px;">使用ID</button>`;
            } else if (item._displayType === '专辑') {
                html += `<button onclick="getAlbumSongs(${item.id})" style="font-size: 12px; padding: 4px 8px;">查看专辑歌曲</button>`;
            } else if (item._displayType === '歌单') {
                html += `<button onclick="getPlaylistSongs(${item.id})" style="font-size: 12px; padding: 4px 8px;">查看歌单</button>`;
            }
            html += `<button onclick="viewDetails(${index})" style="font-size: 12px; padding: 4px 8px;">详情</button>`;
            html += `</div>`;
            
            html += `</div>`;
            return html;
        }

        // 显示单一类型结果
        function displaySingleTypeResults(data, type) {
            const container = document.getElementById('searchData');
            let html = '';
            
            if (type === 1 && data.result.songs) { // 单曲
                html += `<div style="margin-bottom: 10px;">找到 ${data.result.songCount || 0} 首单曲</div>`;
                html += '<div class="song-list">';
                
                data.result.songs.forEach((song, index) => {
                    song._displayType = '单曲';
                    song._rawData = song;
                    html += formatSearchItem(song, index);
                });
                
                html += '</div>';
                searchResults = data.result.songs;
            } else if (type === 10 && data.result.albums) { // 专辑
                html += `<div style="margin-bottom: 10px;">找到 ${data.result.albumCount || 0} 张专辑</div>`;
                html += '<div class="song-list">';
                
                data.result.albums.forEach((album, index) => {
                    album._displayType = '专辑';
                    album._rawData = album;
                    html += formatSearchItem(album, index);
                });
                
                html += '</div>';
                searchResults = data.result.albums;
            } else if (type === 1000 && data.result.playlists) { // 歌单
                html += `<div style="margin-bottom: 10px;">找到 ${data.result.playlistCount || 0} 个歌单</div>`;
                html += '<div class="song-list">';
                
                data.result.playlists.forEach((playlist, index) => {
                    playlist._displayType = '歌单';
                    playlist._rawData = playlist;
                    html += formatSearchItem(playlist, index);
                });
                
                html += '</div>';
                searchResults = data.result.playlists;
            } else {
                html = '<div style="padding: 20px; text-align: center; color: #666;">未找到相关结果</div>';
            }
            
            container.innerHTML = html;
            showStatus('searchData', `搜索完成，找到 ${searchResults.length} 个结果`, 'success');
            document.getElementById('searchResult').style.display = 'block';
        }

        // ========== 辅助函数 ==========
        
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + '万';
            }
            return num.toString();
        }
        
        function setSongId(id) {
            document.getElementById('playSongId').value = id;
        }
        
        function viewDetails(index) {
            const item = searchResults[index];
            if (item) {
                alert(`详细信息:\n名称: ${item.name}\n类型: ${item._displayType}\nID: ${item.id}\n\n完整数据已打印到控制台`);
                console.log('完整数据:', item._rawData || item);
            }
        }
        
        function getAlbumSongs(albumId) {
            alert(`查看专辑 ${albumId} 的歌曲功能待实现`);
            // 这里可以调用获取专辑详情的API
        }
        
        function getPlaylistSongs(playlistId) {
            alert(`查看歌单 ${playlistId} 功能待实现`);
            // 这里可以调用获取歌单详情的API
        }

        // ========== 原有功能函数（保持不变） ==========
        
        async function playSongById(songId) {
            document.getElementById('playSongId').value = songId;
            await playSelectedSong();
        }
        
        async function playSelectedSong() {
            const songId = document.getElementById('playSongId').value.trim();
            const qualityLevel = document.getElementById('qualityLevel').value;
            
            if (!songId) {
                alert('请输入歌曲ID');
                return;
            }
            
            const playBtn = document.getElementById('playBtn');
            const originalText = playBtn.innerHTML;
            playBtn.innerHTML = '获取播放链接...';
            playBtn.disabled = true;
            
            try {
                // 首先检查歌曲是否可用
                const checkUrl = buildApiUrl('/check/music', { id: songId });
                const checkResponse = await fetch(checkUrl);
                const checkData = await checkResponse.json();
                
                if (checkData.success !== false) {
                    // 获取播放链接
                    const playUrl = buildApiUrl('/song/url', {
                        id: songId,
                        br: qualityLevel === 'standard' ? 999000 : 
                            qualityLev
