<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网易云音乐 - 高级搜索测试</title>
    <meta name="referrer" content="no-referrer">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #fff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            max-width: 900px;
            margin: 0 auto 20px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-indicator .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ecdc4;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .search-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .search-section h2 {
            color: #fff;
            margin-bottom: 25px;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .input-group {
            position: relative;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 16px;
            color: #fff;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 15px 0;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .checkbox-label:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .search-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 150px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(78, 205, 196, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #45b7d1, #34ace0);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(69, 183, 209, 0.4);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .btn-outline:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: #4ecdc4;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .results-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .results-header h2 {
            color: #fff;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .stats {
            display: flex;
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #4ecdc4;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .results-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .tab.active {
            background: #4ecdc4;
            color: white;
        }
        
        .results-content {
            min-height: 300px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border-color: rgba(78, 205, 196, 0.5);
        }
        
        .card-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        .card-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .card-action-btn {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .card-action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .card-action-btn.primary {
            background: rgba(78, 205, 196, 0.2);
            color: #4ecdc4;
        }
        
        .card-action-btn.primary:hover {
            background: rgba(78, 205, 196, 0.3);
        }
        
        .filters-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        
        .filter-item {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .filter-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .filter-item.active {
            background: rgba(78, 205, 196, 0.2);
            border-color: #4ecdc4;
            color: #4ecdc4;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }
        
        .pagination-btn {
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .pagination-btn.active {
            background: #4ecdc4;
            color: white;
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .api-config {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
            max-width: 300px;
        }
        
        .api-config h3 {
            font-size: 14px;
            color: #fff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .api-config input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }
        
        .api-config button {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background: rgba(78, 205, 196, 0.8);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .search-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }
            
            .api-config {
                position: static;
                max-width: 100%;
                margin-bottom: 20px;
            }
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4ecdc4;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- API配置 -->
        <div class="api-config">
            <h3><i class="fas fa-cog"></i> API配置</h3>
            <input type="text" id="apiBaseUrl" placeholder="API基础地址" value="https://neteaseapi-enhanced.vercel.app">
            <button onclick="updateApiBase()">更新地址</button>
            <div style="margin-top: 10px; font-size: 12px; color: rgba(255, 255, 255, 0.6);" id="apiStatus">
                <i class="fas fa-circle" style="color: #4ecdc4;"></i> 状态正常
            </div>
        </div>
        
        <!-- 页头 -->
        <div class="header">
            <h1><i class="fas fa-search"></i> 网易云音乐高级搜索测试</h1>
            <p>智能搜索、高级过滤、多维度排序 - 轻松找到你想要的所有音乐</p>
            <div class="status-indicator">
                <span class="dot"></span>
                <span>搜索API状态: <strong id="apiStatusText">就绪</strong></span>
            </div>
        </div>
        
        <!-- 搜索区域 -->
        <div class="search-section">
            <h2><i class="fas fa-sliders-h"></i> 搜索配置</h2>
            
            <div class="search-grid">
                <div class="input-group">
                    <label for="searchKeywords">
                        <i class="fas fa-keyboard"></i> 搜索关键词
                        <span class="tooltip">
                            <i class="fas fa-question-circle" style="margin-left: 5px;"></i>
                            <span class="tooltip-text">支持复杂搜索语法：<br>1. 歌词搜索：使用 "lyric:关键词"<br>2. 精确匹配：使用双引号 "周杰伦"<br>3. 排除关键词：使用减号 -抖音<br>4. 组合搜索：周杰伦 -live lyric:晴天</span>
                        </span>
                    </label>
                    <input type="text" id="searchKeywords" placeholder="请输入关键词，支持复杂搜索语法" value="周杰伦">
                </div>
                
                <div class="input-group">
                    <label for="searchType"><i class="fas fa-filter"></i> 搜索类型</label>
                    <select id="searchType">
                        <option value="1">单曲</option>
                        <option value="10">专辑</option>
                        <option value="100">歌手</option>
                        <option value="1000">歌单</option>
                        <option value="1002">用户</option>
                        <option value="1004">MV</option>
                        <option value="1006">歌词</option>
                        <option value="1009">电台</option>
                        <option value="1014">视频</option>
                    </select>
                </div>
            </div>
            
            <div class="search-grid">
                <div class="input-group">
                    <label for="searchLimit"><i class="fas fa-list-ol"></i> 每页数量 (1-100)</label>
                    <input type="range" id="searchLimit" min="1" max="100" value="30">
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <span>1</span>
                        <span id="limitValue">30</span>
                        <span>100</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="searchOffset"><i class="fas fa-layer-group"></i> 分页偏移</label>
                    <input type="number" id="searchOffset" value="0" min="0">
                </div>
            </div>
            
            <!-- 高级选项 -->
            <div class="filters-section">
                <h3><i class="fas fa-star"></i> 高级过滤</h3>
                <div class="filter-group">
                    <div class="checkbox-label">
                        <input type="checkbox" id="chkHot" checked>
                        <span>热门优先</span>
                    </div>
                    <div class="checkbox-label">
                        <input type="checkbox" id="chkNoCopyright">
                        <span>排除无版权</span>
                    </div>
                    <div class="checkbox-label">
                        <input type="checkbox" id="chkHQ">
                        <span>仅高质量</span>
                    </div>
                    <div class="checkbox-label">
                        <input type="checkbox" id="chkOfficial">
                        <span>官方版本</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>时间范围</h4>
                    <div class="filter-group">
                        <div class="filter-item active" onclick="setTimeRange('all')">全部</div>
                        <div class="filter-item" onclick="setTimeRange('year')">一年内</div>
                        <div class="filter-item" onclick="setTimeRange('month')">一个月内</div>
                        <div class="filter-item" onclick="setTimeRange('week')">一周内</div>
                    </div>
                </div>
            </div>
            
            <div class="search-actions">
                <button class="btn btn-primary" onclick="performSmartSearch()" id="searchBtn">
                    <i class="fas fa-search"></i> 智能搜索
                </button>
                <button class="btn btn-secondary" onclick="advancedSearch()">
                    <i class="fas fa-magic"></i> 高级搜索
                </button>
                <button class="btn btn-success" onclick="searchByExamples()">
                    <i class="fas fa-lightbulb"></i> 示例搜索
                </button>
                <button class="btn btn-outline" onclick="clearSearch()">
                    <i class="fas fa-broom"></i> 清空
                </button>
            </div>
        </div>
        
        <!-- 结果区域 -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <h2><i class="fas fa-list"></i> 搜索结果</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="resultCount">0</div>
                        <div class="stat-label">总数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="resultTime">0ms</div>
                        <div class="stat-label">耗时</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="resultPage">1</div>
                        <div class="stat-label">页码</div>
                    </div>
                </div>
            </div>
            
            <div class="results-tabs">
                <button class="tab active" onclick="switchTab('songs')"><i class="fas fa-music"></i> 单曲</button>
                <button class="tab" onclick="switchTab('albums')"><i class="fas fa-compact-disc"></i> 专辑</button>
                <button class="tab" onclick="switchTab('artists')"><i class="fas fa-user"></i> 歌手</button>
                <button class="tab" onclick="switchTab('playlists')"><i class="fas fa-list-ol"></i> 歌单</button>
            </div>
            
            <div class="results-content" id="resultsContent">
                <!-- 内容通过JS动态加载 -->
            </div>
            
            <div class="pagination" id="pagination" style="display: none;">
                <button class="pagination-btn" onclick="changePage(-1)" id="prevPage">上一页</button>
                <div id="pageNumbers"></div>
                <button class="pagination-btn" onclick="changePage(1)" id="nextPage">下一页</button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let API_BASE = 'https://neteaseapi-enhanced.vercel.app';
        let searchResults = {};
        let currentTab = 'songs';
        let currentPage = 1;
        let itemsPerPage = 30;
        let totalResults = 0;
        let totalPages = 1;
        let timeRange = 'all';

        // 页面加载初始化
        window.addEventListener('load', function() {
            console.log('高级搜索测试页面已加载');
            
            // 从本地存储加载配置
            const savedApiBase = localStorage.getItem('netease_api_base');
            if (savedApiBase) {
                API_BASE = savedApiBase;
                document.getElementById('apiBaseUrl').value = API_BASE;
            }
            
            // 检查API状态
            testApiConnection();
            
            // 设置滑块事件
            const limitSlider = document.getElementById('searchLimit');
            const limitValue = document.getElementById('limitValue');
            limitSlider.addEventListener('input', function() {
                limitValue.textContent = this.value;
                itemsPerPage = parseInt(this.value);
            });
            
            // 加载搜索历史
            loadSearchHistory();
            
            // 设置示例搜索按钮
            setupExampleSearch();
        });

        // ========== API配置管理 ==========
        function updateApiBase() {
            const newApiBase = document.getElementById('apiBaseUrl').value.trim();
            if (!newApiBase) {
                alert('请输入有效的API地址');
                return;
            }
            
            API_BASE = newApiBase;
            localStorage.setItem('netease_api_base', API_BASE);
            testApiConnection();
        }
        
        async function testApiConnection() {
            const apiStatus = document.getElementById('apiStatus');
            const apiStatusText = document.getElementById('apiStatusText');
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${API_BASE}/search/default`);
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                if (response.ok) {
                    apiStatus.innerHTML = `<i class="fas fa-circle" style="color: #4ecdc4;"></i> 正常 (${responseTime}ms)`;
                    apiStatusText.textContent = '就绪';
                } else {
                    apiStatus.innerHTML = `<i class="fas fa-circle" style="color: #ff6b6b;"></i> 异常`;
                    apiStatusText.textContent = '异常';
                }
            } catch (error) {
                apiStatus.innerHTML = `<i class="fas fa-circle" style="color: #ff6b6b;"></i> 连接失败`;
                apiStatusText.textContent = '失败';
            }
        }

        // ========== 搜索功能 ==========
        function buildApiUrl(endpoint, params = {}) {
            const timestamp = Date.now();
            const baseParams = `timestamp=${timestamp}&randomCNIP=true`;
            const queryParams = new URLSearchParams();
            
            Object.keys(params).forEach(key => {
                if (params[key] !== null && params[key] !== undefined) {
                    queryParams.append(key, params[key]);
                }
            });
            
            const queryString = queryParams.toString();
            return `${API_BASE}${endpoint}?${baseParams}${queryString ? '&' + queryString : ''}`;
        }

        async function performSmartSearch() {
            const keywords = document.getElementById('searchKeywords').value.trim();
            const searchType = document.getElementById('searchType').value;
            const offset = document.getElementById('searchOffset').value;
            const searchBtn = document.getElementById('searchBtn');
            
            if (!keywords) {
                alert('请输入搜索关键词');
                return;
            }
            
            // 显示加载状态
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 搜索中...';
            
            // 解析关键词中的高级语法
            const parsedKeywords = parseSearchKeywords(keywords);
            
            // 构建搜索参数
            const params = {
                keywords: parsedKeywords.keywords,
                type: searchType,
                limit: itemsPerPage,
                offset: offset || 0
            };
            
            // 添加高级选项
            if (document.getElementById('chkHot').checked) {
                params.order = 'hot';
            }
            
            // 应用时间范围
            if (timeRange !== 'all') {
                const timeRanges = {
                    'year': 31536000000, // 1年
                    'month': 2592000000,  // 1个月
                    'week': 604800000     // 1周
                };
                const minPublishTime = Date.now() - timeRanges[timeRange];
                // 注意：原API可能不支持时间范围参数，这里作为扩展思路
            }
            
            // 记录搜索历史
            saveSearchHistory(keywords, searchType);
            
            try {
                const startTime = Date.now();
                const url = buildApiUrl('/cloudsearch', params);
                console.log('搜索URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                const endTime = Date.now();
                
                // 处理搜索结果
                handleSearchResults(data, parsedKeywords, endTime - startTime);
                
            } catch (error) {
                console.error('搜索失败:', error);
                alert(`搜索失败: ${error.message}`);
            } finally {
                searchBtn.disabled = false;
                searchBtn.innerHTML = '<i class="fas fa-search"></i> 智能搜索';
            }
        }

        function parseSearchKeywords(keywords) {
            const result = {
                keywords: '',
                filters: {
                    lyric: null,
                    exclude: [],
                    exact: false
                }
            };
            
            let processed = keywords;
            
            // 检查歌词搜索
            const lyricMatch = processed.match(/lyric:(\S+)/i);
            if (lyricMatch) {
                result.filters.lyric = lyricMatch[1];
                processed = processed.replace(/lyric:\S+/i, '').trim();
            }
            
            // 检查排除关键词
            const excludeMatches = processed.match(/-\S+/g);
            if (excludeMatches) {
                result.filters.exclude = excludeMatches.map(match => match.substring(1));
                excludeMatches.forEach(match => {
                    processed = processed.replace(match, '');
                });
                processed = processed.trim();
            }
            
            // 检查精确匹配
            const exactMatch = processed.match(/"([^"]+)"/);
            if (exactMatch) {
                result.filters.exact = true;
                processed = processed.replace(/"[^"]+"/, exactMatch[1]).trim();
            }
            
            result.keywords = processed;
            return result;
        }

        function handleSearchResults(data, parsedKeywords, responseTime) {
            if (data.code !== 200) {
                alert(`搜索失败: ${data.message || '未知错误'}`);
                return;
            }
            
            // 保存搜索结果
            searchResults = data.result || {};
            
            // 更新统计信息
            updateStats(data, responseTime);
            
            // 显示结果区域
            document.getElementById('resultsSection').style.display = 'block';
            
            // 根据搜索类型显示不同的内容
            switchTab('songs');
            
            // 更新分页
            updatePagination();
        }

        function updateStats(data, responseTime) {
            const result = data.result;
            let totalCount = 0;
            
            if (result) {
                if (result.songCount) totalCount = result.songCount;
                else if (result.albumCount) totalCount = result.albumCount;
                else if (result.artistCount) totalCount = result.artistCount;
                else if (result.playlistCount) totalCount = result.playlistCount;
            }
            
            document.getElementById('resultCount').textContent = totalCount.toLocaleString();
            document.getElementById('resultTime').textContent = `${responseTime}ms`;
            document.getElementById('resultPage').textContent = currentPage;
            
            totalResults = totalCount;
            totalPages = Math.ceil(totalCount / itemsPerPage);
        }

        // ========== 结果显示功能 ==========
        function switchTab(tabName) {
            currentTab = tabName;
            
            // 更新标签状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 显示对应的内容
            const resultsContent = document.getElementById('resultsContent');
            
            if (!searchResults || Object.keys(searchResults).length === 0) {
                resultsContent.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>暂无搜索结果，请先进行搜索</p></div>';
                return;
            }
            
            let html = '';
            let items = [];
            
            switch(tabName) {
                case 'songs':
                    items = searchResults.songs || [];
                    html = renderSongs(items);
                    break;
                case 'albums':
                    items = searchResults.albums || [];
                    html = renderAlbums(items);
                    break;
                case 'artists':
                    items = searchResults.artists || [];
                    html = renderArtists(items);
                    break;
                case 'playlists':
                    items = searchResults.playlists || [];
                    html = renderPlaylists(items);
                    break;
            }
            
            if (items.length === 0) {
                html = '<div class="empty-state"><i class="fas fa-inbox"></i><p>暂无相关内容</p></div>';
            }
            
            resultsContent.innerHTML = html;
        }

        function renderSongs(songs) {
            if (!songs || songs.length === 0) return '';
            
            let html = '<div class="results-grid">';
            
            songs.forEach((song, index) => {
                const artists = song.ar ? song.ar.map(artist => artist.name).join(' / ') : '未知';
                const album = song.al ? song.al.name : '未知';
                const duration = formatDuration(song.dt);
                
                html += `
                    <div class="result-card">
                        <div class="card-header">
                            <div class="card-title">${song.name}</div>
                            <div class="card-subtitle">${artists}</div>
                        </div>
                        <div class="card-body">
                            <div class="card-meta">
                                <span><i class="fas fa-compact-disc"></i> ${album}</span>
                                <span><i class="fas fa-clock"></i> ${duration}</span>
                            </div>
                            <div class="card-actions">
                                <button class="card-action-btn primary" onclick="playSong(${song.id}, '${song.name.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-play"></i> 播放
                                </button>
                                <button class="card-action-btn" onclick="showSongDetails(${song.id})">
                                    <i class="fas fa-info-circle"></i> 详情
                                </button>
                                <button class="card-action-btn" onclick="addToPlaylist(${song.id})">
                                    <i class="fas fa-plus"></i> 收藏
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderAlbums(albums) {
            if (!albums || albums.length === 0) return '';
            
            let html = '<div class="results-grid">';
            
            albums.forEach(album => {
                const artist = album.artist ? album.artist.name : '未知';
                const publishTime = album.publishTime ? new Date(album.publishTime).getFullYear() : '未知';
                
                html += `
                    <div class="result-card">
                        <div class="card-header">
                            <div class="card-title">${album.name}</div>
                            <div class="card-subtitle">${artist}</div>
                        </div>
                        <div class="card-body">
                            <div class="card-meta">
                                <span><i class="fas fa-calendar"></i> ${publishTime}</span>
                                <span><i class="fas fa-music"></i> ${album.size}首</span>
                            </div>
                            <div class="card-actions">
                                <button class="card-action-btn primary" onclick="viewAlbum(${album.id})">
                                    <i class="fas fa-eye"></i> 查看
                                </button>
                                <button class="card-action-btn" onclick="playAlbum(${album.id})">
                                    <i class="fas fa-play"></i> 播放全部
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderArtists(artists) {
            if (!artists || artists.length === 0) return '';
            
            let html = '<div class="results-grid">';
            
            artists.forEach(artist => {
                const albumCount = artist.albumSize || 0;
                const musicCount = artist.musicSize || 0;
                
                html += `
                    <div class="result-card">
                        <div class="card-header">
                            <div class="card-title">${artist.name}</div>
                            <div class="card-subtitle">${artist.alias ? artist.alias.join(', ') : ''}</div>
                        </div>
                        <div class="card-body">
                            <div class="card-meta">
                                <span><i class="fas fa-compact-disc"></i> ${albumCount}专辑</span>
                                <span><i class="fas fa-music"></i> ${musicCount}单曲</span>
                            </div>
                            <div class="card-actions">
                                <button class="card-action-btn primary" onclick="viewArtist(${artist.id})">
                                    <i class="fas fa-user"></i> 主页
                                </button>
                                <button class="card-action-btn" onclick="playArtistTop(${artist.id})">
                                    <i class="fas fa-play"></i> 热门歌曲
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderPlaylists(playlists) {
            if (!playlists || playlists.length === 0) return '';
            
            let html = '<div class="results-grid">';
            
            playlists.forEach(playlist => {
                const creator = playlist.creator ? playlist.creator.nickname : '未知';
                const playCount = playlist.playCount ? formatNumber(playlist.playCount) : '0';
                
                html += `
                    <div class="result-card">
                        <div class="card-header">
                            <div class="card-title">${playlist.name}</div>
                            <div class="card-subtitle">by ${creator}</div>
                        </div>
                        <div class="card-body">
                            <div class="card-meta">
                                <span><i class="fas fa-play-circle"></i> ${playCount}播放</span>
                                <span><i class="fas fa-music"></i> ${playlist.trackCount}首</span>
                            </div>
                            <div class="card-actions">
                                <button class="card-action-btn primary" onclick="viewPlaylist(${playlist.id})">
                                    <i class="fas fa-eye"></i> 查看
                                </button>
                                <button class="card-action-btn" onclick="playPlaylist(${playlist.id})">
                                    <i class="fas fa-play"></i> 播放
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // ========== 高级搜索功能 ==========
        function advancedSearch() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                backdrop-filter: blur(5px);
            `;
            
            modal.innerHTML = `
                <div style="background: #1a1a2e; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h2 style="color: white; margin-bottom: 20px;">高级搜索</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: rgba(255, 255, 255, 0.9); display: block; margin-bottom: 8px;">搜索模式</label>
                        <select id="advMode" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; color: white;">
                            <option value="normal">普通搜索</option>
                            <option value="lyric">歌词搜索</option>
                            <option value="similar">相似歌曲</option>
                            <option value="artistOnly">仅限歌手</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: rgba(255, 255, 255, 0.9); display: block; margin-bottom: 8px;">排序方式</label>
                        <select id="advSort" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; color: white;">
                            <option value="hot">热度排序</option>
                            <option value="time">时间排序</option>
                            <option value="score">评分排序</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="color: rgba(255, 255, 255, 0.9); display: block; margin-bottom: 8px;">音乐类型</label>
                        <input type="text" id="advGenre" placeholder="例如: 流行, 摇滚, 电子" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; color: white;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button onclick="executeAdvancedSearch(this.parentElement.parentElement)" style="flex: 1; padding: 12px; background: #4ecdc4; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">搜索</button>
                        <button onclick="this.closest('div[style]').remove()" style="flex: 1; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; color: white; cursor: pointer;">取消</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function executeAdvancedSearch(modal) {
            const keywords = document.getElementById('searchKeywords').value.trim();
            const mode = document.getElementById('advMode').value;
            const sort = document.getElementById('advSort').value;
            const genre = document.getElementById('advGenre').value.trim();
            
            // 构建高级搜索关键词
            let advancedKeywords = keywords;
            
            if (mode === 'lyric') {
                advancedKeywords = `lyric:${keywords}`;
            } else if (mode === 'artistOnly') {
                advancedKeywords = `${keywords} artistonly`;
            }
            
            if (genre) {
                advancedKeywords += ` ${genre}`;
            }
            
            // 更新搜索框
            document.getElementById('searchKeywords').value = advancedKeywords;
            
            // 移除模态框
            modal.parentElement.remove();
            
            // 执行搜索
            performSmartSearch();
        }

        // ========== 示例搜索功能 ==========
        function setupExampleSearch() {
            const examples = [
                { text: '周杰伦 热门歌曲', keywords: '周杰伦' },
                { text: '歌词包含"夏天"', keywords: 'lyric:夏天' },
                { text: '陈奕迅 最新专辑', keywords: '陈奕迅 -live' },
                { text: '纯音乐 工作学习', keywords: '纯音乐 轻音乐' },
                { text: '抖音热门歌曲', keywords: '抖音 热门' },
                { text: '90年代经典老歌', keywords: '90年代 经典' }
            ];
            
            const searchBtn = document.getElementById('searchBtn').parentElement;
            const examplesDiv = document.createElement('div');
            examplesDiv.style.cssText = `
                margin-top: 20px;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            `;
            
            examples.forEach(example => {
                const btn = document.createElement('button');
                btn.style.cssText = `
                    padding: 8px 16px;
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    border-radius: 20px;
                    color: rgba(255, 255, 255, 0.8);
                    cursor: pointer;
                    font-size: 12px;
                    transition: all 0.3s ease;
                `;
                btn.innerHTML = `<i class="fas fa-search"></i> ${example.text}`;
                btn.onmouseover = () => {
                    btn.style.background = 'rgba(255, 255, 255, 0.1)';
                    btn.style.borderColor = '#4ecdc4';
                };
                btn.onmouseout = () => {
                    btn.style.background = 'rgba(255, 255, 255, 0.05)';
                    btn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                };
                btn.onclick = () => {
                    document.getElementById('searchKeywords').value = example.keywords;
                    performSmartSearch();
                };
                
                examplesDiv.appendChild(btn);
            });
            
            searchBtn.parentElement.insertBefore(examplesDiv, searchBtn.nextSibling);
        }

        function searchByExamples() {
            const examples = [
                '周杰伦 晴天',
                'lyric:爱情',
                '陈奕迅 -演唱会',
                '纯音乐 放松',
                '英文歌 经典',
                '日语 动漫'
            ];
            
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            document.getElementById('searchKeywords').value = randomExample;
            performSmartSearch();
        }

        // ========== 辅助功能 ==========
        function setTimeRange(range) {
            timeRange = range;
            
            // 更新UI
            document.querySelectorAll('.filter-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function formatDuration(milliseconds) {
            if (!milliseconds) return '0:00';
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatNumber(num) {
            if (num >= 100000000) {
                return (num / 100000000).toFixed(1) + '亿';
            } else if (num >= 10000) {
                return (num / 10000).toFixed(1) + '万';
            }
            return num.toString();
        }

        function updatePagination() {
            if (totalPages <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }
            
            document.getElementById('pagination').style.display = 'flex';
            
            // 更新页码按钮
            const pageNumbers = document.getElementById('pageNumbers');
            let pageHtml = '';
            
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                pageHtml += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                        ${i}
                    </button>
                `;
            }
            
            pageNumbers.innerHTML = pageHtml;
            
            // 更新上一页/下一页按钮状态
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            document.getElementById('searchOffset').value = (page - 1) * itemsPerPage;
            document.getElementById('resultPage').textContent = page;
            
            // 重新搜索
            performSmartSearch();
        }

        function changePage(delta) {
            goToPage(currentPage + delta);
        }

        function clearSearch() {
            document.getElementById('searchKeywords').value = '';
            document.getElementById('searchOffset').value = '0';
            document.getElementById('resultsSection').style.display = 'none';
            searchResults = {};
            currentPage = 1;
        }

        // ========== 历史记录功能 ==========
        function saveSearchHistory(keywords, type) {
            const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            
            // 避免重复
            const existingIndex = history.findIndex(item => 
                item.keywords === keywords && item.type === type
            );
            
            if (existingIndex > -1) {
                history.splice(existingIndex, 1);
            }
            
            // 添加到开头
            history.unshift({
                keywords,
                type,
                timestamp: Date.now()
            });
            
            // 保持最多20条记录
            if (history.length > 20) {
                history.pop();
            }
            
            localStorage.setItem('searchHistory', JSON.stringify(history));
        }

        function loadSearchHistory() {
            // 可以在这里实现历史记录显示功能
            console.log('加载搜索历史');
        }

        // ========== 音乐播放相关 ==========
        async function playSong(songId, songName) {
            try {
                const url = buildApiUrl('/song/url/v1', { 
                    id: songId,
                    level: 'exhigh'
                });
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 200 && data.data) {
                    const song = Array.isArray(data.data) ? data.data[0] : data.data;
                    
                    if (song.url && song.url.startsWith('http')) {
                        // 创建音频播放器
                        const audio = new Audio(song.url);
                        audio.play();
                        
                        // 显示播放提示
                        showNotification(`正在播放: ${songName}`);
                    } else {
                        showNotification('无法播放此歌曲（可能需要VIP）', 'error');
                    }
                }
            } catch (error) {
                console.error('播放失败:', error);
                showNotification('播放失败', 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ff6b6b' : '#4ecdc4'};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            `;
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 添加其他功能占位符
        function showSongDetails(songId) {
            alert(`歌曲ID: ${songId}\n详细功能待实现`);
        }

        function addToPlaylist(songId) {
            showNotification('已添加到收藏', 'success');
        }

        function viewAlbum(albumId) {
            alert(`查看专辑: ${albumId}\n详细功能待实现`);
        }

        function playAlbum(albumId) {
            showNotification(`播放专辑: ${albumId}`, 'success');
        }

        function viewArtist(artistId) {
            alert(`查看歌手主页: ${artistId}\n详细功能待实现`);
        }

        function playArtistTop(artistId) {
            showNotification(`播放歌手热门歌曲: ${artistId}`, 'success');
        }

        function viewPlaylist(playlistId) {
            alert(`查看歌单: ${playlistId}\n详细功能待实现`);
        }

        function playPlaylist(playlistId) {
            showNotification(`播放歌单: ${playlistId}`, 'success');
        }

        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
