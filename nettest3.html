<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网易云音乐API综合测试</title>
    <meta name="referrer" content="no-referrer">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-music"></i> 网易云音乐API综合测试平台</h1>
            <p>一站式测试：登录认证 → 音乐搜索 → 智能推荐 → 高质量播放</p>
            <div class="api-status">
                <span class="status-dot"></span>
                <span>API状态：<strong id="apiStatusText">检测中...</strong></span>
            </div>
        </div>
        <div class="warning-box">
            <h3><i class="fas fa-exclamation-triangle"></i> 重要提示</h3>
            <ul>
                <li><strong>海外部署支持：</strong>所有请求已自动添加 randomCNIP=true 参数，解决Vercel海外IP限制问题</li>
                <li><strong>请使用私有API：</strong>请勿使用公开API服务，建议部署自己的Vercel服务（<a href="https://github.com/Binaryify/NeteaseCloudMusicApi" style="color:#856404;font-weight:bold;">部署指南</a>）</li>
                <li><strong>登录后使用：</strong>部分功能（如高质量音质）需要登录后使用，请先进行二维码登录</li>
                <li><strong>尊重版权：</strong>本项目仅供学习测试使用，请勿用于商业用途</li>
            </ul>
        </div>
        <div class="main-grid">
            <!-- 左侧：登录与状态管理 -->
            <div>
                <!-- 登录状态显示 -->
                <div class="card">
                    <h2><i class="fas fa-user-circle"></i> 账户状态</h2>
                    <div class="login-status-grid">
                        <div class="status-card" id="loginStatusCard">
                            <h3>登录状态</h3>
                            <div class="value">未知</div>
                        </div>
                        <div class="status-card" id="cookieStatusCard">
                            <h3>Cookie状态</h3>
                            <div class="value">未知</div>
                        </div>
                        <div class="status-card" id="apiStatusCard">
                            <h3>API状态</h3>
                            <div class="value">未知</div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button class="btn-info" onclick="checkLoginStatus()">
                            <i class="fas fa-sync-alt"></i> 刷新状态
                        </button>
                        <button class="btn-danger" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> 退出登录
                        </button>
                    </div>
                </div>
                <!-- 二维码登录 -->
                <div class="card">
                    <h2><i class="fas fa-qrcode"></i> 二维码登录</h2>
                    <p style="color: #666; margin-bottom: 20px; line-height: 1.6;">使用网易云音乐APP扫码登录，获取完整功能权限（高质量音质、私人推荐等）</p>
                    <div class="button-group">
                        <button class="btn-primary" onclick="startQRLogin()" id="qrLoginBtn">
                            <i class="fas fa-qrcode"></i> 开始二维码登录
                        </button>
                        <button class="btn-secondary" onclick="stopQRLogin()">
                            <i class="fas fa-stop"></i> 停止轮询
                        </button>
                    </div>
                    <div class="qrcode-container" id="qrcodeContainer" style="display: none;">
                        <div id="qrcodeImage"></div>
                        <div id="qrcodeStatus" class="status-box status-info">
                            <i class="fas fa-sync-alt fa-spin"></i>
                            <span>正在生成二维码...</span>
                        </div>
                        <div class="timestamp">
                            <small>时间戳: <span id="qrTimestamp"></span></small>
                        </div>
                    </div>
                    <div id="qrResult" class="result" style="display: none;">
                        <h3><i class="fas fa-check-circle"></i> 登录结果</h3>
                        <div id="qrData"></div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：搜索功能 -->
            <div>
                <div class="card">
                    <h2><i class="fas fa-search"></i> 搜索音乐</h2>
                    <div class="input-group">
                        <label for="searchKeyword"><i class="fas fa-keyboard"></i> 搜索关键词</label>
                        <input type="text" id="searchKeyword" placeholder="输入歌曲名、歌手名或专辑名...">
                    </div>
                    <div class="input-group">
                        <label for="searchLimit"><i class="fas fa-list-ol"></i> 返回数量 (1-100)</label>
                        <input type="number" id="searchLimit" value="30" min="1" max="100">
                    </div>
                    <div class="button-group">
                        <button class="btn-primary" onclick="searchMusic()">
                            <i class="fas fa-search"></i> 搜索全部内容
                        </button>
                        <button class="btn-secondary" onclick="clearSearch()">
                            <i class="fas fa-trash"></i> 清空结果
                        </button>
                    </div>
                    <div id="searchStatus" class="status-box" style="display: none;"></div>
                    <div id="searchResult" class="result" style="display: none;">
                        <h3><i class="fas fa-list"></i> 搜索结果</h3>
                        <div id="searchData" class="song-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API基础配置
        let API_BASE = '';
        let qrTimer = null;
        let currentAudio = null;
        
        // 初始化API检测
        window.addEventListener('DOMContentLoaded', function() {
            checkAPIStatus();
            checkLoginStatus();
        });
        
        // 检测API状态
        async function checkAPIStatus() {
            try {
                // 尝试从localStorage读取API地址
                const savedAPI = localStorage.getItem('netease_api_base');
                if (savedAPI) {
                    API_BASE = savedAPI;
                } else {
                    // 默认使用当前域名的API
                    API_BASE = window.location.origin;
                }
                
                const response = await fetch(`${API_BASE}/?timestamp=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    updateStatus('apiStatusText', '在线', 'success');
                    updateStatusCard('apiStatusCard', true, '在线');
                } else {
                    updateStatus('apiStatusText', '离线', 'error');
                    updateStatusCard('apiStatusCard', false, '离线');
                }
            } catch (error) {
                updateStatus('apiStatusText', '连接失败', 'error');
                updateStatusCard('apiStatusCard', false, '连接失败');
            }
        }
        
        // 检测登录状态
        async function checkLoginStatus() {
            try {
                const response = await fetch(`${API_BASE}/login/status?timestamp=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const isLoggedIn = data.data.code === 200;
                    const profile = data.data.profile || {};
                    
                    updateStatusCard('loginStatusCard', isLoggedIn, isLoggedIn ? '已登录' : '未登录');
                    
                    // 检查cookie
                    const cookies = document.cookie;
                    const hasCookie = cookies.includes('MUSIC_U') || cookies.includes('__csrf');
                    updateStatusCard('cookieStatusCard', hasCookie, hasCookie ? '有效' : '无效');
                    
                    if (isLoggedIn) {
                        console.log('用户信息:', profile);
                    }
                }
            } catch (error) {
                console.error('检查登录状态失败:', error);
                updateStatusCard('loginStatusCard', false, '检查失败');
                updateStatusCard('cookieStatusCard', false, '检查失败');
            }
        }
        
        // 开始二维码登录
        async function startQRLogin() {
            try {
                document.getElementById('qrLoginBtn').disabled = true;
                document.getElementById('qrcodeContainer').style.display = 'block';
                updateQRStatus('正在生成二维码...', 'info');
                
                const response = await fetch(`${API_BASE}/login/qr/key?timestamp=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('获取二维码key失败');
                
                const data = await response.json();
                const unikey = data.data.unikey;
                
                // 获取二维码
                const qrResponse = await fetch(`${API_BASE}/login/qr/create?key=${unikey}&qrimg=true&timestamp=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!qrResponse.ok) throw new Error('生成二维码失败');
                
                const qrData = await qrResponse.json();
                const qrimg = qrData.data.qrimg;
                
                // 显示二维码
                document.getElementById('qrcodeImage').innerHTML = `<img src="${qrimg}" alt="登录二维码">`;
                document.getElementById('qrTimestamp').textContent = new Date().toLocaleTimeString();
                updateQRStatus('请使用网易云音乐APP扫码', 'waiting');
                
                // 开始轮询检查登录状态
                qrTimer = setInterval(async () => {
                    try {
                        const checkResponse = await fetch(`${API_BASE}/login/qr/check?key=${unikey}&timestamp=${Date.now()}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (checkResponse.ok) {
                            const checkData = await checkResponse.json();
                            const code = checkData.code;
                            
                            if (code === 800) {
                                updateQRStatus('二维码已过期，请重新获取', 'error');
                                clearInterval(qrTimer);
                                document.getElementById('qrLoginBtn').disabled = false;
                            } else if (code === 801) {
                                updateQRStatus('等待扫码中...', 'waiting');
                            } else if (code === 802) {
                                updateQRStatus('已扫码，等待确认...', 'info');
                            } else if (code === 803) {
                                updateQRStatus('登录成功！', 'success');
                                clearInterval(qrTimer);
                                document.getElementById('qrLoginBtn').disabled = false;
                                
                                // 显示登录结果
                                document.getElementById('qrResult').style.display = 'block';
                                document.getElementById('qrData').innerHTML = `
                                    <pre>${JSON.stringify(checkData, null, 2)}</pre>
                                `;
                                
                                // 更新登录状态
                                setTimeout(checkLoginStatus, 1000);
                            }
                        }
                    } catch (error) {
                        console.error('轮询检查失败:', error);
                    }
                }, 2000);
                
            } catch (error) {
                console.error('二维码登录失败:', error);
                updateQRStatus('生成二维码失败: ' + error.message, 'error');
                document.getElementById('qrLoginBtn').disabled = false;
            }
        }
        
        // 停止二维码轮询
        function stopQRLogin() {
            if (qrTimer) {
                clearInterval(qrTimer);
                qrTimer = null;
                updateQRStatus('已停止轮询', 'info');
                document.getElementById('qrLoginBtn').disabled = false;
            }
        }
        
        // 搜索音乐
        async function searchMusic() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            const limit = document.getElementById('searchLimit').value;
            
            if (!keyword) {
                showSearchStatus('请输入搜索关键词', 'error');
                return;
            }
            
            try {
                showSearchStatus('搜索中...', 'info');
                document.getElementById('searchResult').style.display = 'block';
                
                // 搜索全部内容
                const response = await fetch(`${API_BASE}/search?keywords=${encodeURIComponent(keyword)}&limit=${limit}&timestamp=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('搜索失败');
                
                const data = await response.json();
                console.log('搜索结果:', data);
                
                if (data.code === 200 && data.result) {
                    const songs = data.result.songs || [];
                    showSearchStatus(`找到 ${songs.length} 个结果`, 'success');
                    displaySearchResults(songs);
                } else {
                    showSearchStatus('未找到相关结果', 'info');
                    document.getElementById('searchData').innerHTML = '<p>未找到相关结果</p>';
                }
                
            } catch (error) {
                console.error('搜索失败:', error);
                showSearchStatus('搜索失败: ' + error.message, 'error');
            }
        }
        
        // 显示搜索结果
        function displaySearchResults(songs) {
            const container = document.getElementById('searchData');
            container.innerHTML = '';
            
            if (songs.length === 0) {
                container.innerHTML = '<p>未找到相关结果</p>';
                return;
            }
            
            songs.forEach((song, index) => {
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                
                const artists = song.ar ? song.ar.map(artist => artist.name).join(' / ') : '未知歌手';
                const album = song.al ? song.al.name : '未知专辑';
                const duration = formatDuration(song.dt || 0);
                
                songItem.innerHTML = `
                    <div class="song-header">
                        <div class="song-title">${index + 1}. ${song.name}</div>
                        <span style="color: #e60026; font-weight: bold;">${song.fee === 1 ? 'VIP' : '免费'}</span>
                    </div>
                    <div class="song-meta">
                        <span><i class="fas fa-user"></i> ${artists}</span>
                        <span><i class="fas fa-compact-disc"></i> ${album}</span>
                        <span><i class="fas fa-clock"></i> ${duration}</span>
                    </div>
                    <div class="song-actions">
                        <button class="btn-primary" onclick="playSong(${song.id}, '${song.name}', '${artists}')">
                            <i class="fas fa-play"></i> 播放
                        </button>
                        <button class="btn-secondary" onclick="getSongDetail(${song.id})">
                            <i class="fas fa-info-circle"></i> 详情
                        </button>
                    </div>
                `;
                
                container.appendChild(songItem);
            });
        }
        
        // 播放歌曲
        async function playSong(id, name, artist) {
            try {
                // 获取歌曲URL
                const response = await fetch(`${API_BASE}/song/url?id=${id}&timestamp=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('获取歌曲URL失败');
                
                const data = await response.json();
                const urlData = data.data && data.data[0];
                
                if (urlData && urlData.url) {
                    // 停止当前播放
                    if (currentAudio) {
                        currentAudio.pause();
                    }
                    
                    // 创建新的音频播放器
                    currentAudio = new Audio(urlData.url);
                    currentAudio.play();
                    
                    // 显示播放信息
                    showPlayInfo(name, artist, urlData);
                    
                } else {
                    alert('无法获取歌曲播放地址');
                }
                
            } catch (error) {
                console.error('播放失败:', error);
                alert('播放失败: ' + error.message);
            }
        }
        
        // 显示播放信息
        function showPlayInfo(name, artist, urlData) {
            const infoDiv = document.createElement('div');
            infoDiv.innerHTML = `
                <div class="audio-player-container">
                    <h3><i class="fas fa-headphones"></i> 正在播放</h3>
                    <div id="nowPlaying">${name} - ${artist}</div>
                    <div id="audioInfo">
                        <span>音质: ${urlData.br ? Math.round(urlData.br / 1000) + 'kbps' : '未知'}</span>
                        <span>格式: ${urlData.type || '未知'}</span>
                        <span>大小: ${urlData.size ? formatFileSize(urlData.size) : '未知'}</span>
                    </div>
                </div>
            `;
            
            // 移除旧的播放器
            const oldPlayer = document.querySelector('.audio-player-container');
            if (oldPlayer) {
                oldPlayer.remove();
            }
            
            // 添加到页面
            document.querySelector('.container').appendChild(infoDiv);
        }
        
        // 获取歌曲详情
        async function getSongDetail(id) {
            try {
                const response = await fetch(`${API_BASE}/song/detail?ids=${id}&timestamp=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('获取歌曲详情失败');
                
                const data = await response.json();
                alert(JSON.stringify(data, null, 2));
                
            } catch (error) {
                console.error('获取详情失败:', error);
                alert('获取详情失败: ' + error.message);
            }
        }
        
        // 清空搜索结果
        function clearSearch() {
            document.getElementById('searchKeyword').value = '';
            document.getElementById('searchData').innerHTML = '';
            document.getElementById('searchResult').style.display = 'none';
            document.getElementById('searchStatus').style.display = 'none';
        }
        
        // 退出登录
        async function logout() {
            try {
                const response = await fetch(`${API_BASE}/logout?timestamp=${Date.now()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    alert('退出登录成功');
                    checkLoginStatus();
                } else {
                    alert('退出登录失败');
                }
            } catch (error) {
                console.error('退出登录失败:', error);
                alert('退出登录失败: ' + error.message);
            }
        }
        
        // 工具函数
        function updateStatus(elementId, text, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
                element.className = '';
                if (type === 'success') element.style.color = '#28a745';
                else if (type === 'error') element.style.color = '#dc3545';
                else if (type === 'info') element.style.color = '#17a2b8';
            }
        }
        
        function updateStatusCard(cardId, status, text) {
            const card = document.getElementById(cardId);
            if (card) {
                const valueDiv = card.querySelector('.value');
                if (valueDiv) {
                    valueDiv.textContent = text;
                    card.className = `status-card ${status}`;
                }
            }
        }
        
        function updateQRStatus(text, type) {
            const statusDiv = document.getElementById('qrcodeStatus');
            if (statusDiv) {
                statusDiv.innerHTML = `<i class="fas fa-sync-alt ${type === 'waiting' || type === 'info' ? 'fa-spin' : ''}"></i><span>${text}</span>`;
                statusDiv.className = `status-box status-${type}`;
            }
        }
        
        function showSearchStatus(text, type) {
            const statusDiv = document.getElementById('searchStatus');
            if (statusDiv) {
                statusDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i><span>${text}</span>`;
                statusDiv.className = `status-box status-${type}`;
                statusDiv.style.display = 'flex';
            }
        }
        
        function formatDuration(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
    </script>
</body>
</html>
