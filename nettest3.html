<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网易云音乐API综合测试</title>
    <meta name="referrer" content="no-referrer">
</head>
<body>
    <div>
        <h1>网易云音乐API综合测试平台</h1>
        <p>一站式测试：登录认证 → 智能搜索 → 推荐 → 播放</p>
        <div>API状态：<strong id="apiStatusText">检测中...</strong></div>
    </div>
    
    <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin: 15px 0;">
        <h3>重要提示</h3>
        <ul>
            <li><strong>智能聚合搜索：</strong>根据关键词自动选择最优结果显示（搜索"百闻牌"优先显示歌单和专辑）</li>
            <li><strong>海外部署支持：</strong>自动添加randomCNIP=true参数解决海外IP限制</li>
            <li><strong>请使用私有API：</strong>建议部署自己的Vercel服务（<a href="https://github.com/Binaryify/NeteaseCloudMusicApi" target="_blank">部署指南</a>）</li>
        </ul>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div>
            <!-- 账户状态 -->
            <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px;">
                <h2>账户状态</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 15px 0;">
                    <div id="loginStatusCard" style="border: 1px solid #ddd; padding: 15px; text-align: center;">
                        <h3>登录状态</h3>
                        <div class="value">未知</div>
                    </div>
                    <div id="cookieStatusCard" style="border: 1px solid #ddd; padding: 15px; text-align: center;">
                        <h3>Cookie状态</h3>
                        <div class="value">未知</div>
                    </div>
                    <div id="apiStatusCard" style="border: 1px solid #ddd; padding: 15px; text-align: center;">
                        <h3>API状态</h3>
                        <div class="value">未知</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="checkLoginStatus()" style="background: #17a2b8; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">刷新状态</button>
                    <button onclick="logout()" style="background: #dc3545; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">退出登录</button>
                </div>
            </div>
            
            <!-- 二维码登录 -->
            <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px;">
                <h2>二维码登录</h2>
                <p>使用网易云音乐APP扫码登录，获取完整功能权限</p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="startQRLogin()" id="qrLoginBtn" style="background: #e60026; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">开始二维码登录</button>
                    <button onclick="stopQRLogin()" style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">停止轮询</button>
                </div>
                
                <div id="qrcodeContainer" style="display: none; text-align: center; margin: 15px 0;">
                    <div id="qrcodeImage" style="width: 200px; height: 200px; margin: 0 auto; border: 1px solid #ddd;"></div>
                    <div id="qrcodeStatus" style="padding: 10px; margin: 10px 0; border-left: 4px solid #17a2b8; background: #d1ecf1; color: #0c5460;">正在生成二维码...</div>
                    <div>时间戳: <span id="qrTimestamp"></span></div>
                </div>
                
                <div id="qrResult" style="border: 1px solid #eee; padding: 15px; margin-top: 15px; display: none;">
                    <h3>登录结果</h3>
                    <div id="qrData"></div>
                </div>
            </div>
            
            <!-- 快速体验 -->
            <div style="border: 1px solid #ddd; padding: 15px;">
                <h2>快速体验</h2>
                <p>快速获取游客身份，体验基础功能（无需扫码）</p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="guestLogin()" style="background: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">游客登录</button>
                    <button onclick="clearGuestCookie()" style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">清除游客数据</button>
                </div>
                
                <div id="guestResult" style="border: 1px solid #eee; padding: 15px; display: none;">
                    <h3>游客登录结果</h3>
                    <div id="guestData"></div>
                </div>
            </div>
        </div>
        
        <div>
            <!-- 智能搜索音乐 -->
            <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px;">
                <h2>智能搜索音乐</h2>
                <div style="margin-bottom: 15px;">
                    <label>搜索关键词</label><br>
                    <input type="text" id="keywords" placeholder="请输入歌曲名、歌手或专辑名，例如：百闻牌 原声带" value="百闻牌" style="width: 100%; padding: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>搜索模式</label><br>
                    <select id="searchMode" style="width: 100%; padding: 8px;">
                        <option value="smart" selected>智能聚合搜索（推荐）</option>
                        <option value="song">仅搜单曲</option>
                        <option value="album">仅搜专辑</option>
                        <option value="playlist">仅搜歌单</option>
                    </select>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label>返回数量</label><br>
                        <input type="number" id="searchLimit" value="20" min="1" max="100" style="width: 100%; padding: 8px;">
                    </div>
                    <div>
                        <label>偏移量</label><br>
                        <input type="number" id="searchOffset" value="0" min="0" style="width: 100%; padding: 8px;">
                    </div>
                </div>
                
                <button onclick="searchMusic()" id="searchBtn" style="width: 100%; padding: 12px; background: #e60026; color: white; border: none; border-radius: 4px; cursor: pointer;">开始智能搜索</button>
                
                <div id="searchResult" style="border: 1px solid #eee; padding: 15px; margin-top: 15px; max-height: 300px; overflow-y: auto; display: none;">
                    <h3>搜索结果</h3>
                    <div id="searchData"></div>
                </div>
            </div>
            
            <!-- 推荐音乐 -->
            <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px;">
                <h2>推荐音乐</h2>
                <p>根据你的音乐偏好获取个性化推荐（需要登录）</p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="getPersonalized()" style="background: #17a2b8; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">个性化推荐</button>
                    <button onclick="getNewSongs()" style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">最新音乐</button>
                    <button onclick="getTopList()" style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">排行榜</button>
                </div>
                
                <div id="recommendResult" style="border: 1px solid #eee; padding: 15px; display: none;">
                    <h3>推荐结果</h3>
                    <div id="recommendData"></div>
                </div>
            </div>
            
            <!-- 音乐播放 -->
            <div style="border: 1px solid #ddd; padding: 15px;">
                <h2>音乐播放</h2>
                <div style="margin-bottom: 15px;">
                    <label>歌曲ID</label><br>
                    <input type="text" id="playSongId" placeholder="直接输入歌曲ID或从搜索结果点击使用" style="width: 100%; padding: 8px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label>播放音质</label><br>
                    <select id="qualityLevel" style="width: 100%; padding: 8px;">
                        <option value="standard">标准 (standard)</option>
                        <option value="higher">较高 (higher)</option>
                        <option value="exhigh" selected>极高 (exhigh)</option>
                        <option value="lossless">无损 (lossless)</option>
                        <option value="hires">Hi-Res (hires)</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button onclick="playSelectedSong()" id="playBtn" style="background: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">播放音乐</button>
                    <button onclick="stopAudio()" style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">停止播放</button>
                    <button onclick="checkMusicAvailable()" style="background: #17a2b8; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">检查可用性</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 播放器 -->
    <div id="audioPlayerContainer" style="background: #f8f9fa; padding: 15px; margin-top: 15px; display: none;">
        <h3>正在播放</h3>
        <div id="nowPlaying"></div>
        
        <div style="height: 4px; background: #ddd; margin: 10px 0;">
            <div id="progressBar" style="height: 100%; background: #e60026; width: 0%;"></div>
        </div>
        
        <audio id="audioPlayer" controls style="width: 100%;"></audio>
        
        <div id="audioInfo"></div>
    </div>
    
    <!-- API配置 -->
    <div style="border: 1px solid #ddd; padding: 15px; margin-top: 15px;">
        <h2>API配置</h2>
        <div style="margin-bottom: 15px;">
            <label>API基础地址</label><br>
            <input type="text" id="apiBaseUrl" value="https://neteaseapi-enhanced.vercel.app" style="width: 100%; padding: 8px;">
        </div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button onclick="updateApiBase()" style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">更新API地址</button>
            <button onclick="testApiConnection()" style="background: #17a2b8; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;">测试连接</button>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa;">
            <h4>配置说明</h4>
            <p>
                1. <strong>智能搜索：</strong>根据关键词自动选择最优结果显示<br>
                2. <strong>搜索"百闻牌"：</strong>优先显示歌单和专辑，其次才是单曲<br>
                3. <strong>当前地址：</strong> <code id="currentApiBase">https://neteaseapi-enhanced.vercel.app</code>
            </p>
        </div>
    </div>

    <script>
        // 全局变量
        let API_BASE = 'https://neteaseapi-enhanced.vercel.app';
        let currentAudio = null;
        let searchResults = [];
        let recommendResults = [];
        let qrCheckInterval = null;
        let currentQRKey = null;
        let currentCookie = null;
        let audioUpdateInterval = null;

        // 页面加载初始化
        window.addEventListener('load', function() {
            console.log('网易云音乐API综合测试平台已加载');
            
            // 从本地存储加载API地址
            const savedApiBase = localStorage.getItem('netease_api_base');
            if (savedApiBase) {
                API_BASE = savedApiBase;
                document.getElementById('apiBaseUrl').value = API_BASE;
                document.getElementById('currentApiBase').textContent = API_BASE;
            }
            
            // 从本地存储加载Cookie
            const savedCookie = localStorage.getItem('netease_cookie');
            if (savedCookie) {
                currentCookie = savedCookie;
                updateCookieDisplay();
                updateLoginStatus();
            }
            
            // 检查API状态
            checkAPIStatus();
            
            // 设置音频播放进度更新
            setupAudioProgress();
        });

        // ========== 工具函数 ==========
        
        // 生成时间戳
        function getTimestamp() {
            return Date.now();
        }
        
        // 构建API URL（自动添加时间戳和randomCNIP参数）
        function buildApiUrl(endpoint, params = {}) {
            // 确保所有请求都带上时间戳和中国IP参数（解决海外部署问题）
            const baseParams = `timestamp=${getTimestamp()}&randomCNIP=true`;
            const queryParams = new URLSearchParams();
            
            // 添加其他参数
            Object.keys(params).forEach(key => {
                if (params[key] !== null && params[key] !== undefined) {
                    queryParams.append(key, params[key]);
                }
            });
            
            const queryString = queryParams.toString();
            return `${API_BASE}${endpoint}?${baseParams}${queryString ? '&' + queryString : ''}`;
        }
        
        // 显示状态消息
        function showStatus(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            let className = '';
            
            switch(type) {
                case 'success': className = 'status-success'; break;
                case 'error': className = 'status-error'; break;
                case 'info': className = 'status-info'; break;
                case 'waiting': className = 'status-waiting'; break;
            }
            
            container.innerHTML = `<span>${message}</span>`;
            container.style.padding = '10px';
            container.style.margin = '10px 0';
            container.style.borderLeft = '4px solid';
            container.style.display = 'block';
            
            if (type === 'success') {
                container.style.background = '#d4edda';
                container.style.borderColor = '#28a745';
                container.style.color = '#155724';
            } else if (type === 'error') {
                container.style.background = '#f8d7da';
                container.style.borderColor = '#dc3545';
                container.style.color = '#721c24';
            } else if (type === 'info') {
                container.style.background = '#d1ecf1';
                container.style.borderColor = '#17a2b8';
                container.style.color = '#0c5460';
            } else if (type === 'waiting') {
                container.style.background = '#fff3cd';
                container.style.borderColor = '#ffc107';
                container.style.color = '#856404';
            }
        }
        
        // 显示结果
        function showResult(containerId, content) {
            const container = document.getElementById(containerId);
            if (typeof content === 'string') {
                container.innerHTML = content;
            } else {
                container.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word;">${JSON.stringify(content, null, 2)}</pre>`;
            }
            container.parentElement.style.display = 'block';
        }
        
        // 更新状态卡片
        function updateStatusCard(cardId, value, status) {
            const card = document.getElementById(cardId);
            const valueDiv = card.querySelector('.value');
            valueDiv.textContent = value;
            
            if (status === 'true') {
                card.style.borderColor = '#28a745';
                valueDiv.style.color = '#28a745';
            } else if (status === 'false') {
                card.style.borderColor = '#dc3545';
                valueDiv.style.color = '#dc3545';
            } else {
                card.style.borderColor = '#ddd';
                valueDiv.style.color = '#333';
            }
        }
        
        // 更新Cookie显示
        function updateCookieDisplay() {
            if (currentCookie) {
                updateStatusCard('cookieStatusCard', '已设置', 'true');
                updateStatusCard('loginStatusCard', '已登录', 'true');
            } else {
                updateStatusCard('cookieStatusCard', '未设置', 'false');
                updateStatusCard('loginStatusCard', '未登录', 'false');
            }
        }

        // ========== 登录相关函数 ==========
        
        // 检查登录状态
        async function checkLoginStatus() {
            if (!currentCookie) {
                updateStatusCard('loginStatusCard', '未登录', 'false');
                showStatus('searchData', '未检测到登录信息，请先登录', 'info');
                return;
            }
            
            try {
                const url = buildApiUrl('/login/status');
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cookie: currentCookie })
                });
                
                const data = await response.json();
                
                if (data.code === 200 && data.data.profile) {
                    updateStatusCard('loginStatusCard', `已登录: ${data.data.profile.nickname}`, 'true');
                    showStatus('searchData', `登录状态: 已登录为 ${data.data.profile.nickname}`, 'success');
                } else {
                    updateStatusCard('loginStatusCard', '登录失效', 'false');
                    showStatus('searchData', '登录状态: Cookie已失效', 'error');
                }
            } catch (error) {
                console.error('检查登录状态出错:', error);
                updateStatusCard('loginStatusCard', '检查失败', 'false');
                showStatus('searchData', `检查登录状态失败: ${error.message}`, 'error');
            }
        }
        
        // 开始二维码登录
        async function startQRLogin() {
            const qrLoginBtn = document.getElementById('qrLoginBtn');
            qrLoginBtn.disabled = true;
            qrLoginBtn.textContent = '生成中...';
            
            try {
                // 获取二维码key
                const keyUrl = buildApiUrl('/login/qr/key');
                const keyResponse = await fetch(keyUrl);
                const keyData = await keyResponse.json();
                
                if (keyData.code === 200) {
                    currentQRKey = keyData.data.unikey;
                    
                    // 生成二维码
                    const qrUrl = buildApiUrl('/login/qr/create', { key: currentQRKey, qrimg: true });
                    const qrResponse = await fetch(qrUrl);
                    const qrData = await qrResponse.json();
                    
                    if (qrData.code === 200) {
                        document.getElementById('qrcodeContainer').style.display = 'block';
                        document.getElementById('qrcodeImage').innerHTML = `<img src="${qrData.data.qrimg}" alt="二维码">`;
                        document.getElementById('qrTimestamp').textContent = getTimestamp();
                        showStatus('qrcodeStatus', '请使用网易云音乐APP扫码登录', 'info');
                        
                        // 开始轮询检查登录状态
                        startQRCheck();
                    } else {
                        showStatus('qrcodeStatus', `生成二维码失败: ${qrData.msg}`, 'error');
                    }
                } else {
                    showStatus('qrcodeStatus', `获取二维码key失败: ${keyData.msg}`, 'error');
                }
            } catch (error) {
                console.error('二维码登录出错:', error);
                showStatus('qrcodeStatus', `二维码登录失败: ${error.message}`, 'error');
            } finally {
                qrLoginBtn.disabled = false;
                qrLoginBtn.textContent = '开始二维码登录';
            }
        }
        
        // 开始轮询检查二维码状态
        function startQRCheck() {
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
            }
            
            qrCheckInterval = setInterval(async () => {
                try {
                    const checkUrl = buildApiUrl('/login/qr/check', { key: currentQRKey });
                    const response = await fetch(checkUrl);
                    const data = await response.json();
                    
                    if (data.code === 803) {
                        // 登录成功
                        clearInterval(qrCheckInterval);
                        qrCheckInterval = null;
                        
                        // 保存cookie
                        if (data.cookie) {
                            currentCookie = data.cookie;
                            localStorage.setItem('netease_cookie', currentCookie);
                            updateCookieDisplay();
                            updateLoginStatus();
                        }
                        
                        document.getElementById('qrResult').style.display = 'block';
                        document.getElementById('qrData').innerHTML = `<pre style="white-space: pre-wrap;">登录成功！\n用户ID: ${data.account?.id || '未知'}\n用户名: ${data.nickname || '未知'}\n\n完整数据:\n${JSON.stringify(data, null, 2)}</pre>`;
                        showStatus('qrcodeStatus', '登录成功！', 'success');
                    } else if (data.code === 800) {
                        // 二维码过期
                        clearInterval(qrCheckInterval);
                        qrCheckInterval = null;
                        showStatus('qrcodeStatus', '二维码已过期，请重新生成', 'error');
                    } else if (data.code === 801) {
                        // 等待扫码
                        showStatus('qrcodeStatus', '等待扫码...', 'waiting');
                    } else if (data.code === 802) {
                        // 已扫码，等待确认
                        showStatus('qrcodeStatus', '已扫码，请确认登录', 'info');
                    }
                } catch (error) {
                    console.error('检查二维码状态出错:', error);
                }
            }, 2000);
        }
        
        // 停止二维码轮询
        function stopQRLogin() {
            if (qrCheckInterval) {
                clearInterval(qrCheckInterval);
                qrCheckInterval = null;
                showStatus('qrcodeStatus', '二维码轮询已停止', 'info');
            }
        }
        
        // 游客登录
        async function guestLogin() {
            try {
                const url = buildApiUrl('/register/anonimous');
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 200 && data.cookie) {
                    currentCookie = data.cookie;
                    localStorage.setItem('netease_cookie', currentCookie);
                    updateCookieDisplay();
                    
                    document.getElementById('guestResult').style.display = 'block';
                    document.getElementById('guestData').innerHTML = `<pre style="white-space: pre-wrap;">游客登录成功！\nCookie已保存\n\n完整数据:\n${JSON.stringify(data, null, 2)}</pre>`;
                    showStatus('searchData', '游客登录成功，已获取基础权限', 'success');
                } else {
                    showStatus('searchData', `游客登录失败: ${data.msg || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('游客登录出错:', error);
                showStatus('searchData', `游客登录失败: ${error.message}`, 'error');
            }
        }
        
        // 清除游客Cookie
        function clearGuestCookie() {
            currentCookie = null;
            localStorage.removeItem('netease_cookie');
            updateCookieDisplay();
            showStatus('searchData', '游客数据已清除', 'success');
        }
        
        // 退出登录
        function logout() {
            currentCookie = null;
            localStorage.removeItem('netease_cookie');
            updateCookieDisplay();
            showStatus('searchData', '已退出登录', 'success');
        }
        
        // 更新登录状态
        function updateLoginStatus() {
            if (currentCookie) {
                updateStatusCard('loginStatusCard', '已登录', 'true');
            } else {
                updateStatusCard('loginStatusCard', '未登录', 'false');
            }
        }

        // ========== 智能搜索核心函数 ==========
        
        async function searchMusic() {
            const keywords = document.getElementById('keywords').value.trim();
            const searchLimit = document.getElementById('searchLimit').value;
            const searchOffset = document.getElementById('searchOffset').value;
            const searchMode = document.getElementById('searchMode').value;

            if (!keywords) {
                showStatus('searchData', '请输入搜索关键词', 'error');
                document.getElementById('searchResult').style.display = 'block';
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            const originalText = searchBtn.textContent;
            searchBtn.textContent = '搜索中...';
            searchBtn.disabled = true;

            try {
                // 根据搜索模式选择不同的搜索策略
                if (searchMode === 'smart') {
                    await smartSearch(keywords, searchLimit, searchOffset);
                } else {
                    // 单一类型搜索
                    const typeMap = {
                        'song': 1,
                        'album': 10,
                        'playlist': 1000
                    };
                    const type = typeMap[searchMode] || 1;
                    
                    const url = buildApiUrl('/search', {
                        keywords: keywords,
                        type: type,
                        limit: searchLimit,
                        offset: searchOffset
                    });

                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.code === 200 && data.result) {
                        displaySingleTypeResults(data, type);
                    } else {
                        showResult('searchData', data);
                        showStatus('searchData', `搜索失败: ${data.msg || '未知错误'}`, 'error');
                    }
                }
            } catch (error) {
                console.error('搜索出错:', error);
                showStatus('searchData', `网络请求失败: ${error.message}`, 'error');
                document.getElementById('searchResult').style.display = 'block';
            } finally {
                searchBtn.textContent = originalText;
                searchBtn.disabled = false;
            }
        }

        // 智能聚合搜索
        async function smartSearch(keywords, limit, offset) {
            // 根据关键词类型智能选择搜索策略
            const isGameRelated = keywords.includes('牌') || keywords.includes('游戏') || 
                               keywords.includes('原声') || keywords.includes('OST') ||
                               keywords.includes('阴阳师') || keywords.includes('百闻牌');
            const isPlaylistRelated = keywords.includes('精选') || keywords.includes('合集') || 
                                    keywords.includes('歌单') || keywords.includes('推荐');
            const isArtistRelated = keywords.includes('的歌曲') || keywords.includes('作品') || 
                                  keywords.includes('演唱');
            
            let searchTypes;
            
            if (isGameRelated) {
                // 游戏相关：优先歌单，其次专辑，最后单曲
                searchTypes = [
                    { type: 1000, name: '歌单', weight: 3 },
                    { type: 10, name: '专辑', weight: 2 },
                    { type: 1, name: '单曲', weight: 1 }
                ];
            } else if (isPlaylistRelated) {
                // 歌单相关：优先歌单
                searchTypes = [
                    { type: 1000, name: '歌单', weight: 3 },
                    { type: 1, name: '单曲', weight: 1 }
                ];
            } else if (isArtistRelated) {
                // 艺人相关：优先单曲和专辑
                searchTypes = [
                    { type: 1, name: '单曲', weight: 2 },
                    { type: 10, name: '专辑', weight: 3 },
                    { type: 1000, name: '歌单', weight: 1 }
                ];
            } else {
                // 默认：平衡策略
                searchTypes = [
                    { type: 1, name: '单曲', weight: 2 },
                    { type: 1000, name: '歌单', weight: 2 },
                    { type: 10, name: '专辑', weight: 1 }
                ];
            }

            // 并行搜索
            const promises = searchTypes.map(async (item) => {
                const url = buildApiUrl('/search', {
                    keywords: keywords,
                    type: item.type,
                    limit: Math.max(5, Math.floor(limit / searchTypes.length)),
                    offset: offset
                });
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    return { ...data, searchType: item };
                } catch (error) {
                    console.error(`搜索类型 ${item.name} 失败:`, error);
                    return { code: 500, searchType: item, result: null };
                }
            });

            const results = await Promise.all(promises);
            displaySmartResults(results, keywords);
        }

        // 显示智能搜索结果
        function displaySmartResults(results, keywords) {
            const container = document.getElementById('searchData');
            let allResults = [];
            
            // 收集所有结果并计算相关性分数
            results.forEach(result => {
                if (result.code === 200 && result.result) {
                    const searchType = result.searchType;
                    
                    if (searchType.type === 1) { // 单曲
                        const songs = result.result.songs || [];
                        songs.forEach(song => {
                            song._displayType = '单曲';
                            song._relevanceScore = calculateRelevance(song.name + (song.artists ? song.artists[0].name : ''), keywords, searchType.weight);
                            song._rawData = song;
                            allResults.push(song);
                        });
                    } else if (searchType.type === 10) { // 专辑
                        const albums = result.result.albums || [];
                        albums.forEach(album => {
                            album._displayType = '专辑';
                            album._relevanceScore = calculateRelevance(album.name + (album.artist ? album.artist.name : ''), keywords, searchType.weight);
                            album._rawData = album;
                            allResults.push(album);
                        });
                    } else if (searchType.type === 1000) { // 歌单
                        const playlists = result.result.playlists || [];
                        playlists.forEach(playlist => {
                            playlist._displayType = '歌单';
                            playlist._relevanceScore = calculateRelevance(playlist.name + playlist.description, keywords, searchType.weight * 1.5);
                            playlist._rawData = playlist;
                            allResults.push(playlist);
                        });
                    }
                }
            });
            
            // 按相关性分数排序
            allResults.sort((a, b) => b._relevanceScore - a._relevanceScore);
            
            // 只取前limit个结果
            const limit = parseInt(document.getElementById('searchLimit').value);
            const finalResults = allResults.slice(0, limit);
            
            // 显示结果
            if (finalResults.length > 0) {
                let html = `<div style="margin-bottom: 10px;">找到 ${finalResults.length} 个相关结果</div>`;
                html += '<div>';
                
                finalResults.forEach((item, index) => {
                    html += formatSearchItem(item, index);
                });
                
                html += '</div>';
                container.innerHTML = html;
                showStatus('searchData', `智能搜索完成，已按相关性排序`, 'success');
            } else {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">未找到相关
